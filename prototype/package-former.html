<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-11-13 Wed 17:15 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Making Modules with Meta-Programmed Meta-Primitives</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Musa Al-hassy">
<meta name="description" content="Generalising ADTS, records, typeclasses to “package formers”."
>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="./org-notes-style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Making Modules with Meta-Programmed Meta-Primitives</h1>
<p class="subtitle"> <h2> <center> Liberating Package Formation from the Backend </center> </h2> </p>
</header>

<style>

/* wrap lengthy lines for code blocks */
pre{white-space:pre-wrap}

/* inline code; see here for other colours: https://www.w3schools.com/colors/colors_names.asp */
code { background: Cyan;
       border-radius: 5px; /* How curvy the borders should be. */
}

table {
    background: pink;
    border-radius: 10px; /* How curvy the borders should be. */
    /* width:90% */

    border-bottom: hidden;
    border-top: hidden;

    /* Put table in the center of the page, horizontally. */
    margin-left:auto;margin-right:auto;

    font-family:"Courier New";
    font-size:90%;
}

/* table ‘d’ata elements

  no padding
*/
td {
    border: 0px solid red; padding: 1em;
    /* border: none;
    border-left: 1px solid transparent;
    border-right: 1px solid transparent; */
}

/* Alter visible labels of source blocks */
pre.src-agda:before { content: 'Agda'; }
pre.src-haskell:before { content: 'Agda'; }
pre.src-org:before { content: 'Text'; }

/* Using source blocks “agda-results” as pink-background coloured blocks in HTML. */
/* pre.src-results-agda:before { content: 'Results: Agda'; } */
pre.src-results-agda { background: pink;}
/* Execute this for alias: (add-to-list 'org-src-lang-modes '("results-agda" . org-agda)) */

</style>


<div class="org-center">
<p>
<b>Abstract</b>
</p>
</div>
<blockquote>
<p>
This article is about implementing a prototype supporting <a href="https://alhassy.github.io/next-700-module-systems/">“the next 700 module systems” proposal</a>
as an editor extension. In particular, we show how intimately related presentations of a type
can be <i>derived automatically</i> from a single generic declaration which we call a <code>PackageFormer</code>.
</p>

<p>
Think of a language that does not support currying and you need to have a function of
10 arguments that needs to support accepting any number of arguments less than 10, say
for partial application. In such languages, one must utilise the builder design pattern,
or quickly copy-paste the function 10 times, altering it slightly each time.
In general, if such a function definition requires <i>N</i> lines and <i>M</i> forms of the function
are needed, then nearly <i>N × M</i> lines of code are written manually.
</p>

<p>
Our prototype deals with this problem, among others, for functions on <i>types</i>
&#x2014;i.e., type constructors&#x2014; and reduces this quadratic count to a linear
count <i>N + M</i>: One declaration of <i>N</i> lines, then <i>M</i> lines, each being an instantiation
of the desired form. These ideas are discussed in the pre-print
<a href="../papers/gpce19_a_language_feature_to_unbundle_data_at_will.pdf">A Language Feature to Unbundle Data at Will</a>.
</p>

<p>
<b>Design patterns for theories become library methods!</b>
An interesting side-effect of having meta-primitives for packages
is that traditional patterns for theories
&#x2014;e.g., homomorphisms, syntax, interpretation functions&#x2014;
can now be codified as general re-usable methods.
</p>

<p>
The ideas are targeted to the dependently-typed language Agda.
However, with little alterations they could easily be made to target
other languages, such as Haskell and Coq. The ideas transcend the presentation
language, Agda. Ideally, variational definitions would also be in the host
language rather than in Lisp but that would require alteration to the host
language itself, and Lisp with Emacs hooks is much easier to do; for now.
<i>This is an Emacs centric language extension.</i>
</p>

<p>
The <a href="#Aim---Scrap-the-Repetition-">first section</a> below quickly elaborates on our goal,
after that is a ‘<a href="#User-Manual">user manual</a>’ then the remainder of
the article serves as literate documentation of the prototype;
as well as an opportunity for me to explore emojis.
To follow along, it may be useful to look at an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>.
</p>

<p>
The user manual, among other things, shows how we can avoid the
<code>open ⋯ public ⋯ renaming ⋯</code> pattern which <a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Structures.html#2757">plagues</a> Agda's standard library
&#x2014;and is much more pronounced in the <a href="http://relmics.mcmaster.ca/RATH-Agda/RATH-Agda-2.2.pdf">RATH-Agda</a>, which devotes p27-39 for simple setoid renaming
and does much more elsewhere&#x2014;,
as well as showing how to avoid <a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Morphism.html#1">laborious</a>, yet tedious, definitions of homomorphisms
in Agda's library. Moreover, the motivating factor of this work is to avoid
the pattern of <a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Structures.html#1">defining a predicate</a> <code>IsX c₀ ⋯ cₙ</code> on constituents <code>cᵢ</code>
<a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.html#1">then packaging</a> the constituents along with a proof of this predicate as a record <code>X</code>.
</p>
</blockquote>

<div class="org-center">
<p>
<i>Everything here works with Agda version 2.6.0.</i>
</p>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Results of tests and <a href="package-former.agda">examples</a> will be in pink, like this.</td>
</tr>
</tbody>
</table>

<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#Aim---Scrap-the-Repetition-">1. Aim: <i>Scrap the Repetition</i></a></li>
<li><a href="#User-Manual">2. User Manual I: Simple Use of the System</a>
<ul>
<li><a href="#Installation">2.1. Installation</a></li>
<li><a href="#Syntax">2.2. Syntax</a></li>
<li><a href="#Extension">2.3. Extension</a></li>
<li><a href="#Defining-a-Concept-Only-Once">2.4. Defining a Concept Only Once</a></li>
<li><a href="#Renaming">2.5. Renaming</a></li>
<li><a href="#Union">2.6. Union (and intersection)</a></li>
<li><a href="#Duality">2.7. Duality</a></li>
<li><a href="#Extracting-Little-Theories">2.8. Extracting Little Theories</a></li>
<li><a href="#Summary-of-Sample-Variationals-Provided-With-The-System">2.9. Summary of Sample Variationals Provided With The System</a></li>
</ul>
</li>
<li><a href="#User-Manual-II--Extending-the-System">3. User Manual II: Extending the System</a>
<ul>
<li><a href="#Lisp-Interface">3.1. Lisp Interface</a></li>
<li><a href="#User-Manual-Header">3.2. User Manual Header</a></li>
<li><a href="#Empty-Variationals">3.3. Empty Variationals</a></li>
<li><a href="#--Errors">3.4. ⇨ Errors</a></li>
<li><a href="#Records-and-Meta-Primitives---kind------alter-elements-">3.5. Records and Meta-Primitives <code>:kind</code> &amp; <code>:alter-elements</code></a></li>
<li><a href="#Equation-Accommodating-Record-Variational">3.6. Equation Accommodating Record Variational</a></li>
<li><a href="#A-Coherent-Equation-Accommodating-Record-Variational">3.7. A Coherent Equation Accommodating Record Variational</a></li>
<li><a href="#Typeclasses----Parameterised-Records----and-Meta-Primitives---waist------level-">3.8. Typeclasses &#x2014;Parameterised Records&#x2014; and Meta-Primitives <code>:waist</code> &amp; <code>:level</code></a></li>
<li><a href="#Primed-Decoration-and--rename-mixfix-">3.9. Primed Decoration and <code>rename-mixfix</code></a></li>
<li><a href="#First-class-PackageFormers">3.10. First-class PackageFormers</a></li>
<li><a href="#Variationals-with-Arguments-----map--rename---co-decorated--subscriptedᵢ--renaming-">3.11. Variationals with Arguments ---<code>map, rename, [co]decorated, subscriptedᵢ, renaming</code></a></li>
<li><a href="#Forming-Syntax-and-the-Special---𝑛𝑎𝑚𝑒--Variable">3.12. Forming Syntax and the Special <code>$𝑛𝑎𝑚𝑒</code> Variable</a></li>
<li><a href="#Subpacakges-with--generated--sorts--signature-">3.13. Subpacakges with <code>generated, sorts, signature</code></a></li>
<li><a href="#Shallow-Renaming-with-Agda-s--open---public---renaming---">3.14. Shallow Renaming with Agda's <code>open ⋯ public ⋯ renaming ⋯</code></a></li>
<li><a href="#Automatically-deriving-homomorphism-definitions">3.15. Automatically deriving homomorphism definitions ♥‿♥</a></li>
</ul>
</li>
<li><a href="#Strings-and-Things">4. Strings and Things</a>
<ul>
<li><a href="#Finding-Children-in-the-Wild">4.1. Finding Children in the Wild</a></li>
<li><a href="#Substrings-Delimited-by-Tokens">4.2. Substrings Delimited by Tokens</a></li>
<li><a href="#Agda-Mixfix-Renaming-and-Imports">4.3. Agda Mixfix Renaming and Imports</a></li>
<li><a href="#-λ--for-the-Agda-User">4.4. “λ” for the Agda User</a></li>
</ul>
</li>
<li><a href="#The--package-former--Datatype">5. The <code>package-former</code> Datatype</a>
<ul>
<li><a href="#Locally-Opening-a-PackageFormer">5.1. Locally Opening a PackageFormer</a></li>
<li><a href="#Elements">5.2. Elements</a></li>
<li><a href="#Well-formed-checks----Error-reporting">5.3. Well-formed checks &#x2014;Error reporting</a></li>
<li><a href="#Package-Former-Parsing-and-Pretty-Printing">5.4. Package Former Parsing and Pretty Printing</a></li>
</ul>
</li>
<li><a href="#Variational-Language">6. Variational Language</a>
<ul>
<li><a href="#Well-formed-checks----Error-reporting">6.1. Well-formed checks &#x2014;Error reporting</a></li>
<li><a href="#𝒱𝒸---𝒱---and-𝒱">6.2. 𝒱𝒸,  𝒱-, and 𝒱</a></li>
<li><a href="#Loading-Variationals--Super-Simple-Conversion-From-String-to-Lisp">6.3. Loading Variationals: Super Simple Conversion From String to Lisp</a></li>
</ul>
</li>
<li><a href="#Loading-an-Agda-Buffer">7. Loading an Agda Buffer</a>
<ul>
<li><a href="#Loading-an-Instance----The-Core-Utility">7.1. Loading an Instance &#x2014;The Core Utility</a></li>
<li><a href="#-pf--load-700-comments--and--lisp--blocks">7.2. <code>pf--load-700-comments</code> and <code>lisp</code> blocks</a></li>
</ul>
</li>
<li><a href="#Emacs-Interface">8. Emacs Interface</a>
<ul>
<li><a href="#Tooltips">8.1. Tooltips</a></li>
<li><a href="#Advising-our-Beloved--C-c-C-l-">8.2. Advising our Beloved <code>C-c C-l</code></a></li>
<li><a href="#Menu-matter">8.3. Menu matter</a></li>
</ul>
</li>
<li><a href="#Work">9. <span class="done Future">Future</span> &amp; Related Work</a>
<ul>
<li><a href="#Features-Wish-list">9.1. Features Wish-list</a></li>
<li><a href="#Equality--From---to---to---">9.2. Equality: From ≡ to ≈ to ≈′</a></li>
<li><a href="#PackageFormers-with-variational-parameters">9.3. PackageFormers with variational parameters</a></li>
<li><a href="#Related-Work">9.4. Related Work</a></li>
</ul>
</li>
<li><a href="#Works-to-look-into">10. <span class="todo TODO">TODO</span> Works to look into</a></li>
</ul>
</div>
</nav>

<div id="outline-container-orged20d0d" class="outline-2">
<h2 id="Aim---Scrap-the-Repetition-"><span class="section-number-2">1</span> Aim: <i>Scrap the Repetition</i></h2>
<div class="outline-text-2" id="text-Aim---Scrap-the-Repetition-">
<p>
We're going to write a code generator in Lisp that is going to interpret
fictitious Agda code &#x2014;henceforth referred to as “700 code”&#x2014;
into currently legitimate Agda code.
</p>

<p>
For example, something like the following, henceforth referred to as <code>test</code>:
</p>
<div class="org-src-container">
<pre class="src src-agda" id="orgb03680d"><span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

S<span style="color: #0000cd;">emantics</span>     <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span>
S<span style="color: #0000cd;">yntax</span>        <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">data</span> <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">tags</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>)
U<span style="color: #0000cd;">ntypedSyntax</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">data</span> <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>)
S<span style="color: #0000cd;">calarSyntax</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">data</span> <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>)
S<span style="color: #0000cd;">tream</span>        <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #0000cd;">parameterised</span> <span style="color: #3a81c3; font-weight: bold;">codata</span> <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Vector</span>) <span style="color: #3a81c3; font-weight: bold;">renaming</span> (_&#183;_&#8321; <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">head</span>; _&#183;_&#8322; <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">tail</span>)
V<span style="color: #0000cd;">ectorSyntax</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">data</span> <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Vector</span>) <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">variables</span> (<span style="color: #0000cd;">embed</span>) <span style="color: #0000cd;">from</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>)
N<span style="color: #0000cd;">earMonoid</span>    <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> <span style="color: #3a81c3; font-weight: bold;">renaming</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>; _&#183;_ <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>; _&#215;_ <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>)
</pre>
</div>

<p>
Will behave as if it were written:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Semantics</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #3a81c3; font-weight: bold;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

<span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span><span style="color: #ba2f59; font-weight: bold;"> Scalar Vector</span> :<span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span>
<span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> Syntax</span> :<span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Vector</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span>

<span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>

<span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Nutshell: Keep items ending in &#8220;Stream Carrier&#8221;, then discard that ending,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         then form a subscripted version for each argument.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Stream (Carrier : Set) : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  coinductive</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  field</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    head : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    tail : Stream Carrier</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">data VectorSyntax (Scalar : Set) : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    embed   : Scalar &#8594; VectorSyntax</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#183;_     : Scalar &#8594; VectorSyntax &#8594; VectorSyntax</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">record NearMonoid : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  field</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#10814;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    &#120793;       : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    leftId  : {&#120011; : Carrier}  &#8594;  &#120793; &#10814; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    assoc   : {a b : Carrier} {&#120011; : Carrier} &#8594; (a &#10814; b) &#10814; &#120011;  &#8801;  a &#10814; (b &#10814; &#120011;)</span>
</pre>
</div>
<p>
This is a more than a <a id="orgedb3f09">200% increase</a> in size; that is, our fictitious code will
save us a lot of repetition.
</p>

<p>
The above is ideal syntax: In Lisp fashion, we are not limiting our vision to what
we can currently be done. The actual syntax that is currently supported by this
program is surprisingly close to the above, with an occasional <code>-</code> or <code>:</code> inserted.
Just look at the following source file and resulting generated code!
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> package-former.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This loads the PackageFormer metaprogram; press C-x C-e after the closing &#8220;)&#8221; below.                 -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span> (<span style="color: #0000cd;">progn</span> (<span style="color: #0000cd;">load-file</span> <span style="color: #2d9574;">"~/.emacs.d/agda-next-700-module-systems.el"</span>) (<span style="color: #0000cd;">agda-next-700-module-systems-mode</span>)) -}

<span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">package-former</span> <span style="color: #3a81c3; font-weight: bold;">where</span>

<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">package-former-generated</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.List</span> <span style="color: #3a81c3; font-weight: bold;">using</span><span style="color: #ba2f59; font-weight: bold;"> (List</span>; _&#8759;_; []; <span style="color: #0000cd;">foldr</span>)
<span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span><span style="color: #715ab1;"> as</span> &#8801;; <span style="color: #3a81c3; font-weight: bold;">open</span> &#8801; <span style="color: #3a81c3; font-weight: bold;">using</span> (_&#8801;_)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's ensure content of User Manual part I actually type checkes -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Feel</span> <span style="color: #0000cd;">free</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">comment</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">line</span> <span style="color: #0000cd;">out</span>. -}
<span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">package-former-user-manual-i</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">0. There are a number of common use-cases.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">1. We can handle all of them &amp; more, since we're extensible.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  - Mention the Lean &amp; Coq, as well as the Agda, repeated fragments.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">2. The resulting setup is pragmatic: It is unobtrusive in the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   traditional Agda coding style in that it happens in the background.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">3. It fills a particular need; the desire to avoid repetitious code.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span> <span style="color: #0000cd;">lisp</span>
(<span style="color: #0000cd;">message-box</span> <span style="color: #2d9574;">"Hello"</span>)
(<span style="color: #0000cd;">message-box</span> <span style="color: #2d9574;">"World"</span>)
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
<span style="color: #ba2f59; font-weight: bold;">PackageFormer MonoidP</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>

    --<span style="color: #ba2f59; font-weight: bold;"> A</span> <span style="color: #0000cd;">few</span> <span style="color: #0000cd;">declarations</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

    --<span style="color: #ba2f59; font-weight: bold;"> We</span> <span style="color: #0000cd;">have</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">setoid-like</span> <span style="color: #0000cd;">structure</span>; <span style="color: #3a81c3; font-weight: bold;">with</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">default</span> <span style="color: #0000cd;">implementation</span>
    _&#8776;_   :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span>
    _&#8776;_   <span style="color: #3a81c3; font-weight: bold;">=</span> _&#8801;_
    &#10814;-<span style="color: #0000cd;">cong</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span>&#8242;} &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>&#8242; &#8594;  <span style="color: #0000cd;">y</span> &#8776; <span style="color: #0000cd;">y</span>&#8242; &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#8776; (<span style="color: #0000cd;">x</span>&#8242; &#10814; <span style="color: #0000cd;">y</span>&#8242;)
    &#10814;-<span style="color: #0000cd;">cong</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">&#955;</span>{ &#8801;.<span style="color: #0000cd;">refl</span> &#8801;.<span style="color: #0000cd;">refl</span> &#8594; &#8801;.<span style="color: #0000cd;">refl</span>}

    --<span style="color: #ba2f59; font-weight: bold;"> For</span> <span style="color: #0000cd;">now</span> <span style="color: #0000cd;">only</span> <span style="color: #0000cd;">one</span> <span style="color: #0000cd;">item</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">declaration</span>;
    -- <span style="color: #0000cd;">namely</span> &#8220;L<span style="color: #0000cd;">id</span>&#8221; &amp; &#8220;R<span style="color: #0000cd;">id</span>&#8221; <span style="color: #0000cd;">cannot</span> <span style="color: #0000cd;">be</span> <span style="color: #0000cd;">declared</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #0000cd;">one</span> <span style="color: #0000cd;">line</span>.
   <span style="color: #ba2f59; font-weight: bold;"> Lid</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Lid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span>
   <span style="color: #ba2f59; font-weight: bold;"> Rid</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>

    --<span style="color: #ba2f59; font-weight: bold;"> Agda</span> <span style="color: #0000cd;">permits</span> <span style="color: #0000cd;">pure</span>, <span style="color: #0000cd;">non-pattern-matching</span>, <span style="color: #0000cd;">equations</span> <span style="color: #0000cd;">between</span> &#8220;<span style="color: #0000cd;">fields</span>&#8221; <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #0000cd;">a</span> <span style="color: #3a81c3; font-weight: bold;">record</span>.
    <span style="color: #0000cd;">concat</span> :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">concat</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">foldr</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_ Id</span>

    -- <span style="color: #ba2f59; font-weight: bold;">More declarations</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814; <span style="color: #0000cd;">x</span>) &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>

    --<span style="color: #ba2f59; font-weight: bold;"> Since</span> <span style="color: #0000cd;">there</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">no</span> <span style="color: #0000cd;">more</span> <span style="color: #0000cd;">pure</span> <span style="color: #0000cd;">declarations</span>, &#8220;<span style="color: #0000cd;">fields</span>&#8221;, <span style="color: #0000cd;">subsequent</span> <span style="color: #0000cd;">equations</span>
    -- <span style="color: #0000cd;">may</span> <span style="color: #0000cd;">use</span> <span style="color: #3a81c3; font-weight: bold;">pattern</span> <span style="color: #0000cd;">matching</span>.

   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178; :<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>) &#8776;<span style="color: #ba2f59; font-weight: bold;"> Id</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>

    <span style="color: #0000cd;">concat</span>&#8346; :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">concat</span>&#8346; []       <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>
    <span style="color: #0000cd;">concat</span>&#8346; (<span style="color: #0000cd;">x</span> &#8759; <span style="color: #0000cd;">xs</span>) <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">concat</span>&#8346; <span style="color: #0000cd;">xs</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Variational with empty right hand side.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-identity =</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
M<span style="color: #0000cd;">onoidP</span>&#8305;&#7496; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> <span style="color: #0000cd;">identity</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-no-op = "This is the do-nothing variational"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
--<span style="color: #ba2f59; font-weight: bold;"> No</span> <span style="color: #0000cd;">variational</span> <span style="color: #0000cd;">clauses</span> <span style="color: #0000cd;">needed</span>!
M<span style="color: #0000cd;">onoidP</span>&#8304;  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Identity of composition &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#7580; = MonoidP &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
&#119985;-<span style="color: #0000cd;">test</span> <span style="color: #0000cd;">positional</span> (<span style="color: #0000cd;">keyword</span> <span style="color: #a020f0;">3</span>) <span style="color: #0000cd;">another</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #2d9574;">"I have two mandatory arguments and one keyword argument"</span>

M<span style="color: #0000cd;">onoid-test</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> &#10228; <span style="color: #0000cd;">test</span> <span style="color: #2d9574;">"positional arg&#8321;"</span> <span style="color: #2d9574;">"positional arg&#8322;"</span> :<span style="color: #0000cd;">keyword</span> <span style="color: #a020f0;">25</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-whoops  = tester 1 2 :keyword 3</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
&#119985;-<span style="color: #0000cd;">record</span>&#8320; <span style="color: #3a81c3; font-weight: bold;">=</span> :<span style="color: #0000cd;">kind</span> <span style="color: #3a81c3; font-weight: bold;">record</span> :<span style="color: #0000cd;">alter-elements</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">es</span> &#8594; (--<span style="color: #0000cd;">map</span> (<span style="color: #0000cd;">map-qualifier</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; <span style="color: #2d9574;">"field"</span>) <span style="color: #0000cd;">it</span>) <span style="color: #0000cd;">es</span>))
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record = M-Set record&#8320;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #0000cd;">lisp</span>
(&#119985; <span style="color: #0000cd;">record</span>&#8321; (<span style="color: #0000cd;">discard-equations</span> <span style="color: #0000cd;">nil</span>)
 <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #2d9574;">"Reify a variational as an Agda &#8220;record&#8221;.</span>
<span style="color: #2d9574;">    Elements with equations are construed as</span>
<span style="color: #2d9574;">    derivatives of fields  ---the elements</span>
<span style="color: #2d9574;">    without any equations--- by default, unless</span>
<span style="color: #2d9574;">    DISCARD-EQUATIONS is provided with a non-nil value.</span>
<span style="color: #2d9574;">   "</span>
  :<span style="color: #0000cd;">kind</span> <span style="color: #3a81c3; font-weight: bold;">record</span>
  :<span style="color: #0000cd;">alter-elements</span>
    (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">es</span> &#8594;
      (<span style="color: #0000cd;">thread-last</span> <span style="color: #0000cd;">es</span>
      ;;<span style="color: #ba2f59; font-weight: bold;"> Keep</span> <span style="color: #0000cd;">or</span> <span style="color: #0000cd;">drop</span> <span style="color: #0000cd;">eqns</span> <span style="color: #0000cd;">depending</span> <span style="color: #0000cd;">on</span> &#8220;<span style="color: #0000cd;">discard-equations</span>&#8221;
      (--<span style="color: #0000cd;">map</span>
        (<span style="color: #0000cd;">if</span> <span style="color: #0000cd;">discard-equations</span>
            (<span style="color: #0000cd;">map-equations</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; <span style="color: #0000cd;">nil</span>) <span style="color: #0000cd;">it</span>)
            <span style="color: #0000cd;">it</span>))
      ;;<span style="color: #ba2f59; font-weight: bold;"> Unless</span> <span style="color: #0000cd;">there</span>'<span style="color: #0000cd;">s</span> <span style="color: #0000cd;">equations</span>, <span style="color: #0000cd;">mark</span> <span style="color: #0000cd;">elements</span><span style="color: #715ab1;"> as</span> <span style="color: #0000cd;">fields</span>.
      (--<span style="color: #0000cd;">map</span> (<span style="color: #0000cd;">map-qualifier</span>
        (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; (<span style="color: #0000cd;">unless</span> (<span style="color: #0000cd;">element-equations</span> <span style="color: #0000cd;">it</span>)
               <span style="color: #2d9574;">"field"</span>)) <span style="color: #0000cd;">it</span>)))))
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived = MonoidP record&#8321;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
M<span style="color: #0000cd;">onoid-Record-field</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> <span style="color: #0000cd;">record</span>&#8321; :<span style="color: #0000cd;">discard-equations</span> <span style="color: #0000cd;">t</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived-again  = MonoidP record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived-again2 = MonoidP record :and-names t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-field-again    = MonoidP record :discard-equations t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-no-equationals = MonoidP record :discard-equations t :and-names t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
&#119985;-<span style="color: #3a81c3; font-weight: bold;">typeclass</span>-attempt <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; :<span style="color: #0000cd;">waist</span> <span style="color: #a020f0;">2</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-TypeClass = M-Set typeclass-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
&#119985;-<span style="color: #3a81c3; font-weight: bold;">typeclass</span>&#8322; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; :<span style="color: #0000cd;">waist</span> <span style="color: #a020f0;">2</span> :<span style="color: #0000cd;">level</span> <span style="color: #0000cd;">dec</span>
M<span style="color: #0000cd;">onoidT</span>&#8322;      <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> <span style="color: #3a81c3; font-weight: bold;">typeclass</span>&#8322;
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8323;         = MonoidP record &#10228; :waist 3 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MonoidT&#8323;-again   = MonoidP &#10228; record &#10228; unbundling 3</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8322; = M-Set record &#10228; typeclass&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
--<span style="color: #ba2f59; font-weight: bold;"> Ill-formed</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Agda</span>:<span style="color: #ba2f59; font-weight: bold;"> A</span> <span style="color: #0000cd;">defintion</span> <span style="color: #0000cd;">is</span> <span style="color: #0000cd;">not</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">parameter</span>!
M<span style="color: #0000cd;">onoidP-Typeclass</span>&#8325; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> :<span style="color: #0000cd;">waist</span> <span style="color: #a020f0;">5</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8325; = MonoidP &#10228; unbundling 5 &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
--<span style="color: #ba2f59; font-weight: bold;"> Intentionally</span> <span style="color: #0000cd;">erroenous</span> <span style="color: #0000cd;">attempt</span>.
&#119985;-<span style="color: #0000cd;">primed-attempt</span> <span style="color: #3a81c3; font-weight: bold;">=</span> :<span style="color: #0000cd;">alter-elements</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">es</span> &#8594; (--<span style="color: #0000cd;">map</span> (<span style="color: #0000cd;">map-name</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">n</span> &#8594; (<span style="color: #0000cd;">rename-mixfix</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">np</span> &#8594; (<span style="color: #0000cd;">concat</span> <span style="color: #0000cd;">np</span> <span style="color: #2d9574;">"&#8242;"</span>)) <span style="color: #0000cd;">n</span>)) <span style="color: #0000cd;">it</span>) <span style="color: #0000cd;">es</span>))

--<span style="color: #ba2f59; font-weight: bold;"> M-Set</span>&#8242;-<span style="color: #0000cd;">attempt</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; <span style="color: #0000cd;">primed-attempt</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set&#8242;-attempt-raw = M-Set primed-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
&#119985;-<span style="color: #3a81c3; font-weight: bold;">typeclass</span> <span style="color: #0000cd;">height</span> (<span style="color: #0000cd;">level</span> '<span style="color: #0000cd;">dec</span>) <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; :<span style="color: #0000cd;">waist</span> <span style="color: #0000cd;">height</span> :<span style="color: #0000cd;">level</span> <span style="color: #0000cd;">level</span>
M-S<span style="color: #0000cd;">et2-Typeclass</span>&#8323; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">typeclass</span> <span style="color: #a020f0;">3</span> :<span style="color: #0000cd;">level</span> '<span style="color: #0000cd;">inc</span>
M-S<span style="color: #0000cd;">et0-Typeclass</span>&#8323; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">typeclass</span> <span style="color: #a020f0;">3</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#120143;    = M-Set record &#10228; map (&#955; e &#8594; (map-name (&#955; n &#8594; (rename-mixfix (&#955; x &#8594; (concat x "&#120143;")) n)) e))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
MR&#120170;    <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> <span style="color: #0000cd;">rename</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">n</span> &#8594; (<span style="color: #0000cd;">concat</span> <span style="color: #0000cd;">n</span> <span style="color: #2d9574;">"&#120170;"</span>))
MR-<span style="color: #0000cd;">oh</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> <span style="color: #0000cd;">rename</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">n</span> &#8594; (<span style="color: #0000cd;">pcase</span> <span style="color: #0000cd;">n</span> (<span style="color: #2d9574;">"Scalar"</span> <span style="color: #2d9574;">"S"</span>) (<span style="color: #2d9574;">"&#120793;"</span> <span style="color: #2d9574;">"&#949;"</span>) (<span style="color: #0000cd;">else</span> <span style="color: #0000cd;">else</span>)))
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MR&#8321;&#8322;   = M-Set-Record decorated "&#8321;" &#10228; decorated "&#8322;" :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">the-MR = M-Set-Record co-decorated "the-"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MR&#8323;&#8324;   = M-Set-Record subscripted&#8323; &#10228; subscripted&#8324; :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338;   = M-Set-Record renaming "Scalar to S; Vector to V; &#183; to nice"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set-Record renaming "Scalar to Carrier; Vector to Carrier; &#183; to &#215;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
N<span style="color: #0000cd;">earMonoid</span>&#185; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> <span style="color: #0000cd;">single-sorted</span> <span style="color: #2d9574;">"Carrier"</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">ScalarTerm = M-Set data "Scalar"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
M-S<span style="color: #0000cd;">et-Sorts</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; <span style="color: #0000cd;">sorts</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidSignature = M-Set-Record generated (&#955; e &#8594; (and (s-contains? "Scalar" (element-type e)) (not (s-contains? "Vector" (element-type e)))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
M<span style="color: #0000cd;">onSig</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> <span style="color: #0000cd;">signature</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-empty-module = :kind module :level none :waist 999</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Neato = M-Set empty-module</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> A</span> <span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #3a81c3; font-weight: bold;">where</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">elements</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">all</span> <span style="color: #0000cd;">parameters</span> -}
<span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Neato</span> <span style="color: #3a81c3; font-weight: bold;">using</span> ()

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8321; = M-Set-R &#10228; open (&#955; x &#8594; (concat x "&#8321;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
M-S<span style="color: #0000cd;">et-R-SV</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> <span style="color: #0000cd;">opening</span> <span style="color: #2d9574;">"Scalar to S; Vector to V"</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Algebra  = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Algebra&#8242; = Algebra open-with-decoration "&#8242;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = Algebra hom</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom&#178; = Algebra hom &#10228; renaming "map&#8321; to scalar; pres-&#120793; to unity" :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">_ : {Src Tgt : Algebra} &#8594; Hom&#178; Src Tgt &#8594; Algebra.Scalar Src &#8594; Algebra.Scalar Tgt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">_ = Hom&#178;.scalar</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #a020f0;">700</span>
-- <span style="color: #0000cd;">regular</span> <span style="color: #0000cd;">expression</span> <span style="color: #0000cd;">test</span> --

<span style="color: #0000cd;">crazy-name-</span>[]-+-\-^-*-? <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"_+_ : Scalar; _*_ : Vector; ^ : Set; [_] : Set"</span> :<span style="color: #0000cd;">adjoin-retract</span> <span style="color: #0000cd;">nil</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>

P<span style="color: #0000cd;">ointed</span>   <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"e : let Carrier = Carrier in Carrier"</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>
A<span style="color: #0000cd;">dditive</span>+ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Pointed</span> <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"op to _+_; e to O; Carrier to C"</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>
A<span style="color: #0000cd;">dditive</span>&#215; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Additive</span>+ <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"_+_ to _&#215;_"</span>

<span style="color: #0000cd;">crazy-name-test</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Pointed</span> <span style="color: #0000cd;">map</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">e</span> &#8594; (<span style="color: #0000cd;">map-name</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">n</span> &#8594; (<span style="color: #0000cd;">concat</span> <span style="color: #0000cd;">n</span> <span style="color: #2d9574;">"/crazy-name-[]-+-\-^-*-?"</span>)) <span style="color: #0000cd;">e</span>)) &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>
<span style="color: #0000cd;">crazy-name-test2</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">crazy-name-test</span> <span style="color: #0000cd;">map</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">e</span> &#8594; (<span style="color: #0000cd;">map-name</span> (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">n</span> &#8594; (<span style="color: #0000cd;">concat</span> <span style="color: #0000cd;">n</span> <span style="color: #2d9574;">"+2"</span>)) <span style="color: #0000cd;">e</span>)) &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>
-}

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8242; = M-Set-R open-with-decoration "&#8242;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> package-former-generated.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This file is generated ;; do not alter. -}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">open import Level as Level using (Level)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">open import Data.Bool</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">open import Data.List using (List; _&#8759;_; []; foldr)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">import Relation.Binary.PropositionalEquality as &#8801;; open &#8801; using (_&#8801;_)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">open import Level as Level using (Level)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">module package-former-generated where </span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Kind</span> &#8220;<span style="color: #ba2f59; font-weight: bold;">PackageFormer</span>&#8221; <span style="color: #0000cd;">does</span> <span style="color: #0000cd;">not</span> <span style="color: #0000cd;">correspond</span>  <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">concrete</span><span style="color: #ba2f59; font-weight: bold;"> Agda</span> <span style="color: #0000cd;">type</span>.

<span style="color: #ba2f59; font-weight: bold;">PackageFormer Empty</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
 -}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Type   = Empty   extended-by "Carrier : Set" :adjoin-retract nil &#10228; record -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Type : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field Carrier       : Set</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Type</span> <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"op : Carrier &#8594; Carrier &#8594; Carrier"</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Semigroup   = Magma postulating "op" "associative" &#10228; record -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Semigroup : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field Carrier       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field op        : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toType      : let View X = X in View Type ; toType = record {Carrier = Carrier}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field assoc     : &#8704; x y z &#8594; op (op x y) z &#8801; op x (op y z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toMagma     : let View X = X in View Magma ;    toMagma = record {Carrier = Carrier;op = op}</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Additive</span>           <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"op to _+_"</span> &#10228; <span style="color: #0000cd;">postulating</span> <span style="color: #2d9574;">"_+_"</span> <span style="color: #2d9574;">"commutative"</span>  :<span style="color: #0000cd;">adjoin-retract</span> <span style="color: #0000cd;">nil</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Additive</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _+_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _+_}
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">comm</span>      : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>   &#8594; _+_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> &#8801; _+_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiplicative     = Magma renaming "op to _&#215;_" :adjoin-retract nil &#10228; record -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Multiplicative : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field Carrier       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field _&#215;_       : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toType      : let View X = X in View Type ; toType = record {Carrier = Carrier}</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> AddMult</span>            <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Additive</span> <span style="color: #0000cd;">union</span> <span style="color: #2d9574;">"Multiplicative"</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> AddMult</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _+_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _+_}
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">comm</span>      : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>   &#8594; _+_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> &#8801; _+_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toAdditive</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Additive</span> ; <span style="color: #0000cd;">toAdditive</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;_+_ <span style="color: #3a81c3; font-weight: bold;">=</span> _+_;<span style="color: #0000cd;">comm</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">comm</span>}
    <span style="color: #0000cd;">toMultiplicative</span>        : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Multiplicative</span> ;   <span style="color: #0000cd;">toMultiplicative</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;_&#215;_ <span style="color: #3a81c3; font-weight: bold;">=</span> _&#215;_}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Additive2          = Additive intersect "AddMult" -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Additive2 : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field Carrier       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field _+_       : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field comm      : &#8704; x y   &#8594; _+_ x y &#8801; _+_ y x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    fromAdditive        : let View X = X in Additive &#8594; View Additive2 ; fromAdditive = &#955; g231615 &#8594; record {Carrier = Additive.Carrier g231615;_+_ = Additive._+_ g231615;comm = Additive.comm g231615}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    fromAddMult     : let View X = X in AddMult &#8594; View Additive2 ;  fromAddMult = &#955; g231616 &#8594; record {Carrier = AddMult.Carrier g231616;_+_ = AddMult._+_ g231616;comm = AddMult.comm g231616}</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> SG</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> <span style="color: #0000cd;">postulating</span> <span style="color: #2d9574;">"op"</span> <span style="color: #2d9574;">"associative"</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> SG</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span> &#8594; <span style="color: #0000cd;">op</span> (<span style="color: #0000cd;">op</span> <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>) <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">op</span> <span style="color: #0000cd;">x</span> (<span style="color: #0000cd;">op</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>)
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">AdditiveSG = SG renaming "op to _+_" -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record AdditiveSG : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field Carrier       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field _+_       : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toType      : let View X = X in View Type ; toType = record {Carrier = Carrier}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field assoc     : &#8704; x y z &#8594; _+_ (_+_ x y) z &#8801; _+_ x (_+_ y z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toMagma     : let View X = X in View Magma ;    toMagma = record {Carrier = Carrier;op = _+_}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    toSG        : let View X = X in View SG ;   toSG = record {Carrier = Carrier;op = _+_;assoc = assoc}</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> MultiplicativeSG</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> SG</span> <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"op to _&#183;_"</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MultiplicativeSG</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span> &#8594; _&#183;_ (_&#183;_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>) <span style="color: #0000cd;">z</span> &#8801; _&#183;_ <span style="color: #0000cd;">x</span> (_&#183;_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>)
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _&#183;_}
    <span style="color: #0000cd;">toSG</span>        : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View SG</span> ;   <span style="color: #0000cd;">toSG</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _&#183;_;<span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">IntersectSGStructures = AdditiveSG intersect "MultiplicativeSG" :adjoin-retract&#8322; t :adjoin-retract&#8321; "woah" :renaming&#8321; "Carrier to C; _+_ to _&#8853;_" :renaming&#8322; "Carrier to C; _&#183;_ to _&#8853;_" -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record IntersectSGStructures : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field C     : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field _&#8853;_       : C &#8594; C &#8594; C</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    field assoc     : &#8704; x y z &#8594; _&#8853;_ (_&#8853;_ x y) z &#8801; _&#8853;_ x (_&#8853;_ y z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    woah        : let View X = X in AdditiveSG &#8594; View IntersectSGStructures ;   woah = &#955; g231830 &#8594; record {C = AdditiveSG.Carrier g231830;_&#8853;_ = AdditiveSG._+_ g231830;assoc = AdditiveSG.assoc g231830}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    fromMultiplicativeSG        : let View X = X in MultiplicativeSG &#8594; View IntersectSGStructures ; fromMultiplicativeSG = &#955; g231831 &#8594; record {C = MultiplicativeSG.Carrier g231831;_&#8853;_ = MultiplicativeSG._&#183;_ g231831;assoc = MultiplicativeSG.assoc g231831}</span>
</pre>
</div>
</details>

<p>
Above is a sample source file which contains special comments that are picked up
by the prototype which then copy-paste-cuts to produce a generated file.
The above code is discussed below, in the user manual
&#x2014;in fact, it's generated from the user-manual below.
</p>

<p>
For this prototype, we have the following <a id="org83c5020">constraints</a>:
</p>

<ol class="org-ol">
<li>The type of a PackageFormer is <code>Set ℓ</code> where <code>ℓ</code> is the empty string
or a parenthesised expression of type <code>Level</code>.
<ul class="org-ul">
<li>In-particular, subscript types are not yet supported.</li>
</ul></li>

<li>The <code>where</code> keyword appears on the same line as the <code>PackageFormer</code> key-phrase.</li>

<li>The name of the PackageFormer should not contain <code>PackageFormer</code> as a sub-identifier.</li>

<li>Each element of a PackageFormer spans only <i>one</i> physical line.</li>
</ol>

<p>
There are many useful features outlined in the proposal, such as default implementations, that we
hope to include in the future. For now, we just want something that works, is decently documented, and
can be useful.
</p>
</div>
</div>
<div id="outline-container-org34c2b01" class="outline-2">
<h2 id="User-Manual"><span class="section-number-2">2</span> User Manual I: Simple Use of the System</h2>
<div class="outline-text-2" id="text-User-Manual">
<p>
If the previous section is unclear regarding the aims and uses of this prototype,
please consult the pre-print <a href="../papers/gpce19_a_language_feature_to_unbundle_data_at_will.pdf">A Language Feature to Unbundle Data at Will</a>
or <a href="https://alhassy.github.io/next-700-module-systems/">the next 700 module systems proposal</a>.
</p>

<p>
Herein we demonstrate how to use this system from the perspective of <i>library designers</i>.
We use constructs that are discussed in the next section &#x2014;which are examples of how
users may extend the system to produce grouping mechanisms for any desired purpose.
The exposition here follows section 2 of the <i>Theory Presentation Combinators</i> [<a class='org-ref-reference' href="#tpc">tpc</a>]
paper, reiterating many the ideas therein.
</p>

<p>
The few constructs demonstrated in this section not only create new grouping mechanisms
from old ones, but also create maps from the new, child, presentations to the old parent
presentations. Maps between grouping mechanisms are sometimes called <i>views</i>.
For example, a theory extended by new declarations comes equipped with
a map that forgets the new declarations to obtain an instance of the original theory.
Such morphisms are tedious to write out, and our system provides them for free.
How? You, the user, can implement such features using our 5 meta-primitives
&#x2014;but we have implemented a few for you as examples.
</p>

<div class="org-center">
<p>
It is important to clarify that <b>the purpose of this work is the development of a core kernel of meta-primitives for modules</b>. This section demonstrates the power and
expressivity of the meta-primitives by showcasing a series of ubiquitous combinators
<i>which may be defined using the meta-primitives and Lisp</i>. The section afterwards goes into the detail of how to <b>extend the system to build any desired operations on any notion of grouping mechanism</b>.
</p>
</div>
</div>

<div id="outline-container-org28905e8" class="outline-3">
<h3 id="Installation"><span class="section-number-3">2.1</span> Installation</h3>
<div class="outline-text-3" id="text-Installation">
<p>
<center><em> Obtaining the system! </center></em>
</p>

<p>
Add the following to the top of your Emacs configuration file, i.e., the <code>~/.emacs</code> file.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Connect to internet repositories for Emacs packages.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">package</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> '<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"melpa-stable"</span> . <span style="color: #2d9574;">"http://stable.melpa.org/packages/"</span><span style="color: #6c3163;">)</span> <span style="color: #715ab1;">package-archives</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">package-initialize</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">package-refresh-contents</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Obtain &amp; setup installation interface.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">package-installed-p</span> '<span style="color: #6c3163; font-weight: bold;">use-package</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">package-install</span> '<span style="color: #6c3163; font-weight: bold;">use-package</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">use-package</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">use-package-always-ensure</span> <span style="color: #715ab1;">t</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Necessary libraries for producing the prototype</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">use-package</span> <span style="color: #4e3163;">s</span><span style="color: #3a81c3;">)</span>                  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;The long lost Emacs string manipulation library&#8221;.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">use-package</span> <span style="color: #4e3163;">dash</span><span style="color: #3a81c3;">)</span>               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;A modern list library for Emacs&#8221;.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">use-package</span> <span style="color: #4e3163;">dash-functional</span><span style="color: #3a81c3;">)</span>    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Function combinators; e.g., -partial/-cut, -const, -compose, -orfn &amp; -andfn for generalised &#8707;/&#8704;.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">use-package</span> <span style="color: #4e3163;">origami</span><span style="color: #3a81c3;">)</span>            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Folding away regions of text.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">use-package</span> <span style="color: #4e3163;">hydra</span><span style="color: #3a81c3;">)</span>              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Helpful menus.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">subr-x</span><span style="color: #3a81c3;">)</span>                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Extra Lisp functions; e.g., when-let.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Next, obtain the Elisp file, load it, and attach it to Agda.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">file-exists-p</span> <span style="color: #2d9574;">"~/.emacs.d/agda-next-700-module-systems.el"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">shell-command</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"curl "</span>
    <span style="color: #2d9574;">"https://raw.githubusercontent.com/alhassy/next-700-module-systems/master/prototype/agda-next-700-module-systems.el"</span>
    <span style="color: #2d9574;">"&gt;&gt; ~/.emacs.d/agda-next-700-module-systems.el"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">load-file</span> <span style="color: #2d9574;">"~/.emacs.d/agda-next-700-module-systems.el"</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(add-hook 'agda2-mode-hook #'agda-next-700-module-systems-mode)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Uncomment out the last line above if you want package-former</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">to ALWAYS be active on .agda files.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">You likely have this in your ~/.emacs file already</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">load-file</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #715ab1;">coding-system-for-read</span> 'utf-8<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
                <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">shell-command-to-string</span> <span style="color: #2d9574;">"/usr/local/bin/agda-mode locate"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
When you enable <code>agda-next-700-module-systems-mode</code>,
</p>

<ol class="org-ol">
<li>A menu-bar <code>PackageFormers</code> will be added.</li>

<li>It will allow you to temporarily disable and enable this new feature,
as well as providing a help menu. Invoke <code>M-x agda-next-700-module-systems-mode</code> to toggle turning off this feature
completely.</li>

<li>The string icon <code>PackageFormer (•̀ᴗ•́)و</code> is displayed in the mode line &#x2014;near the bottom of Emacs.</li>

<li>You may use <code>C-c c-l</code> as usual, but it will now recognise <a href="#org81f2700">700-comments</a> and generate
legitimate Agda code from them &#x2014;more on this later.

<ul class="org-ul">
<li>PackageFormer syntactical items are coloured green, PackageFormer names are
coloured yellow, and their instantiation are simply bolded.</li>
</ul></li>
</ol>

<p>
If you need any assistance, please contact me!
</p>
</div>
</div>

<div id="outline-container-org4095417" class="outline-3">
<h3 id="Syntax"><span class="section-number-3">2.2</span> Syntax</h3>
<div class="outline-text-3" id="text-Syntax">
<p>
<center><em> Superficial glance at the system's syntax. </center></em>
</p>

<p>
The prototype works by translating fictitious <a href="#orge0fd48a">700-syntax</a> into legitimate Agda;
as follows:
</p>
<div class="org-src-container">
<pre class="src src-agda">...<span style="color: #0000cd;">agda</span> <span style="color: #0000cd;">code</span> <span style="color: #0000cd;">here</span>...
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">       ...700-syntactical items here...</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">...more agda code...</span>
</pre>
</div>
<p>
Since the first section provides an example source fragment with both <a href="#org81f2700">700-comments</a> as well
as instantiations, we shall only enclose <a href="#orge0fd48a">700-syntax</a> in <a href="#org81f2700">700-comments</a> when it is surrounded
by other Agda code, and otherwise leave it free standing.
</p>

<p>
<i>We will provide full source listings at the end of discussions that only display fragments!</i>
</p>

<p>
<a id="orge0fd48a">700-syntax</a> is defined informally as follows:
</p>
<pre class="example">
⟪700-syntax⟫    ::=  ⟪PackageFormer⟫ | ⟪Instantiation⟫ | ⟪Agda⟫

⟪PackageFormer⟫ ::= PackageFormer ⟪Identifier⟫ : Set (⟪level⟫) where
               ⟪newline-with-indentation⟫ ⟪Element⟫*

⟪Element⟫       ::=  ⟪Identifier⟫ : ⟪Any-Agda-Type⟫

⟪Instantiation⟫ ::= ⟪Identifier⟫ = ⟪Identifier⟫ ⟪VariationalClause⟫

⟪VariationalClause⟫ ::= [⟪Identifier⟫] (:key (value))* (⟴ ⟪VariationalClause⟫)*
</pre>

<ul class="org-ul">
<li>One derives many presentations of a grouping mechanism by what we call ‘variational clauses’.
<ul class="org-ul">
<li><p>
In a 700-comment, one declares ‘variational’ such as
</p>
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>𝒱-typeclass height = :kind record :level dec :waist-strings ("field") :waist height</code></td>
</tr>
</tbody>
</table>

<p>
These are functions whose names begin with <code>𝒱-</code>, they may have arguments on the left-hand-side,
and their right hand side may invoke any of the 5 meta-primitives
<code>kind, waist, waist-strings, level, alter-elements</code> with any mixture of
arguments and concrete values.
</p>

<ul class="org-ul">
<li>To invoke a variational in an instantiation clause, arguments are not positional
but instead are passed by name &#x2014;e.g., <code>:key value</code>.</li>
</ul></li>
</ul></li>
</ul>

<ul class="org-ul">
<li>Example uses of the variational clauses could be seen in the <code>package-former.agda</code> listing in the first section above.</li>
</ul>
</div>
</div>
<div id="outline-container-org803b299" class="outline-3">
<h3 id="Extension"><span class="section-number-3">2.3</span> Extension</h3>
<div class="outline-text-3" id="text-Extension">
<p>
The simplest situation is where the presentation of one theory is included, verbatim, in another.
Concretely, consider <code>Monoid</code> and <code>CommutativeMonoid</code>.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer Monoid : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {x y z : Carrier} &#8594; (x &#183; y) &#183; z  &#8801;  x &#183; (y &#183; z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;       : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {x : Carrier} &#8594; &#120128; &#183; x  &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   rightId : {x : Carrier} &#8594; x &#183; &#120128;  &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;-unique : &#8704; {e} (lid : &#8704; {x} &#8594; e &#183; x &#8801; x) (rid : &#8704; {x} &#8594; x &#183; e &#8801; x) &#8594; e &#8801; &#120128;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;-unique lid rid = &#8801;.trans (&#8801;.sym leftId) rid</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer CommutativeMonoid&#8320; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {x y z : Carrier} &#8594; (x &#183; y) &#183; z  &#8801;  x &#183; (y &#183; z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;       : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {x : Carrier} &#8594;  &#120128; &#183; x  &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   rightId : {x : Carrier} &#8594;  x &#183; &#120128;  &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   comm    : {x y : Carrier} &#8594;  x &#183; y  &#8801;  y &#183; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;-unique : &#8704; {e} (lid : &#8704; {x} &#8594; e &#183; x &#8801; x) (rid : &#8704; {x} &#8594; x &#183; e &#8801; x) &#8594; e &#8801; &#120128;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120128;-unique lid rid = &#8801;.trans (&#8801;.sym leftId) rid</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
As expected, the only difference is that <code>CommutativeMonoid₀</code> adds a <code>comm</code>-utative axiom.
Thus, given <code>Monoid</code>, it would be more economical to define:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">CommutativeMonoid = Monoid extended-by "comm : {x y : Carrier} &#8594;  x &#183; y  &#8801;  y &#183; x"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Hovering over the left-hand-side gives a tooltip showing the resulting elaboration,
which is identical to <code>CommutativeMonoid₀</code> along with a forgetful operation 😄
The tooltip shows the <i>expanded</i> version of the theory, which is
<b>what we want to specify but not what we want to enter manually</b>.
To obtain this specification of <code>CommutativeMonoid</code> in the current implementation
of Agda, one would likely declare a record with two <a href="#orgb32f32d">fields</a> &#x2014;one being a <code>Monoid</code>
and the other being the commutativity constraint&#x2014; however, this <span class="underline">only</span> gives
the appearance of the above specification for consumers; those who produce instances
of <code>CommutativeMonoid</code> are then <span class="underline">forced</span> to know the particular hierarchy and must provide
a <code>Monoid</code> value first. It is a happy coincidence that our system alleviates such an issue.
</p>

<p>
Alternatively, we may reify the new syntactical items as concrete Agda supported <code>record</code>-s as follows.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR            = Monoid &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">CommutativeMonoidR = MonoidR extended-by "comm : {x y : Carrier} &#8594;  x &#183; y  &#8801;  y &#183; x" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">neato : CommutativeMonoidR &#8594; MonoidR</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">neato = CommutativeMonoidR.toMonoidR</span>
</pre>
</div>

<p>
<b>“Transport”</b>
It is important to notice that the <i>derived</i> result <code>𝕀-unique</code>, while proven in the setting of <code>Monoid</code>,
is not only available via the morphism <code>toMonoidR</code> but is also available directly since it is also
a member of <code>CommutativeMonoidR</code>.
</p>

<p>
As a teaser, here's how the <code>extended-by</code> variational is defined &#x2014;we leave the details of which
to the second part of the user manual.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Definition of extended-by </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">element-retract</span> <span style="color: #6c3163;">(</span>parent es <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>new es<span style="color: #2d9574;">)</span> name contravariant<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Realise a list of elements as an Agda no-op record.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">E.g., list &#8220;Carrier : Set; e : Carrier&#8221;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">maps to the following element value.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">      toParent : parent</span>
<span style="color: #da8b55; background-color: #ecf3ec;">      toParent = record {Carrier = Carrier; e = e}</span>

<span style="color: #da8b55; background-color: #ecf3ec;">See also &#119985;-renaming, which may be useful to change &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">toParent</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">NEW is a new updated version of ES, if any.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">NAME is the name of the new retract element; by default it's &#8220;toParent&#8221; or &#8220;fromParent&#8221;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">depending on whether CONTRAVARIANT is true or not.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">"</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the name of the newly defined PackageFormer ---which we may access using the special identifier ~$&#119899;&#119886;&#119898;&#119890;~.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>toParent <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #715ab1;">t</span> name<span style="color: #6c3163;">)</span> name<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s%s"</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> contravariant <span style="color: #2d9574;">"from"</span> <span style="color: #2d9574;">"to"</span><span style="color: #6c3163;">)</span> parent<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NAME may be "t", but not the symbol t. This is useful in any &#119985;artional that has an optional adjoin-retract</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">argument, which the user may set to be nil, t, or a string to obtain nothing, default name, and given name for the morphism; respectively.</span>
        <span style="color: #67b11d;">(</span>&#964;arg     <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> contravariant <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s &#8594; "</span> parent<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">""</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>&#948;var     <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">gensym</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">unique argument name to avoid accidental shawdowing of any &#8220;e in es&#8221;.</span>
        <span style="color: #67b11d;">(</span>&#948;arg     <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> contravariant <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"&#955; %s &#8594; "</span> &#948;var<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">""</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span>
      <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s : let View X = X in %sView %s"</span> toParent &#964;arg <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> contravariant $&#119899;&#119886;&#119898;&#119890; parent<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
      <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = %srecord {%s}"</span> toParent &#948;arg

        <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">";"</span>
        <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for e  in es
              for e&#8242; in new
              <span style="color: #6c3163; font-weight: bold;">unless</span> <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains-p</span> <span style="color: #2d9574;">"let View X = X"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> e<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ignore source view morphisms</span>
                         <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> e<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>                           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ignore &#8220;derivied&#8221; elements</span>
              collect <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> contravariant<span style="color: #3a81c3;">)</span>
                          <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = %s"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e&#8242;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = %s.%s %s"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #6c3163;">)</span> parent <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e&#8242;<span style="color: #6c3163;">)</span> &#948;var<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> extended-by ds <span style="color: #6c3163;">(</span>adjoin-retract <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span>
   <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Extend a given presentation by a list of ;-separated declarations.</span>

<span style="color: #2d9574;">      The resuling presentation has a &#8220;toX&#8221; retract method,</span>
<span style="color: #2d9574;">      where &#8216;X&#8217; is the parent presentation. To avoid this,</span>
<span style="color: #2d9574;">      set ADJOIN-RETRACT to be nil. To provide a preferred name for</span>
<span style="color: #2d9574;">      the morphism, then set ADJOIN-RETRACT to the desired string.</span>
<span style="color: #2d9574;">     "</span>
     <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> es <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">";"</span> ds<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; es <span style="color: #3a81c3;">:name</span> adjoin-retract<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<ul class="org-ul">
<li>Simple exercise: Play with this setup to observe that <code>extended-by</code> is an idempotent operation.</li>
<li><p>
Advanced exercise: Read the user manual, parts I and II, then produce a variational <code>commuting</code>
such that <code>CommutativeMagma</code> can be regained by <code>Magma commuting "·"</code>.
</p>

<p>
See the <code>flipping</code> variational below.
</p></li>
</ul>

<p>
Anyhow, notice that we may define <code>GroupR</code> &#x2014;a record-presentation of groups&#x2014; as an extension of <code>MonoidR</code>
using a <i>single</i> <code>extended-by</code> clause where the necessary items are separated by <code>;</code>.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">GroupR = MonoidR extended-by "_&#8315;&#185; : Carrier &#8594; Carrier; left&#8315;&#185; : &#8704; {x} &#8594; (x &#8315;&#185;) &#183; x &#8801; &#120128;; right&#8315;&#185; : &#8704; {x} &#8594; x &#183; (x &#8315;&#185;) &#8801; &#120128;" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org67e499c" class="outline-3">
<h3 id="Defining-a-Concept-Only-Once"><span class="section-number-3">2.4</span> Defining a Concept Only Once</h3>
<div class="outline-text-3" id="text-Defining-a-Concept-Only-Once">
<p>
From a library-designer's perspective, our definition of <code>CommutativeMonoid</code> has the commutativity property ‘hard coded’ into it.
If we wish to speak of commutative magmas &#x2014;types with a single commutative operation&#x2014; we need to hard-code the property once again.
If, at a later time, we wish to move from having arguments be implicit to being explicit then we need to track down every hard-coded
instance of the property then alter them &#x2014;having them in-sync becomes an issue.
</p>

<p>
Instead, the system lets us ‘build upon’ the <code>extended-by</code> combinator: We make an associative list of
names and properties, then string-replace the meta-names <i>op, op′, rel</i> with the provided user names.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> postulating bop prop <span style="color: #6c3163;">(</span>using bop<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Adjoin a property PROP for a given binary operation BOP.</span>

<span style="color: #2d9574;">   PROP may be a string: associative, commutative, idempotent, etc.</span>

<span style="color: #2d9574;">   Some properties require another operator or a relation; which may</span>
<span style="color: #2d9574;">   be provided via USING.</span>

<span style="color: #2d9574;">   ADJOIN-RETRACT is the optional name of the resulting retract morphism.</span>
<span style="color: #2d9574;">   Provide nil if you do not want the morphism adjoined.</span>

<span style="color: #2d9574;">   With this variational, a definition is only written once.</span>
<span style="color: #2d9574;">   "</span>
   extended-by '<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"op"</span> bop <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"rel"</span> using <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"op&#8242;"</span> using
    <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> prop
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"associative"</span>   <span style="color: #2d9574;">"assoc : &#8704; x y z &#8594; op (op x y) z &#8801; op x (op y z)"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"commutative"</span>   <span style="color: #2d9574;">"comm  : &#8704; x y   &#8594; op x y &#8801; op y x"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"idempotent"</span>    <span style="color: #2d9574;">"idemp : &#8704; x     &#8594; op x x &#8801; x"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"involutive"</span>    <span style="color: #2d9574;">"inv   : &#8704; x     &#8594; op (op x) &#8801; x"</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">assuming bop is unary</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"left-unit"</span>     <span style="color: #2d9574;">"unit&#737; : &#8704; x y z &#8594; op e x &#8801; e"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"right-unit"</span>    <span style="color: #2d9574;">"unit&#691; : &#8704; x y z &#8594; op x e &#8801; e"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"distributive&#737;"</span> <span style="color: #2d9574;">"dist&#737; : &#8704; x y z &#8594; op x (op&#8242; y z) &#8801; op&#8242; (op x y) (op x z)"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"distributive&#691;"</span> <span style="color: #2d9574;">"dist&#691; : &#8704; x y z &#8594; op (op&#8242; y z) x &#8801; op&#8242; (op y x) (op z x)"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"absorptive"</span>    <span style="color: #2d9574;">"absorp  : &#8704; x y  &#8594; op x (op&#8242; x y) &#8801; x"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"reflexive"</span>     <span style="color: #2d9574;">"refl    : &#8704; x y  &#8594; rel x x"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"transitive"</span>    <span style="color: #2d9574;">"trans   : &#8704; x y z &#8594; rel x y &#8594; rel y z &#8594; rel x z"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"antisymmetric"</span> <span style="color: #2d9574;">"antisym : &#8704; x y &#8594; rel x y &#8594; rel y x &#8594; x &#8801; z"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"congruence"</span>    <span style="color: #2d9574;">"cong    : &#8704; x x&#8242; y y&#8242; &#8594; rel x x&#8242; &#8594; rel y y&#8242; &#8594; rel (op x x&#8242;) (op y y&#8242;)"</span><span style="color: #3a81c3;">)</span>
     <span style="color: #3a81c3;">(</span><span style="color: #715ab1;">t</span> <span style="color: #6c3163;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"&#119985;-postulating does not know the property &#8220;%s&#8221;"</span> prop<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3;">:adjoin-retract</span> 'adjoin-retract<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We can extend this database of properties as needed with relative ease. Here is an example use along with its elaboration.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">RawRelationalMagma = Magma extended-by "_&#8776;_ : Carrier &#8594; Carrier &#8594; Set" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">RelationalMagma    = RawRelationalMagma postulating "op" "congruence" :using "_&#8776;_" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> RawRelationalMagma</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#8776;_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>}

<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> RelationalMagma</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">toType</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span> ; <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#8776;_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #0000cd;">toMagma</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span> ;    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>}
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">cong</span>      : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">y</span>&#8242; &#8594; _&#8776;_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">x</span>&#8242; &#8594; _&#8776;_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">y</span>&#8242; &#8594; _&#8776;_ (<span style="color: #0000cd;">op</span> <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">x</span>&#8242;) (<span style="color: #0000cd;">op</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">y</span>&#8242;)
    <span style="color: #0000cd;">toRawRelationalMagma</span>        : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View RawRelationalMagma</span> ;   <span style="color: #0000cd;">toRawRelationalMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>;_&#8776;_ <span style="color: #3a81c3; font-weight: bold;">=</span> _&#8776;_}
</pre>
</div>

<ul class="org-ul">
<li>Regarding the idea that <i>“each piece of mathematical knowledge should be formalized only once”,</i>
see the paper <a href="https://inf.ug.edu.pl/~schwarzw/papers/mkm2010.pdf">On Duplication in Mathematical Repositories</a>.</li>

<li>The above Lisp serves as an accessible example of extending the system by users.
<ul class="org-ul">
<li>See this <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a> to get the basics of Lisp.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgfec05d8" class="outline-3">
<h3 id="Renaming"><span class="section-number-3">2.5</span> Renaming</h3>
<div class="outline-text-3" id="text-Renaming">
<p>
From an end-user perspective, our <code>CommutativeMonoid</code> has one flaw: Such monoids are
frequently written <i>additively</i> rather than multiplicatively. Such a change can be
rendered conveniently:
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">AbealianMonoidR = CommutativeMonoidR renaming "&#183; to +"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
An Abealian monoid is <i>both</i> a commutative monoid and also, simply, a monoid.
The above declaration freely maintains these relationships: The resulting record
comes with a new projection <code>toCommutativeMonoidR</code>, and still has the inherited projection <code>toMonoidR</code>.
</p>

<p>
Since renaming and extension (including postulating) both adjoin retract morphisms, by default,
we are lead to wonder how about the result of performing these operations in sequence ‘on the fly’,
rather than naming each application. Since <code>P renaming X ⟴ postulating Y</code> comes with a retract <code>toP</code> via
the renaming and another, distinctly defined, <code>toP</code> via the postulating, we have that the operations
commute if <i>only</i> the first permits the creation of a retract. Here's a concrete example:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">IdempotentMagma  = Magma renaming "op to _&#8852;_" &#10228; postulating "_&#8852;_" "idempotent"   :adjoin-retract nil &#10228; record</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
These both elaborate to the same thing, up to order of constituents.
</p>

<p>
It is important to realise that the renaming and postulating combinators are <i>user-defined</i>, and
could have been defined without adjoining a retract by default; consequently, we would have unconditional
commutativity of these combinators. You, as the user, can make these alternative combinators as follows:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-renaming&#8242; by = renaming 'by :adjoin-retract nil</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-postulating&#8242; p bop (using) = postulating 'p 'bop :using 'using :adjoin-retract nil</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Example use: We need the &#8220;&#119985;-&#8221; in the declaration site, but not in use sites, as below.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">IdempotentMagma&#8243; = Magma postulating&#8242; "_&#8852;_" "idempotent" &#10228; renaming&#8242; "op to _&#8852;_" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Super near stuff!
</p>

<p>
Finally, renaming is an invertible operation &#x2014;ignoring the adjoined retracts,
<code>Magmaʳʳ</code> is identical to <code>Magma</code>.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Magma&#691;  = Magma  renaming "op  to bop"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Magma&#691;&#691; = Magma&#691; renaming "bop to op"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Alternatively, <code>renaming</code> has an optional argument <code>:adjoin-coretract</code> which can be provided
with <code>t</code> to use a default name or provided with a string to use a desired name for
the inverse part of a projection, <code>fromMagma</code> below.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Sequential = Magma renaming "op to _&#10814;_" :adjoin-coretract t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Sequential</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toType</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}

    <span style="color: #0000cd;">toMagma</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span>
    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>}

    <span style="color: #0000cd;">fromMagma</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> View Sequential</span>
    <span style="color: #0000cd;">fromMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">g227742</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span>.C<span style="color: #0000cd;">arrier</span> <span style="color: #0000cd;">g227742</span>;<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span>.<span style="color: #0000cd;">op</span> <span style="color: #0000cd;">g227742</span>}
</pre>
</div>
<p>
We are using gensym's for λ-arguments to avoid name clashes.
</p>
</div>
</div>

<div id="outline-container-org895ff0d" class="outline-3">
<h3 id="Union"><span class="section-number-3">2.6</span> Union (and intersection)</h3>
<div class="outline-text-3" id="text-Union">
<p>
But even with these features, given <code>GroupR</code>, we would find ourselves writing:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">CommutativeGroupR&#8320; = GroupR extended-by "comm : {x y : Carrier} &#8594;  x &#183; y  &#8801;  y &#183; x" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
This is <b>problematic</b>: We lose the <i>relationship</i> that every commutative group is a commutative monoid.
This is not an issue of erroneous hierarchical design: From <code>Monoid</code>, we could orthogonally
add a commutativity property or inverse operation; <code>CommutativeGroupR₀</code> then closes this diamond-loop
by adding both features. The simplest way to share structure is to union two presentations:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">CommutativeGroupR = GroupR union "CommutativeMonoidR" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
The resulting record, <code>CommutativeMonoidR</code>, comes with three derived <a href="#orgb32f32d">fields</a>
---<code>toMonoidR, toGroupR, toCommutativeMonoidR</code>&#x2014; that retain the results relationships
with its hierarchical construction.
</p>

<p>
This approach “works” to build a sizeable library, say of the order of 500 concepts, in
a fairly economical way [<a class='org-ref-reference' href="#tpc">tpc</a>]. The union operation is an instance of a <i>pushout</i>
operation, which consists of 5 arguments &#x2014;three objects and two morphisms&#x2014; which may
be included into the <code>union</code> operation as optional keyword arguments.
The more general notion of pushout is required if we were to combine <code>GroupR</code> with <code>AbealianMonoidR</code>,
which have non-identical syntactic copies of <code>MonoidR</code>.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Definition of union & intersection -- Ignore for now </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">find-duplicates</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">list</span><span style="color: #6c3163;">)</span>
<span style="color: #da8b55; background-color: #ecf3ec;">"Return a list that contains each element from LIST that occurs more than once.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Source: https://emacs.stackexchange.com/a/31449/10352"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--&gt;</span> <span style="color: #6c3163; font-weight: bold;">list</span>
       <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-group-by</span> #'<span style="color: #6c3163; font-weight: bold;">identity</span> it<span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-filter</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #b1951d;">(</span>ele<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">&gt;</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> ele<span style="color: #3a81c3;">)</span> 2<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> it<span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">car</span> it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defmacro</span> <span style="color: #6c3163; font-weight: bold;">alter-elements</span> <span style="color: #6c3163;">(</span>elements variational <span style="color: #ba2f59; font-weight: bold;">&amp;body</span> <span style="color: #6c3163; font-weight: bold;">rest</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Alter ELEMENTS using a given VARIATIONAL along with its arguments, REST.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   The result is a list of elements.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   This is essentially &#8220;:alter-elements&#8221; but with the ability to work on the elements</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of **any** PackageFormer by using &#8220;($&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891; pf)&#8221;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   This method is only well-defined within the RHS of a variational, or instantiation, declaration.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   E.g., use it to alter elements in an &#8220;:alter-elements&#8221; clause using a predefined variational;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   see &#119985;-union and &#119985;-intersect for sample uses.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  `<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #b1951d;">(</span>,<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> variational<span style="color: #3a81c3;">)</span> ,@rest<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> ,elements<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> <span style="color: #6c3163; font-weight: bold;">union</span> pf <span style="color: #6c3163;">(</span>renaming&#8321; <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>renaming&#8322; <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract&#8321; <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract&#8322; <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Union parent PackageFormer with given PF.</span>

<span style="color: #2d9574;">    Union the elements of the parent PackageFormer with those of</span>
<span style="color: #2d9574;">    the provided PF, then adorn the result with two views:</span>
<span style="color: #2d9574;">    One to the parent and one to the provided PF.</span>

<span style="color: #2d9574;">    If an identifer is shared but has different types, then crash.</span>

<span style="color: #2d9574;">    ADJOIN-RETRACT&#7522;, for i : 1..2, are the optional names of the resulting morphisms.</span>
<span style="color: #2d9574;">    Provide nil if you do not want the morphisms adjoined.</span>
<span style="color: #2d9574;">    "</span>
   <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594;
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>es&#8321; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> es renaming renaming&#8321; <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
            <span style="color: #b1951d;">(</span>es&#8322; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891;</span> pf<span style="color: #6c3163;">)</span> renaming renaming&#8322; <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
            <span style="color: #b1951d;">(</span>es&#8242; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> es&#8321; es&#8322;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure no name clashes!</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for n in <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">find-duplicates</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> es&#8242;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
            for e <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> n <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> es&#8242;<span style="color: #b1951d;">)</span>
            <span style="color: #6c3163; font-weight: bold;">unless</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--all-p</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> e<span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span> e<span style="color: #b1951d;">)</span>
            <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #3a81c3;">[</span><span style="color: #715ab1;">debug-on-error</span> nil<span style="color: #3a81c3;">]</span>
              <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"%s = %s union %s \n\n\t\t &#10153; Error: Elements &#8220;%s&#8221; conflict!\n\n\t\t\t%s"</span>
                     $&#119899;&#119886;&#119898;&#119890; $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; pf <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n\t\t\t"</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">show-element</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return value</span>
   <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span>
       es&#8242;
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract&#8321; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; es <span style="color: #3a81c3;">:new</span> es&#8321; <span style="color: #3a81c3;">:name</span> adjoin-retract&#8321;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract&#8322; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> pf     <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891;</span> pf<span style="color: #2d9574;">)</span> <span style="color: #3a81c3;">:new</span> es&#8322; <span style="color: #3a81c3;">:name</span> adjoin-retract&#8322;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> intersect pf <span style="color: #6c3163;">(</span>adjoin-retract&#8321; <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract&#8322; <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>renaming&#8321; <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>renaming&#8322; <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Intersect parent PackageFormer with given PF.</span>

<span style="color: #2d9574;">  &#8220;pf&#8321; intersect pf&#8322; :renaming&#8321; f :renaming&#8322; g&#8221;  &#8773;  f(pf&#8321;) &#8745; g(pf&#8322;)</span>

<span style="color: #2d9574;">  This is essentially the pullback:</span>
<span style="color: #2d9574;">  { (x, y) &#8712; pf&#8321; &#215; pf&#8322; &#10073; f x = g y }.</span>

<span style="color: #2d9574;">  Intersect the elements of the parent PackageFormer with those of</span>
<span style="color: #2d9574;">  the provided PF, then adorn the result with two views</span>
<span style="color: #2d9574;">  from the result PackageFormer to the input PackageFormers.</span>

<span style="color: #2d9574;">  ADJOIN-RETRACT&#7522;, for i : 1..2, are the optional names of the resulting morphisms.</span>
<span style="color: #2d9574;">  Provide nil if you do not want the morphisms adjoined.</span>
<span style="color: #2d9574;">  "</span>
 <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594;
   <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>es&#8321; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> es renaming renaming&#8321; <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
          <span style="color: #b1951d;">(</span>es&#8322; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891;</span> pf<span style="color: #6c3163;">)</span> renaming renaming&#8322; <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
          <span style="color: #b1951d;">(</span>es&#8242;      <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">intersection</span>
                               <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--reject</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">element-contains</span> <span style="color: #2d9574;">"View"</span> it<span style="color: #887070;">)</span> es&#8321;<span style="color: #2d9574;">)</span> es&#8322;
                               <span style="color: #3a81c3;">:key</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #3a81c3;">:test</span> #'<span style="color: #6c3163; font-weight: bold;">string-equal</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">names not mentioned in the intersection.</span>
          <span style="color: #b1951d;">(</span>dangling <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">set-difference</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> es&#8321; es&#8322;<span style="color: #6c3163;">)</span> es&#8242;
                      <span style="color: #3a81c3;">:key</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #3a81c3;">:test</span> #'<span style="color: #6c3163; font-weight: bold;">string-equal</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">drop the dangling names</span>
  <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> es&#8242; <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">-reject</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-some</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> d &#8594; <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">element-contains</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> d<span style="color: #3a81c3;">)</span> e<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> dangling<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> es&#8242;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get old names so as to adjoin the co-retracts; i.e., the projections with renaming.</span>
  <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> es&#8321; <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> es&#8242; rename <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> renaming&#8321; <span style="color: #3a81c3;">:inverse</span> <span style="color: #715ab1;">t</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
  <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> es&#8322; <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">alter-elements</span> es&#8242; rename <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> renaming&#8322; <span style="color: #3a81c3;">:inverse</span> <span style="color: #715ab1;">t</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:adjoin-retract</span> nil<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

   <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span>
       es&#8242;
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract&#8321; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; es&#8242; <span style="color: #3a81c3;">:new</span> es&#8321; <span style="color: #3a81c3;">:name</span> adjoin-retract&#8321; <span style="color: #3a81c3;">:contravariant</span> <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract&#8322; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> pf    es&#8242; <span style="color: #3a81c3;">:new</span> es&#8322; <span style="color: #3a81c3;">:name</span> adjoin-retract&#8322; <span style="color: #3a81c3;">:contravariant</span> <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
The pushout of \(f : X → A\) and \(g : X → B\) is, essentially, the disjoint sum of \(A\) and \(B\) where embedded elements
are considered ‘indistinguishable’ when the share the same origin in \(X\) via the paths \(f\) and \(g\).
Unfortunately, the resulting ‘indistinguishable’ elements are actually distinguishable: They may be the <i>A</i>-name or the <i>B</i>-name
and a choice must be made as to which name is preferred since users actually want to refer to them later on.
Hence, to be useful for library construction, the pushout construction actually requires at least another input function
that provides canonical names to the supposedly ‘indistinguishable’ elements.
</p>

<p>
Since a <code>PackageFormer</code> is essentially just a <i>signature</i> &#x2014;a collection of typed names&#x2014;, we can make a ‘partial choice of
pushout’ to reduce the number of arguments from 6 to 4 by letting the typed-names object \(X\) be ‘inferred’ and encoding
the canonical names function into the operations \(f\) and \(g\).
The inputs functions \(f, g\) are necessarily <i>signature morphisms</i> &#x2014;mappings of names that preserve types&#x2014; and
so are simply lists associating names of \(X\) to names of \(A\) and \(B\). If we instead consider \(f′ : X′ ← A\) and
\(g′ : X′ ← B\), in the <i>opposite direction</i>, then we may reconstruct a pushout by
setting \(X\) to be common image of \(f′, g′\), and set \(f, g\) to be inclusions
In-particular, the full identity of \(X′\) is not necessarily relevant for
the pushout reconstruction and so it may be omitted. Moreover, the issue of canonical names is resolved:
If \(a ∈ A\) is intended to be identified with \(b ∈ B\) such that the resulting element has \(c\) as the chosen
canonical name, then we simply require \(f′\, a = c = g′ \, b\).
</p>

<p>
At first, a pushout construction needs 5 inputs, to be practical it further needs a function for canonical names
for a total of 6 inputs. However, a pushout of \(f : X → A\) and \(g : X → B\) is intended to be the ‘smallest object \(P\)
that contains a copy of \(A\) and of \(B\) sharing the common substructure \(X\)’, and as such it outputs two functions
\(inj₁ : A → P,\, inj₂ : B → P\) that inject the names of \(A\) and \(B\) into \(P\).
If we realise \(P\) as a record &#x2014;a type of models&#x2014; then the embedding functions are <i>reversed</i>, to obtain
projections \(P → A\) and \(P → B\): If we have a model of \(P\), then we can forget some structure and rename
via \(f\) and \(g\) to obtain models of \(A\) and \(B\).
For the resulting construction to be useful, these names could be automated such as \(toA : P → A\) and \(toB : P → B\)
but such a naming scheme does not scale &#x2014;but we shall use it for default names. As such, we need two more inputs
to the pushout construction so the names of the resulting output functions can be used later on.
<i>Hence, a practical choice of pushout needs 8 inputs!</i>
</p>

<p>
Using the above issue to reverse the directions of \(f, g\) via \(f′, g′\), we can infer the shared structure \(X\)
and the canonical name function. Likewise, by using \(toChild : P → Child\) default-naming scheme, we may omit
the names of the retract functions. If we wish to rename these retracts or simply omit them altogether,
we make the <i>optional</i> arguments: Provide <code>:adjoin-retractᵢ "new-function-name"</code> to use a new name, or <code>nil</code> instead
of a string to omit the retract. Here are some examples of this construction of mine.
</p>

<p>
Here we provide all arguments, optional and otherwise.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">TwoBinaryOps = Magma union "Magma" :renaming&#8321; "op to _+_" :renaming&#8322; "op to _&#215;_"  :adjoin-retract&#8321; "left" :adjoin-retract&#8322; "right"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> TwoBinaryOps</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _+_     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toType</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}

    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">left</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View</span> <span style="color: #ba2f59; font-weight: bold;">Magma</span>
    <span style="color: #0000cd;">left</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _+_}

    <span style="color: #0000cd;">right</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View</span> <span style="color: #ba2f59; font-weight: bold;">Magma</span>
    <span style="color: #0000cd;">right</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _&#215;_}
</pre>
</div>

<p>
The next example is one of the reasons the construction is named ‘union’ instead of ‘pushout’:
It's idempotent, if we ignore the addition of the retract.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MagmaAgain   = Magma union "Magma"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MagmaAgain</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toType</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}

    <span style="color: #0000cd;">toMagma</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span>
    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>}
</pre>
</div>

<p>
We may perform disjoint sums &#x2014;simply distinguish all the names of one of the input objects.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Magma&#8242;    = Magma primed</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">SumMagmas = Magma union "Magma&#8242;" :adjoin-retract&#8321; nil &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> SumMagmas</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toType</span>         : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}

    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">op</span>&#8242;      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242;

    <span style="color: #0000cd;">toType</span>&#8242; : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242;}

    <span style="color: #0000cd;">toMagma</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span>
    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242;;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>&#8242;}

    <span style="color: #0000cd;">toMagma</span>&#8242; : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span>&#8242;
    <span style="color: #0000cd;">toMagma</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242;;<span style="color: #0000cd;">op</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">op</span>&#8242;}
</pre>
</div>

<p>
A common scenario is extending a structure, say <code>Magma</code>, into orthogonal directions, such as by making
it operation associative or idempotent, then closing the resulting diamond by combining them, to obtain
a semilattice. However, the orthogonal extensions may involve different names and so the resulting
semilattice presentation can only be formed via pushout; below are three ways to form it.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Semigroup    = Magma postulating "op" "associative" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">IdempotentMagma = Magma renaming "op to _&#8852;_" &#10228; postulating "_&#8852;_" "idempotent"  :adjoin-retract nil &#10228; record</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#8852;-SemiLattice      = Semigroup union "IdempotentMagma" :renaming&#8321; "op to _&#8852;_" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">op-SemiLattice     = Semigroup union "IdempotentMagma" :renaming&#8322; "_&#8852;_ to op" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#8593;-SemiLattice      = Semigroup union "IdempotentMagma" :renaming&#8321; "op to _&#8593;_" :renaming&#8322; "_&#8852;_ to _&#8593;_" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Let's close with the classic example of forming a ring structure by combining two monoidal structures.
This example also serves to further showcasing how using <code>𝒱-postulating</code> can make for more granular, modular, developments.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Additive           = Magma renaming "op to _+_" &#10228; postulating "_+_" "commutative"  :adjoin-retract nil &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Multiplicative     = Magma renaming "op to _&#215;_" :adjoin-retract nil &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">AddMult            = Additive union "Multiplicative" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">AlmostNearSemiRing = AddMult &#10228; postulating "_&#215;_" "distributive&#737;" :using "_+_" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> AlmostNearSemiRing</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _+_     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toType</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Type</span>
    <span style="color: #0000cd;">toType</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}

    <span style="color: #0000cd;">toMagma</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Magma</span>
    <span style="color: #0000cd;">toMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #0000cd;">op</span> <span style="color: #3a81c3; font-weight: bold;">=</span> _+_}

    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">comm</span>       : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>   &#8594; _+_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> &#8801; _+_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>

    <span style="color: #0000cd;">toAdditive</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Additive</span>
    <span style="color: #0000cd;">toAdditive</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;_+_ <span style="color: #3a81c3; font-weight: bold;">=</span> _+_;<span style="color: #0000cd;">comm</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">comm</span>}

    <span style="color: #0000cd;">toMultiplicative</span> : <span style="color: #3a81c3; font-weight: bold;">let</span><span style="color: #ba2f59; font-weight: bold;"> View X</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> X</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> View Multiplicative</span>
    <span style="color: #0000cd;">toMultiplicative</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">record</span> {C<span style="color: #0000cd;">arrier</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;_&#215;_ <span style="color: #3a81c3; font-weight: bold;">=</span> _&#215;_}

    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">dist</span>&#737;      : &#8704; <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span> &#8594; _&#215;_ <span style="color: #0000cd;">x</span> (_+_ <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>) &#8801; _+_ (_&#215;_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>) (_&#215;_ <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
Following the reasoning for pushouts, we implement pullbacks in the same way with the same optional arguments.
Here's an example use:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Just-Carrier    = Additive intersect "Multiplicative"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Magma-yet-again = Additive intersect "Multiplicative" :renaming&#8321; "_+_ to op" :renaming&#8322; "_&#215;_ to op"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Moreover the absorptive law \(X ∩ (X ∪ Z) = X\) also holds for these operations:
<code>Additive intersect "AddMult"</code> is just <code>Additive</code>, when we ignore all adjoined retracts.
</p>
</div>
</div>

<div id="outline-container-org35d23cc" class="outline-3">
<h3 id="Duality"><span class="section-number-3">2.7</span> Duality</h3>
<div class="outline-text-3" id="text-Duality">
<p>
Maps between grouping mechanisms are sometimes called <i>views</i>, which are essentially an internalisation of
of the <i>variationals</i> in our system. Let's demonstrate an example of how dual concepts are
captured concretely in the system.
</p>

<p>
For example, the dual, or opposite, of a binary operation \(_·_\) is the operation \(_·ᵒᵖ_\)
defined by \(x ·ᵒᵖ y ≔ y · x\).
Classically in Agda, duality is utilised as follows:
</p>
<ol class="org-ol">
<li>Define a module <code>R _·_</code> for the desired concepts.</li>
<li><p>
Define a shallow module <code>Rᵒᵖ _·_</code> that opens <code>R _·ᵒᵖ_</code> and renames the concepts in <code>R</code>
by the dual names.
</p>

<p>
The RATH-Agda library performs essentially this approach, for example for obtaining <code>UpperBounds</code>
from <code>LowerBounds</code> in the context of a poset.
</p></li>
</ol>

<p>
Unfortunately, this means that any record definitions in <code>R</code> must have its field names be
sufficiently generic to play <i>both</i> roles as the original and the dual concept.
Admittedly, RATH-Agda's names are well-chosen; e.g., <code>value, boundᵢ, universal</code>
to denote a value that is a lower/upper bound of two given elements, satisfying
a lub/glb universal property. However, well-chosen names come at an upfront cost:
One must take care to provide sufficiently generic names and account for duality
at the outset, irrespective of whether one <i>currently</i> cares about the dual or not; otherwise
when the dual is later formalised, then the names of the original concept must be refactored
throughout a library and its users.
</p>

<p>
Consider the following heterogeneous algebra.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer LeftUnitalAction : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  Scalar : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  Vector : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  _&#183;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  &#120793;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  leftId  : {x : Vector} &#8594; &#120793; &#183; x &#8801; x</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Let's reify this as a valid Agda record declaration</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">LeftUnitalActionR  = LeftUnitalAction &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Informally, one now ‘defines’ a right unital action by duality, flipping the binary operation
and renaming <code>leftId</code> to be <code>rightId</code>. Such informal parlance is in-fact nearly formally, as the following:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">RightUnitalActionR = LeftUnitalActionR flipping "_&#183;_" :renaming "leftId to rightId" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Of-course the resulting representation is semantically identical to the previous one, and so it is
furnished with a <code>to⋯</code> mapping:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #0000cd;">forget</span> :<span style="color: #ba2f59; font-weight: bold;"> RightUnitalActionR</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LeftUnitalActionR</span>
<span style="color: #0000cd;">forget</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> RightUnitalActionR</span>.<span style="color: #0000cd;">toLeftUnitalActionR</span>
</pre>
</div>

<p>
Likewise for the RATH-Agda library's example from above, to define semi-lattice structures by duality:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Product</span> <span style="color: #3a81c3; font-weight: bold;">using</span> (_&#215;_)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer JoinSemiLattice : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  _&#8849;_     : Carrier &#8594; Carrier &#8594; Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  refl    : &#8704; {x} &#8594; x &#8849; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  trans   : &#8704; {x y z} &#8594; x &#8849; y &#8594; y &#8849; z &#8594; x &#8849; z</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  antisym : &#8704; {x y} &#8594; x &#8849; y &#8594; y &#8849; x &#8594; x &#8801; y</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  _&#8852;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  &#8852;-lub   : &#8704; {x y z} &#8594; x &#8849; z &#8594; y &#8849; z &#8594; (x &#8852; y) &#8849; z</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  &#8852;-lub&#728;  : &#8704; {x y z}  &#8594; (x &#8852; y) &#8849; z  &#8594; x &#8849; z &#215; y &#8849; z</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">JoinSemiLatticeR = JoinSemiLattice record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MeetSemiLatticeR = JoinSemiLatticeR flipping "_&#8849;_" :renaming "&#8852; to &#8851;; &#8852;-lub to &#8851;-glb"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
In this example, besides the map from meet semi-lattices to join semi-lattices, the types of
the dualised names, such as <code>⊓-glb</code>, are what one would expect were the definition written out explicitly:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">woah</span><span style="color: #ba2f59; font-weight: bold;"> (M</span> :<span style="color: #ba2f59; font-weight: bold;"> MeetSemiLatticeR</span>) <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #ba2f59; font-weight: bold;">MeetSemiLatticeR M</span>

  <span style="color: #0000cd;">nifty</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; <span style="color: #0000cd;">z</span> &#8849; <span style="color: #0000cd;">x</span> &#8594; <span style="color: #0000cd;">z</span> &#8849; <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">z</span> &#8849; (<span style="color: #0000cd;">x</span> &#8851; <span style="color: #0000cd;">y</span>)
  <span style="color: #0000cd;">nifty</span> <span style="color: #3a81c3; font-weight: bold;">=</span> &#8851;-<span style="color: #0000cd;">glb</span>

  _ : <span style="color: #3a81c3; font-weight: bold;">let</span> _&#8850;_ <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">y</span> &#8849; <span style="color: #0000cd;">x</span>
      <span style="color: #3a81c3; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; <span style="color: #0000cd;">x</span> &#8850; <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">y</span> &#8850; <span style="color: #0000cd;">z</span> &#8594; <span style="color: #0000cd;">x</span> &#8850; <span style="color: #0000cd;">z</span>
  _ <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">trans</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Definition of flipping -- Feel free to ignore until later </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">flip-type</span> <span style="color: #6c3163;">(</span>&#964;<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given a binary operation's type, as a string, flip the first two types.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">E.g., &#8220;A &#8594; B &#8594; C&#8221; becomes &#8220;B &#8594; A &#8594; C&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>ts <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"&#8594;"</span> &#964;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" &#8594; "</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 1 ts<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 0 ts<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 2 ts<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">flip</span> <span style="color: #6c3163;">(</span>name op<span style="color: #6c3163;">)</span>
 <span style="color: #da8b55; background-color: #ecf3ec;">"If element OP is named NAME, then flip its type; else leave it alone-ish.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">If OP mentions NAME, then prefix its type with</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&#8220;let NAME = &#955; x y &#8594; NAME y x in&#8221;, which results in valid Agda</span>
<span style="color: #da8b55; background-color: #ecf3ec;">due to its identifier scoping rules.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">"</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">cond</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> name <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> op<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">map-type</span> #'<span style="color: #6c3163; font-weight: bold;">flip-type</span> op<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">element-contains</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">""</span> name<span style="color: #b1951d;">)</span> op<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #b1951d;">[</span>letin <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"let %s = &#955; x y &#8594; %s y x in "</span> name name<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">]</span>
                 <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> op
                   <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">map-type</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> &#964; &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> letin &#964;<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                   <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">map-equations</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> eqs &#8594; <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #3a81c3;">[</span>ps <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"="</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">]</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = %s %s"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> ps<span style="color: #6c3163;">)</span> letin <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"="</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> ps<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> eqs<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span><span style="color: #715ab1;">t</span> op<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> flipping name <span style="color: #6c3163;">(</span>renaming <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Flip a single binary operation, or predicate, NAME.</span>

<span style="color: #2d9574;">    Dual constructs usual require some identifiers to be renamed,</span>
<span style="color: #2d9574;">    and these may be supplied as a &#8220;;&#8221;-separated &#8220;to&#8221;-separated string list, RENAMING.</span>

<span style="color: #2d9574;">    There is no support for underscores; mixfix names must be given properly.</span>
<span style="color: #2d9574;">  "</span>
    renaming 'renaming <span style="color: #3a81c3;">:adjoin-retract</span> nil
 &#10228; <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594;
                      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>es&#8242; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">flip</span> name it<span style="color: #6c3163;">)</span> es<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> es&#8242; <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">flip</span> name <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891;</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #2d9574;">)</span> <span style="color: #3a81c3;">:new</span> es&#8242;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org0391acc" class="outline-3">
<h3 id="Extracting-Little-Theories"><span class="section-number-3">2.8</span> Extracting Little Theories</h3>
<div class="outline-text-3" id="text-Extracting-Little-Theories">
<p>
The <code>extended-by</code> variational allows Agda users to easily employ the <i>tiny theories</i> [<a class='org-ref-reference' href="#little_theories">little_theories</a>][mathscheme]
approach to library design: New structures are built from old ones by augmenting one concept at a time,
then one uses mixins such as <code>union</code>, below, to obtain a complex structure.
This approach lets us write a program, or proof, in a context that only
provides what is <i>necessary</i> for that program-proof and nothing more.
In this way, we obtain <i>maximal generality</i> for re-use!
This approach can be construed as <i>The Interface Segregation Principle [design-patterns-solid]:
/No client should be forced to depend on methods it does not use.</i>
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer Empty : Set&#8321; where </span><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> No</span> <span style="color: #0000cd;">elements</span> -}
T<span style="color: #0000cd;">ype</span>  <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Empty</span> <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"Carrier : Set"</span>
M<span style="color: #0000cd;">agma</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Type</span>  <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"_&#183;_ : Carrier &#8594; Carrier &#8594; Carrier"</span>
C<span style="color: #0000cd;">ommutativeMagma</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Magma</span> <span style="color: #0000cd;">extended-by</span> <span style="color: #2d9574;">"comm : {x y : Carrier} &#8594;  x &#183; y  &#8801;  y &#183; x"</span>
-}
</pre>
</div>

<p>
The cool thing here is that <code>CommutativeMagma</code> comes with <code>toMagma, toType,</code> and <code>toEmpty</code>.
</p>

<p>
However, life is messy and sometimes one may hurriedly create a structure,
then later realise that they are being forced to depend on unused methods.
Rather than throw an ‘not implemented’ exception or leave them undefined,
we may use the <code>keeping</code> variational to extract the smallest well-formed
sub-PackageFormer that mentions a given list of identifiers.
</p>

<p>
For example, suppose we quickly formed <code>Monoid</code>, from earlier, but later wished
to utilise other substrata. This is easily achieved with the following declarations.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Empty&#8242;        = Monoid keeping ""</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Type&#8242;         = Monoid keeping "Carrier"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Magma&#8242;        = Monoid keeping "_&#183;_"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Semigroup&#8242;    = Monoid keeping "assoc"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PointedMagma&#8242; = Monoid keeping "&#120128;; _&#183;_"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- &#8618; Carrier; _&#183;_; &#120128;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Even better, we may go about deriving results &#x2014;such as theorems or algorithms&#x2014;
in familiar settings, such as <code>Monoid</code>, only to realise that they are more expressive
than necessary. Such an observation no longer need to be found by inspection, instead
it may be derived mechanically.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">LeftUnitalMagma = Monoid keeping "&#120128;-unique" &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
This expands to the following theory, minimal enough to derive <code>𝕀-unique</code>.
</p>
<div class="org-src-container">
<pre class="src src-agda-results">record LeftUnitalMagma : Set₁ where

   field
     Carrier : Set
     _·_     : Carrier → Carrier → Carrier
     𝕀       : Carrier
     leftId  : {x : Carrier} → 𝕀 · x  ≡ x

   𝕀-unique     : ∀ {e} (lid : ∀ {x} → e · x ≡ x) (rid : ∀ {x} → x · e ≡ x) → e ≡ 𝕀
   𝕀-unique lid rid = ≡.trans (≡.sym leftId) rid
</pre>
</div>

<p>
Surprisingly, in some sense, <code>keeping</code> let's us apply the interface segregation principle,
or ‘little theories’, after the fact.
</p>
</div>
</div>

<div id="outline-container-orga7729a3" class="outline-3">
<h3 id="Summary-of-Sample-Variationals-Provided-With-The-System"><span class="section-number-3">2.9</span> Summary of Sample Variationals Provided With The System</h3>
<div class="outline-text-3" id="text-Summary-of-Sample-Variationals-Provided-With-The-System">
<p>
Below are some variationals that can be used immediately by a user &#x2014;no Lisp knowledge required.
If you simply mention one of them in a comment, then load the file with <code>C-c C-l</code>, then you may hover
over them to see their full documentation. You may also look at the second part of the user manual
below to see accompanying examples.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><span class="underline">Name</span></td>
<td class="org-left"><span class="underline">Description</span></td>
</tr>

<tr>
<td class="org-left"><code>record</code></td>
<td class="org-left">Reify a PackageFormer as a valid Agda record.</td>
</tr>

<tr>
<td class="org-left"><code>extended-by</code></td>
<td class="org-left">⊙ Extend a PackageFormer by a string-“;”-list of declaration.</td>
</tr>

<tr>
<td class="org-left"><code>keeping</code></td>
<td class="org-left">★ Largest well-formed PackageFormer consisting of a given list of elements.</td>
</tr>

<tr>
<td class="org-left"><code>union</code></td>
<td class="org-left">⊙ Union two PackageFormers into a new one, maintaining relationships.</td>
</tr>

<tr>
<td class="org-left"><code>flipping</code></td>
<td class="org-left">⊙ Dualise a binary operation or predicate.</td>
</tr>

<tr>
<td class="org-left"><code>unbundling</code></td>
<td class="org-left">Consider the first <i>N</i> elements, which may have definitions, as <a href="#orged238e3">parameters</a>.</td>
</tr>

<tr>
<td class="org-left"><code>data</code></td>
<td class="org-left">Reify a PackageFormer as a valid Agda algebraic data type.</td>
</tr>

<tr>
<td class="org-left"><code>open</code></td>
<td class="org-left">Reify a given PackageFormer as a parameterised Agda “module” declaration.</td>
</tr>

<tr>
<td class="org-left"><code>opening</code></td>
<td class="org-left">★ Open a record as a module exposing only the given names.</td>
</tr>

<tr>
<td class="org-left"><code>open-with-decoration</code></td>
<td class="org-left">Open a record, exposing all elements, with a given decoration.</td>
</tr>

<tr>
<td class="org-left"><code>sorts</code></td>
<td class="org-left">Keep only the types declared in a grouping mechanism.</td>
</tr>

<tr>
<td class="org-left"><code>signature</code></td>
<td class="org-left">Keep only the elements that target a sort, drop all else.</td>
</tr>

<tr>
<td class="org-left"><code>rename</code></td>
<td class="org-left">⊙ Apply a <code>Name → Name</code> function to the elements of a PackageFormer.</td>
</tr>

<tr>
<td class="org-left"><code>renaming</code></td>
<td class="org-left">⊙ ★ Rename elements using a list of “to”-separated pairs.</td>
</tr>

<tr>
<td class="org-left"><code>decorated</code></td>
<td class="org-left">⊙ Append all element names by a given string.</td>
</tr>

<tr>
<td class="org-left"><code>codecorated</code></td>
<td class="org-left">⊙ Prepend all element names by a given string.</td>
</tr>

<tr>
<td class="org-left"><code>primed</code></td>
<td class="org-left">⊙ Prime all element names.</td>
</tr>

<tr>
<td class="org-left"><code>subscriptedᵢ</code></td>
<td class="org-left">⊙ Append all element names by subscript <code>i : 0..9</code>.</td>
</tr>

<tr>
<td class="org-left"><code>hom</code></td>
<td class="org-left">Formulate the notion of homomorphism of parent PackageFormer algebras.</td>
</tr>
</tbody>
</table>

<dl class="org-dl">
<dt>★</dt><dd>Argument is a string of “;”-separated items consisting of “to”-separated pairs.

<ul class="org-ul">
<li><code>keeping</code> has input being “;”-separated string of proper names only.</li>
</ul></dd>

<dt>⊙</dt><dd>The resulting PackageFormer is furnished with an element <code>toP : P; to P = record {oldᵢ = newᵢ}</code>
where <code>P</code> is the name of the parent, or source, PackageFormer. This element provides a way to
view the resulting child presentation as an instance of the original presentation.

<ul class="org-ul">
<li>If we dislike the <code>toP</code> naming, we can simply invoke <code>renaming</code>.</li>

<li>Sometimes these ‘maps’ are invertible; we leave it as an exercise to the interested reader
to formulate <code>toP⁻¹</code> in the variationals, when possible.</li>

<li>Invoke a variational with <code>:adjoin-retract nil</code> if you do not want this map to be added;
or use <code>t</code> in-place of <code>nil</code> if you insist on it being added.</li>
</ul></dd>
</dl>

<p>
Below are the <b>five meta-primitives</b> from which all variationals are borne, followed by a few others
that are useful for extending the system by making your own grouping mechanisms and operations on them.
Using these requires a small amount of Lisp, which is tersely reviewed in the second part of the user
manual, below.
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><span class="underline">Name</span></td>
<td class="org-left"><span class="underline">Description</span></td>
</tr>

<tr>
<td class="org-left"><code>:waist</code></td>
<td class="org-left">Consider the first <i>N</i> elements as, possibly ill-formed, <a href="#orged238e3">parameters</a>.</td>
</tr>

<tr>
<td class="org-left"><code>:kind</code></td>
<td class="org-left">Valid Agda grouping mechanisms: <code>record, data, module</code>.</td>
</tr>

<tr>
<td class="org-left"><code>:level</code></td>
<td class="org-left">The Agda level of a PackageFormer.</td>
</tr>

<tr>
<td class="org-left"><code>:alter-elements</code></td>
<td class="org-left">Apply a <code>List Element → List Element</code> function over a PackageFormer.</td>
</tr>

<tr>
<td class="org-left"><code>⟴</code></td>
<td class="org-left">Compose two variational clauses in left-to-right sequence.</td>
</tr>

<tr>
<td class="org-left"><code>map</code></td>
<td class="org-left">⊙ Map a <code>Element → Element</code> function over a PackageFormer.</td>
</tr>

<tr>
<td class="org-left"><code>generated</code></td>
<td class="org-left">Keep the sub-PackageFormer whose elements satisfy a given predicate.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org3883711" class="outline-2">
<h2 id="User-Manual-II--Extending-the-System"><span class="section-number-2">3</span> User Manual II: Extending the System</h2>
<div class="outline-text-2" id="text-User-Manual-II--Extending-the-System">
<p>
Herein we demonstrate how with a little bit of Lisp, one may create any desired form of
grouping mechanism as well as operation between groupings.
</p>

<p>
We begin with a brief review of Lisp basics such as list operations then immediately dive into
creating an Agda module that contains our new user-defined constructs, within <a href="#org81f2700">700-comments</a>.
</p>
</div>



<div id="outline-container-org1648e31" class="outline-3">
<h3 id="Lisp-Interface"><span class="section-number-3">3.1</span> Lisp Interface</h3>
<div class="outline-text-3" id="text-Lisp-Interface">
<p>
<center><em> Summary of useful functions for programming variationals. </center></em>
</p>

<ul class="org-ul">
<li>A <code>PackageFormer</code> is nothing more than a list of elements.</li>
<li>An <code>element</code> is a record of 4 items: A qualifier, a name, a type, and
a list of equational clauses for that name.</li>
</ul>

<p>
Below are functions that will be used in subsequent subsections in order to form user-defined
variationals. Consult these tables as necessary and look at an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>, if need be.
</p>

<ul class="org-ul">
<li><p>
<b>Elements</b>
</p>

<p>
Let ℰ denote one of <code>qualifier, name, type, equations</code> in the following list of useful functions.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(make-element 𝓆 𝓃 𝓉 ℯ)</code></td>
<td class="org-left">An <code>element</code> value is formed.</td>
</tr>

<tr>
<td class="org-left"><code>(element-ℰ e)</code></td>
<td class="org-left">Project component ℰ from element <code>e</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(map-ℰ f e)</code></td>
<td class="org-left">Return a copy of <code>e</code> with component ℰ updated by function <code>f</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(element-replace old new e)</code></td>
<td class="org-left">Replace all string occurances of <code>old</code> by <code>new</code> in element <code>e</code>.</td>
</tr>
</tbody>
</table></li>

<li><p>
<b>Lists</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(list x₀ … xₙ)</code></td>
<td class="org-left">Form a list of elements <code>xᵢ</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(car xs)</code></td>
<td class="org-left">Obtain first element of list <code>xs</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(cdr xs)</code></td>
<td class="org-left">Obtain all but first element of <code>xs</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(cons x xs)</code></td>
<td class="org-left">Form a new list with car <code>x</code> and cdr <code>xs</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(mapcar (λ it → ⋯it⋯) xs)</code></td>
<td class="org-left">Map the given function on <code>xs.</code></td>
</tr>

<tr>
<td class="org-left"><code>(--map (⋯it⋯) xs)</code></td>
<td class="org-left">Map the <i>implicit</i> function <code>(λ it → ⋯it⋯)</code> on <code>xs</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(-cons* x₀ … xₙ xs)</code></td>
<td class="org-left"><code>(cons x₀ (cons x₁ (⋯ (cons xₙ xs))))</code>.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>

<li><p>
<b>Strings</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(concat s₀ … sₙ)</code></td>
<td class="org-left">Concatenate strings <code>sᵢ</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(s-replace old new s)</code></td>
<td class="org-left">Replace all string occurrences of <code>old</code> by <code>new</code> in string <code>e</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(rename-mixfix f op)</code></td>
<td class="org-left">Rename string <code>op</code> according to function <code>f</code> by ‘leaping over’ underscores.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">E.g., <code>f, op = (λ x → (concat x "′")), _⊕_  ⇒ _⊕′_</code>.</td>
</tr>
</tbody>
</table></li>
</ul>

<p>
<center><em> <b>You can always see the documentation of an item with <code>C-h o</code>!</b> </center></em>
</p>
</div>
</div>

<div id="outline-container-org6e0401a" class="outline-3">
<h3 id="User-Manual-Header"><span class="section-number-3">3.2</span> User Manual Header</h3>
<div class="outline-text-3" id="text-User-Manual-Header">
<p>
<center><em> A literate programming approach to a user manual. </center></em>
</p>

<p>
In order for our manual's examples to be up-to-date, we will take a literate approach
to producing them. Namely, the Agda code here is ‘tangled’ from this prose into an Agda
file which can then be checked by an Agda process. Whence, this file is the de-facto source.
</p>

<p>
Let's start-off with a usual Agda header:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This loads the PackageFormer metaprogram; press C-x C-e after the closing &#8220;)&#8221; below.                 -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span> (<span style="color: #0000cd;">progn</span> (<span style="color: #0000cd;">load-file</span> <span style="color: #2d9574;">"~/.emacs.d/agda-next-700-module-systems.el"</span>) (<span style="color: #0000cd;">agda-next-700-module-systems-mode</span>)) -}

<span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">package-former</span> <span style="color: #3a81c3; font-weight: bold;">where</span>

<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">package-former-generated</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #3a81c3; font-weight: bold;">open</span> <span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.List</span> <span style="color: #3a81c3; font-weight: bold;">using</span><span style="color: #ba2f59; font-weight: bold;"> (List</span>; _&#8759;_; []; <span style="color: #0000cd;">foldr</span>)
<span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span><span style="color: #715ab1;"> as</span> &#8801;; <span style="color: #3a81c3; font-weight: bold;">open</span> &#8801; <span style="color: #3a81c3; font-weight: bold;">using</span> (_&#8801;_)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's ensure content of User Manual part I actually type checkes -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Feel</span> <span style="color: #0000cd;">free</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">comment</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">line</span> <span style="color: #0000cd;">out</span>. -}
<span style="color: #3a81c3; font-weight: bold;">import</span> <span style="color: #a020f0;">package-former-user-manual-i</span>
</pre>
</div>

<p>
To make the resulting Agda file somewhat self-contained, in case anyone wishes to read that
or load it into Agda and play with it, let's add a blurb.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">0. There are a number of common use-cases.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">1. We can handle all of them &amp; more, since we're extensible.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  - Mention the Lean &amp; Coq, as well as the Agda, repeated fragments.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">2. The resulting setup is pragmatic: It is unobtrusive in the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   traditional Agda coding style in that it happens in the background.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">3. It fills a particular need; the desire to avoid repetitious code.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Before getting to the meat of things, it is important to note that comments
begun with <code>{-</code> <i>and</i> followed by a space are treated as usual Agda comments,
whereas those <i>without</i> a following space such as <code>{-700</code> and <code>{-lisp</code> are picked-up
by our meta-program.
</p>

<p>
For example, having no space between “{-” and “lisp” would cause the following block to be executed
as a Lisp form.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box "Hello")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box "World")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Alternatively, here is the PackageFormer for M-Sets from the introduction.
It is a useful example since it is multi-sorted.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Let us also introduce a slightly more syntactically-involved example:
<b>A PackageFormer with equations.</b> The equations, <i>depending on our perspective,</i>
&#x2014;i.e., the variational invoked&#x2014; may be thought of as:
</p>
<ul class="org-ul">
<li>Derived elements; e.g., in a record, they are a definitional extension
and for an ADT, they are methods defined on the constructors.</li>
<li>Coherence <a href="#org83c5020">constraints</a>; e.g., in a record, we may interpret an equation <code>𝓁 = 𝓇</code>
as an additional axiom <code>∀ {⋯} → ℓ ≡ 𝓇</code> &#x2014;e.g., when a user may supply an efficient definition
of <code>𝓁</code> but is constrained to have a particular behaviour <code>𝓇</code>.</li>
<li>Rewrite rules; e.g., in an ADT, an equation may simply act as an alias and is to be used
in rewriting the remainder of the ADT declaration.</li>
<li>Ignored components; e.g., in a record, we may ignore the equations altogether
and lift the associated names into being <a href="#orgb32f32d">fields</a> &#x2014;e.g., <code>_≈_</code> would usually be lifted into
a field and its stringent implementation via <code>_≡_</code> is used as a motivating or simplifying factor.</li>
</ul>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer MonoidP : Set&#8321; where</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- A few declarations</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#10814;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Id      : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- We have a setoid-like structure; with a default implementation</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#8776;_   : Carrier &#8594; Carrier &#8594; Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#8776;_   = _&#8801;_</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    &#10814;-cong : &#8704; {x y x&#8242; y&#8242;} &#8594; x &#8776; x&#8242; &#8594;  y &#8776; y&#8242; &#8594; (x &#10814; y) &#8776; (x&#8242; &#10814; y&#8242;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    &#10814;-cong = &#955;{ &#8801;.refl &#8801;.refl &#8594; &#8801;.refl}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- For now only one item in a declaration;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- namely &#8220;Lid&#8221; &amp; &#8220;Rid&#8221; cannot be declared in one line.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Lid : Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Lid x = Id &#10814; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Rid : Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Rid x = x &#10814; Id</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- Agda permits pure, non-pattern-matching, equations between &#8220;fields&#8221; in a record.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    concat : List Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    concat = foldr _&#10814;_ Id</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- More declarations</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    leftId  : &#8704; {x : Carrier} &#8594; (Id &#10814; x) &#8776; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    rightId : &#8704; {x : Carrier} &#8594; Rid x &#8776; x</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- Since there are no more pure declarations, &#8220;fields&#8221;, subsequent equations</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    -- may use pattern matching.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    Id&#178; : (Id &#10814; Id) &#8776; Id</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Id&#178; = rightId</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    concat&#8346; : List Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    concat&#8346; []       = Id</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    concat&#8346; (x &#8759; xs) = x &#10814; concat&#8346; xs</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Notice that there is no particular segregation of declarations and equations.
Simply: A declaration may <i>optionally</i> have an associated equation; however
once an equation uses pattern matching then all subsequent declarations must also
have equations &#x2014;this is a constraint of the current Agda implementation&#x2014;;
as such, the equation for <code>⨾-cong</code> uses Agda's pattern-matching-λ.
</p>
</div>
</div>

<div id="outline-container-org8850fd3" class="outline-3">
<h3 id="Empty-Variationals"><span class="section-number-3">3.3</span> Empty Variationals</h3>
<div class="outline-text-3" id="text-Empty-Variationals">
<p>
<center><em> A summary of the key features of 𝒱ariationals </center></em>
</p>

<p>
The simplest user definable variational is the empty one:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Variational with empty right hand side.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-identity =</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
The prefix <code>𝒱-</code> signals to the Elisp meta-program that this particular equation is intended
to be a variational and should be <i>loaded into Emacs</i> as such. Indeed, you may view the documentation
and <i>elaborated</i> Lisp of this definition using <code>C-h o RET 𝒱-identity</code>.
</p>

<p>
<b>Remember</b>: The prefix <code>𝒱-</code> only occurs at the definition site, the call site omits it.
Why? We have augmented the Emacs system with a new functional definition, and the 𝒱-
serves as a namespace delimiter.
</p>

<p>
Indeed, we may now perform the following invocation &#x2014;within <a href="#org81f2700">700-comments</a>.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#8305;&#7496; = MonoidP identity</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Loading the meta-program using Agda's usual <code>C-c C-l</code> lets us
hover over <code>MonoidPⁱᵈ</code> to see its elaboration is precisely that of <code>MonoidP</code>.
</p>

<p>
<i>Moreover</i>, to be useful, all variationals
have tooltips showing their user-defined documentation.
If we hover over <code>identity</code>, we are informed that it is undocumented.
User documentation is optional and may appear immediately following the <code>=</code>, as follows.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-no-op = "This is the do-nothing variational"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
We may substitute equals-for-equals:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- No variational clauses needed!</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#8304;  = MonoidP</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Doing nothing is meaningful with respect to a composition operation.
Momentarily, “⟴” is forwards composition: We ‘thread’ the <code>Pf</code> through the variationals <code>vᵢ</code> in order.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Identity of composition &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#7580; = MonoidP &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Operationally: <code>Pf ⟴ v  ≈  Pf v ⟴  ≈  Pf v</code></td>
</tr>
</tbody>
</table>

<p>
We may also augment a variational with positional and (optional) keyword arguments that have default values.
The keyword arguments along with their default value, <i>if any</i>, are enclosed in parenthesis.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-test positional (keyword 3) another = "I have two mandatory arguments and one keyword argument"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-test = MonoidP &#10228; test "positional arg&#8321;" "positional arg&#8322;" :keyword 25</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
We are not doing anything with the arguments here; we shall return to this in later subsections.
</p>
</div>
</div>

<div id="outline-container-orgb712156" class="outline-3">
<h3 id="--Errors"><span class="section-number-3">3.4</span> ⇨ Errors</h3>
<div class="outline-text-3" id="text---Errors">
<p>
Even though this is a prototype, we wish it to be useful to ourselves and to others
&#x2014;especially those who take a quick glance, think they got it, and try things out only to not have them work
immediately. As such, we have implemented a cute little error-reporting system.
</p>
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">If you try to load, <code>C-c C-l</code>, but your <a href="#orge0fd48a">700-syntax</a> is wrong, you get an immediate error explaining why ♥‿♥</td>
</tr>
</tbody>
</table>

<p>
For example, suppose we accidentally wrote <code>tester</code> instead of <code>test</code>, which we defined
at the end of the previous section, as in the following.
( The space before <code>700</code> is so that this crashing block is not in effect. )
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-whoops  = tester 1 2 :keyword 3</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
When we try to load our Agda file the Agda process is interrupted and we are warned:
</p>
<div class="org-src-container">
<pre class="src src-text">700: Did you mistype a variational&#8217;s name: &#8220;tester&#8221; is not defined.

    &#8680;   whoops = tester 1 2 :keyword 3
    &#8680;   Use the PackageFormer menu to see which variationals are defined.
</pre>
</div>
<p>
The 700 system informs us of our fault in “quotes”, suggests a solution,
and points to the offending declaration hierarchy. Neato (•̀ᴗ•́)و
</p>

<p>
The “quotes” help, in this case, when there are multiple variationals being
invoked in a clause.
</p>

<p>
Of-course, we do not attempt to cover all possible errors &#x2014;e.g., wrong number
of arguments or division by zero&#x2014; instead relying on Emacs Lisp's native
error mechanism.
</p>
</div>
</div>

<div id="outline-container-orgcf26cc0" class="outline-3">
<h3 id="Records-and-Meta-Primitives---kind------alter-elements-"><span class="section-number-3">3.5</span> Records and Meta-Primitives <code>:kind</code> &amp; <code>:alter-elements</code></h3>
<div class="outline-text-3" id="text-Records-and-Meta-Primitives---kind------alter-elements-">
<p>
Let's begin with the simplest thing: Realising these fictitious ‘PackageFormers’ as records.
</p>

<p>
An Agda ‘record’ is just a PackageFormer where the qualifier <code>PackageFormer</code> has been
replaced with <code>record</code> and each element is qualified by Agda keyword <code>field</code>.
We may declare this particular configuration using the meta-primitives
<code>:kind</code> and <code>:alter-elements</code>, as follows.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-record&#8320; = :kind record :alter-elements (&#955; es &#8594; (--map (map-qualifier (&#955; _ &#8594; "field") it) es))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
<b>Huh?</b>
The <code>:kind</code> part was already explained, the <code>:alter-elements</code> is the powerhouse of our system.
It takes a function with argument being the list of PackageFormer elements, <code>es</code>,
then we perform a functorial list map where each element is implicitly referred to as <code>it</code>.
Then the map function is to alter the qualifier of an element by replacing it with the string <code>"field"</code>.
In Agda syntax this corresponds to: <code>λ es → map (λ it → (map-qualifier (λ _ → "field") it)) es</code>.
<br>
Notice that the Agda form and Lisp form are only one outer parenthesis off from each other &#x2014;Lisp is easy!
</p>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><i>The <code>:key value</code> syntax is inspired from Lisp</i></td>
</tr>
</tbody>
</table>

<p>
Unsurprisingly, we have elected to name this grouping mechanism configuration as <code>𝒱-record</code>.
Let's try it out.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record = M-Set record&#8320;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
The system picks this up, looks up <code>M-Set</code> which was defined in the first section earlier,
looks up the variational <code>record</code>, then runs that configuration to generate:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record = M-Set record&#8320; -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record M-Set-Record : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Scalar     : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector     : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;_        : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;      : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;_        : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId     : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc      : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
</pre>
</div>

<p>
Nothing too remarkable; the keyword <code>field</code> has been inserted and the rewrite <code>PackageFormer ↦ record</code>
has been performed. The above is the <i>exact</i> generated result of the system &#x2014;the comment indicates
the source of this generated code.
</p>
</div>
</div>

<div id="outline-container-org7f1930f" class="outline-3">
<h3 id="Equation-Accommodating-Record-Variational"><span class="section-number-3">3.6</span> Equation Accommodating Record Variational</h3>
<div class="outline-text-3" id="text-Equation-Accommodating-Record-Variational">
<p>
Since record formation is a variational that is likely to be used often, it is sensible to document it
&#x2014;which in turn is attached to all occurences of the variational name via tooltips.
Moreover, let's strengthen it to accomodate PackageFormers with equations.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; record&#8321; (discard-equations nil)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> = "Reify a variational as an Agda &#8220;record&#8221;.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Elements with equations are construed as</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    derivatives of fields  ---the elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    without any equations--- by default, unless</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    DISCARD-EQUATIONS is provided with a non-nil value.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   "</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  :kind record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  :alter-elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    (&#955; es &#8594;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (thread-last es</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      ;; Keep or drop eqns depending on &#8220;discard-equations&#8221;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (--map</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (if discard-equations</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            (map-equations (&#955; _ &#8594; nil) it)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      ;; Unless there's equations, mark elements as fields.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (--map (map-qualifier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (&#955; _ &#8594; (unless (element-equations it)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">               "field")) it)))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Unlike <code>𝒱-identity</code> from a previous section, we have decided to split this definition into multiple
lines by enclosing it in <code>{-lisp ⋯ -</code>}~. Such blocks may contain arbitrary Lisp to be executed and so
all contents must be Lisp forms &#x2014;notice the <code>𝒱-⋯</code> from <code>700</code>-blocks has been <b>exchanged</b> for
a parenthesised (<code>𝒱 ⋯)</code> within <code>lisp</code>-blocks.
</p>

<p>
Let's try this out.
</p>

<p>
First, using only the default value &#x2014;which doesn't discard equations.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived = MonoidP record&#8321;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Monoid-Record-derived</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    _&#8776;_     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span> ; _&#8776;_   <span style="color: #3a81c3; font-weight: bold;">=</span> _&#8801;_
    &#10814;-<span style="color: #0000cd;">cong</span>      : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span>&#8242;} &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>&#8242; &#8594;  <span style="color: #0000cd;">y</span> &#8776; <span style="color: #0000cd;">y</span>&#8242; &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#8776; (<span style="color: #0000cd;">x</span>&#8242; &#10814; <span style="color: #0000cd;">y</span>&#8242;) ;  &#10814;-<span style="color: #0000cd;">cong</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">&#955;</span>{ &#8801;.<span style="color: #0000cd;">refl</span> &#8801;.<span style="color: #0000cd;">refl</span> &#8594; &#8801;.<span style="color: #0000cd;">refl</span>}
   <span style="color: #ba2f59; font-weight: bold;"> Lid</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #ba2f59; font-weight: bold;"> Lid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span>
   <span style="color: #ba2f59; font-weight: bold;"> Rid</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>
    <span style="color: #0000cd;">concat</span>      :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #0000cd;">concat</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">foldr</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_ Id</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>        : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814; <span style="color: #0000cd;">x</span>) &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>       : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178;     :<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>) &#8776;<span style="color: #ba2f59; font-weight: bold;"> Id</span> ; <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>
    <span style="color: #0000cd;">concat</span>&#8346;     :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #0000cd;">concat</span>&#8346; []       <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> ; <span style="color: #0000cd;">concat</span>&#8346; (<span style="color: #0000cd;">x</span> &#8759; <span style="color: #0000cd;">xs</span>) <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">concat</span>&#8346; <span style="color: #0000cd;">xs</span>
</pre>
</div>
<p>
Second, discarding equations and lifting all elements into <code>field</code>-s.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-field = MonoidP record&#8321; :discard-equations t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Monoid-Record-cons</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #3a81c3; font-weight: bold;">field</span> _&#8776;_       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> &#10814;-<span style="color: #0000cd;">cong</span>        : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span>&#8242;} &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>&#8242; &#8594;  <span style="color: #0000cd;">y</span> &#8776; <span style="color: #0000cd;">y</span>&#8242; &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#8776; (<span style="color: #0000cd;">x</span>&#8242; &#10814; <span style="color: #0000cd;">y</span>&#8242;)
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Lid</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Rid</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">concat</span>        :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>        : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814; <span style="color: #0000cd;">x</span>) &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>       : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178;       :<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>) &#8776;<span style="color: #ba2f59; font-weight: bold;"> Id</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">concat</span>&#8346;       :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
</pre>
</div>

<p>
Let's also codify the converse operation of marking a grouping mechanism abstract to avoid elaboration.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> PackageFormer <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Mark a grouping mechanism as abstract, so that it is NOT elaborated into concrete Agda."</span> <span style="color: #3a81c3;">:kind</span> PackageFormer<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org794619c" class="outline-3">
<h3 id="A-Coherent-Equation-Accommodating-Record-Variational"><span class="section-number-3">3.7</span> A Coherent Equation Accommodating Record Variational</h3>
<div class="outline-text-3" id="text-A-Coherent-Equation-Accommodating-Record-Variational">
<p>
Yet another option to handling equations is to drop the names that have
equations associated with them. To tackle such a scenario
requires the remaining elements to be well-defined and so requires “the largest sub-PackageFormer”.
</p>

<p>
Coherent relationships are just graphs in disguise, so let's abstract away the details and solve
a graph-theoretic problem. In <code>{-lisp ⋯ -}</code> blocks we may have arbitrary Emacs Lisp code and so include
the following &#x2014;which has a large number of shortcomings, but the aim is a simple demonstration of Lisp
code for the Agda user, not to be robust Lisp code. The name, <a id="org4a65e88">graph-map</a>, may not be ideal but it seems good enough, for now.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">p &#8776; symptom; f &#8776; medicine; adj &#8776; neighbouring dependency</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">graph-map</span> <span style="color: #6c3163;">(</span>p f adj xs <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> keep-only-marked<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Map the nodes XS satisfying P by F along adjacency ADJ.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('graph-map)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Using -map instead of -filter since nodes may become</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">sickly later on, position matters.</span>
         <span style="color: #67b11d;">(</span>sickly <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">-map</span> p xs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Obtain the items that are currently &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">sickly</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
         <span style="color: #67b11d;">(</span>get-sickly <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #3a81c3;">()</span>
                       <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> it <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--zip-with</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> it other<span style="color: #2d9574;">)</span> sickly xs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">infected x  &#8801; x has a sickly neighbour</span>
         <span style="color: #67b11d;">(</span>infected <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--any</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> adj x it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> get-sickly<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Propogate sickness.</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for _ in xs
           <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for x in xs
                    for i from 0
                    <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> infected x<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> i sickly<span style="color: #6c3163;">)</span> <span style="color: #715ab1;">t</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Apply medication to sickly elements only.</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> it <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-contains-p</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> get-sickly<span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> f it<span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> keep-only-marked it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
            xs<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here's how this works &#x2014;the following is what the incantation
above <code>&lt;&lt;docs('graph-map)&gt;&gt;</code> refers to, and the reader may ignore all <code>&lt;&lt;…&gt;&gt;</code>
as they are a backend ‘literate programming’ utility.
</p>

<ul class="org-ul">
<li>F is performed on nodes satisfying P,
all neighbours are then considered to satisfy P
and the process repeats recursively.</li>

<li>E.g., nodes exhibiting symptoms P are given medicine F,
and their sickness spreads to their neighbours who in turn
become ill thereby requiring medication, and the process continues.</li>

<li>ADJ is a binary relation denoting adjacency.
<ul class="org-ul">
<li>(adj x y)  ≈  “x depends on, or is a neighbour, of y.”</li>
</ul></li>

<li><p>
For example, a graph of 10 nodes, with an edge between multiples;
where nodes 3, 4, 5 are initally ill.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">   <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">graph-map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-contains-p</span> '<span style="color: #67b11d;">(</span>3 4 5<span style="color: #67b11d;">)</span> x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"medicated-%s"</span> x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x y &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">zerop</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">mod</span> x y<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              '<span style="color: #6c3163;">(</span>1 2 3 4 5 6 7 8 9 10<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
  &#8658;
    <span style="color: #3a81c3;">(</span>1 2 medicated-3 medicated-4 medicated-5 medicated-6 7
       medicated-8 medicated-9 medicated-10<span style="color: #3a81c3;">)</span>
</pre>
</div></li>
</ul>

<p>
Testing this graph-theoretic solution for our setting shows it to be a reasonable fit.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example: Dropping the implementations of the first 2 items.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> i -1<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">graph-map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">incf</span> i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;</span> i 2<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
           <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">map-equations</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; nil<span style="color: #67b11d;">)</span> x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">x depends on y  &#8801;  x mentions y in its type or equations.</span>
           <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x y &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">" "</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> y<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> x<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> x<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
           <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> '<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"A : Set"</span> <span style="color: #2d9574;">"_&#8776;_ : A &#8594; A &#8594; Set"</span> <span style="color: #2d9574;">"_&#8776;_ = _&#8801;_"</span> <span style="color: #2d9574;">"easy : &#8704; {x} &#8594; x &#8776; x"</span> <span style="color: #2d9574;">"easy = refl"</span>
                             <span style="color: #2d9574;">"another : &#8704; {x} &#8594; Set"</span> <span style="color: #2d9574;">"another = easy"</span> <span style="color: #2d9574;">"by : Set&#8321;"</span> <span style="color: #2d9574;">"by = Set"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #e0211d; font-weight: bold; text-decoration: overline;">)</span>
&#8658;
  A       : Set
  <span style="color: #6c3163; font-weight: bold;">eq</span>      : A &#8594; A &#8594; Set    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">implementation dropped</span>
  easy    : &#8704; {x} &#8594; x &#8776; x  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ditto, since it depends on &#8776;'s implementation</span>
  another : &#8704; {x} &#8594; Set    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ditto, since it depends on easy's implementation</span>
  by      : Set&#8321;
  by      <span style="color: #6c3163; font-weight: bold;">=</span> Set&#8321;
</pre>
</div>

<p>
Let's introduce a dedicated form for <code>element</code> values:
</p>
<ul class="org-ul">
<li>Mark elements in a given list, and recursively mark all those that depend on
them.  Return the list of elements with the marked ones being altered.</li>

<li>MARK and ALTER are expressions mentioning IT, a value of ELEMENTS,
and so are implicit functional expressions.</li>

<li>Only the MARKED elements are kept.</li>
</ul>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defmacro</span> <span style="color: #6c3163; font-weight: bold;">--graph-map</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">mark</span> alter elements <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> <span style="color: #2d9574;">(</span>keep-only-marked <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Recursively ALTER and MARK elements and their dependents.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('--graph-map)&gt;&gt;"</span>
  `<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">graph-map</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> it &#8594; ,<span style="color: #6c3163; font-weight: bold;">mark</span><span style="color: #2d9574;">)</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> it &#8594; ,alter<span style="color: #2d9574;">)</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">x depends on y  &#8801;  x mentions y, with all or no undescores,</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                    </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in its type or equations.</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x y &#8594;
                 <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">" "</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> x<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                                  <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> y<span style="color: #2d9574;">)</span>
                                                    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> y<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                     <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> x<span style="color: #3a81c3;">)</span>
                                  <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> y<span style="color: #2d9574;">)</span>
                                                    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> y<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
              ,elements ,keep-only-marked<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Now the previous example may be invoked as:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> i -1<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--graph-map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">incf</span> i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;</span> i 3<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
             <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">map-equations</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; nil<span style="color: #2d9574;">)</span> it<span style="color: #6c3163;">)</span>
             <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> '<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"A : Set"</span> <span style="color: #2d9574;">"_&#8776;_ : A &#8594; A &#8594; Set"</span> <span style="color: #2d9574;">"_&#8776;_ = _&#8801;_"</span>
                               <span style="color: #2d9574;">"easy : &#8704; {x} &#8594; x &#8776; x"</span> <span style="color: #2d9574;">"easy = refl"</span>
                               <span style="color: #2d9574;">"another : &#8704; {x} &#8594; Set"</span> <span style="color: #2d9574;">"another = easy"</span> <span style="color: #2d9574;">"by : Set&#8321;"</span> <span style="color: #2d9574;">"by = Set"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #e0211d; font-weight: bold; text-decoration: overline;">)</span>
</pre>
</div>

<p>
With these pieces in hand, let's form
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> <span style="color: #6c3163; font-weight: bold;">record</span> <span style="color: #6c3163;">(</span>discard-equations nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>and-names nil<span style="color: #6c3163;">)</span>
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Reify a variational as an Agda &#8220;record&#8221;.</span>

<span style="color: #2d9574;">    By default, elements with equations are construed as</span>
<span style="color: #2d9574;">    derivatives of fields  ---the elements</span>
<span style="color: #2d9574;">    without any equations.</span>

<span style="color: #2d9574;">    &#8680; DISCARD-EQUATIONS is nil by default.</span>
<span style="color: #2d9574;">      If provided with a non-nil value, equations are dropped indiscriminately.</span>

<span style="color: #2d9574;">    &#8680; AND-NAMES is nil by default and only takes</span>
<span style="color: #2d9574;">      effect when DISCARD-EQUATIONS is active.</span>
<span style="color: #2d9574;">      If provided with a non-nil value, names with</span>
<span style="color: #2d9574;">      equations are dropped altogether; but some may be kept</span>
<span style="color: #2d9574;">      if they are needed for some fields to be well-defined.</span>
<span style="color: #2d9574;">   "</span>
  <span style="color: #3a81c3;">:kind</span> <span style="color: #6c3163; font-weight: bold;">record</span>
  <span style="color: #3a81c3;">:alter-elements</span>
    <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594;
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> es

      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es&#8242; &#8594; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> discard-equations<span style="color: #6c3163;">)</span> es&#8242;
               <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">map-equations</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">-const</span> nil<span style="color: #887070;">)</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">map-qualifier</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-const</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> it<span style="color: #2d9574;">)</span> 'eqns<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> es&#8242;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es&#8242; &#8594; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> and-names<span style="color: #6c3163;">)</span> es&#8242;
        <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--graph-map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> 'eqns <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-qualifier</span> it<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> it es&#8242;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Unless there's equations, mark elements as fields.</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">map-qualifier</span>
        <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> it<span style="color: #2d9574;">)</span>
               <span style="color: #2d9574;">"field"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #dc752f; background-color: #fbf8ef;">it</span><span style="color: #b1951d; background-color: #fbf8ef;">)</span><span style="color: #67b11d; background-color: #fbf8ef;">)</span><span style="color: #2d9574; background-color: #fbf8ef;">)</span><span style="color: #6c3163; background-color: #fbf8ef;">)</span><span style="color: #3a81c3; background-color: #fbf8ef;">)</span>
</pre>
</div>
<p>
We can obtain the previous variationals <code>rcordᵢ</code> as well as new presentations.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived-again  = MonoidP record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-derived-again2 = MonoidP record :and-names t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-field-again    = MonoidP record :discard-equations t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid-Record-no-equationals = MonoidP record :discard-equations t :and-names t</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
The last form yields:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Monoid-Record-no-equationals</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>       : <span style="color: #3a81c3; font-weight: bold;">Set</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org10221b3" class="outline-3">
<h3 id="Typeclasses----Parameterised-Records----and-Meta-Primitives---waist------level-"><span class="section-number-3">3.8</span> Typeclasses &#x2014;Parameterised Records&#x2014; and Meta-Primitives <code>:waist</code> &amp; <code>:level</code></h3>
<div class="outline-text-3" id="text-Typeclasses----Parameterised-Records----and-Meta-Primitives---waist------level-">
<p>
We mentioned the <a id="org135c334">“waist”</a> before, but what is it exactly?
I propose that the difference between ‘field’ and ‘parameter’
is an illusion &#x2014;as is that of ‘input’ and ‘output’ when one
considers relations rather than deterministic functions.
</p>

<p>
For example, let's alter the previous variation declaration to
lift the waist up 2 positions.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass-attempt = record &#10228; :waist 2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Notice we have avoided repeating the definition of the <code>record</code> variational from
earlier by making use of composition. More on it later, but it suffices to say
that above we could replace <code>record ⟴</code> with the exact text of <code>𝒱-record = ⋯</code> right-hand-side
and all would continue work.
</p>

<p>
Trying this out, below, one notices that the first two elements of the PackageFormer have been lifted
into being <a href="#orged238e3">parameters</a>, while the rest have been construed as <a href="#orgb32f32d">fields</a>.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-TypeClass = M-Set typeclass-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-TypeClass (Scalar</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
While this typechecks according to Agda standards, it is not ideal to human
standards since the level of the resulting package is larger than necessary.
The meta-primitive <code>:level</code> allows us to <code>inc</code>-rement or <code>dec</code>-crement the
current level of a PackageFormer, so we may instead define:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass&#8322; = record &#10228; :waist 2 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8322;      = MonoidP typeclass&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidT</span>&#8322;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>     : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>        : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>       : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>
</pre>
</div>

<p>
For fun, here are a few more to play with:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8323;         = MonoidP record &#10228; :waist 3 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MonoidT&#8323;-again   = MonoidP &#10228; record &#10228; unbundling 3</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8322; = M-Set record &#10228; typeclass&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
In particular, the last example suggest that our composition is idempotent, but this is clearly not the case.
Indeed, here's a pretty alternative to the meta-primitive <code>:waist</code> that is not ⟴-idempotent
but is in-fact a homomorphism: <code>unbundling n ⟴ unbundling m ≈ unbundling (n + m)</code>.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #3a81c3;">(</span>&#119985; unbundling n
 = <span style="color: #2d9574;">"Make the first N elements as parameters to the PackageFormer.</span>

<span style="color: #2d9574;">    Any elements in above the waist line have their equations dropped.</span>
<span style="color: #2d9574;">    As such, unbundling is not invertible.</span>
<span style="color: #2d9574;">   "</span>
   <span style="color: #3a81c3;">:waist</span> n
   <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span>&#955; es &#8594;
     <span style="color: #2d9574;">(</span>-let [i 0]
       <span style="color: #67b11d;">(</span>--graph-map <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #3a81c3;">(</span>incf i<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>&lt;= i n<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                    <span style="color: #b1951d;">(</span>map-equations <span style="color: #3a81c3;">(</span>-const nil<span style="color: #3a81c3;">)</span> it<span style="color: #b1951d;">)</span>
                    es<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
( The <a href="#org4a65e88">graph-map</a> operation was defined in the previous section. )
</p>

<p>
Incidentally, this solves the problem of lifting the waist to include elements with equations.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Ill-formed in Agda: A defintion is not a parameter!</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP-Typeclass&#8325; = MonoidP :waist 5</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP-Typeclass</span>&#8325; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> MonoidP</span> :<span style="color: #0000cd;">waist</span> <span style="color: #a020f0;">5</span> -}
<span style="color: #ba2f59; font-weight: bold;">PackageFormer MonoidP-Typeclass</span>&#8325;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>)<span style="color: #ba2f59; font-weight: bold;"> (Id</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)) (_&#8776;_ :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span> ; _&#8776;_ <span style="color: #3a81c3; font-weight: bold;">=</span> _&#8801;_) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    &#10814;-<span style="color: #0000cd;">cong</span>      : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span>&#8242;} &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>&#8242; &#8594;  <span style="color: #0000cd;">y</span> &#8776; <span style="color: #0000cd;">y</span>&#8242; &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#8776; (<span style="color: #0000cd;">x</span>&#8242; &#10814; <span style="color: #0000cd;">y</span>&#8242;) ;  &#10814;-<span style="color: #0000cd;">cong</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">&#955;</span>{ &#8801;.<span style="color: #0000cd;">refl</span> &#8801;.<span style="color: #0000cd;">refl</span> &#8594; &#8801;.<span style="color: #0000cd;">refl</span>}
   <span style="color: #ba2f59; font-weight: bold;"> Lid</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #ba2f59; font-weight: bold;"> Lid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span>
   <span style="color: #ba2f59; font-weight: bold;"> Rid</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>
    <span style="color: #0000cd;">concat</span>      :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #0000cd;">concat</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">foldr</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_ Id</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>      : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814; <span style="color: #0000cd;">x</span>) &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>     : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178;     :<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>) &#8776;<span style="color: #ba2f59; font-weight: bold;"> Id</span> ; <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>
    <span style="color: #0000cd;">concat</span>&#8346;     :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> ;  <span style="color: #0000cd;">concat</span>&#8346; []       <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> ; <span style="color: #0000cd;">concat</span>&#8346; (<span style="color: #0000cd;">x</span> &#8759; <span style="color: #0000cd;">xs</span>) <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">concat</span>&#8346; <span style="color: #0000cd;">xs</span> -}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8325; = MonoidP &#10228; unbundling 5 &#10228; record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidT</span>&#8325;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>)<span style="color: #ba2f59; font-weight: bold;"> (Id</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)) (_&#8776;_ :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> &#10814;-<span style="color: #0000cd;">cong</span>        : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">x</span>&#8242; <span style="color: #0000cd;">y</span>&#8242;} &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>&#8242; &#8594;  <span style="color: #0000cd;">y</span> &#8776; <span style="color: #0000cd;">y</span>&#8242; &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#8776; (<span style="color: #0000cd;">x</span>&#8242; &#10814; <span style="color: #0000cd;">y</span>&#8242;)
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Lid</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Rid</span>       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">concat</span>        :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>        : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814; <span style="color: #0000cd;">x</span>) &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">rightId</span>       : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Rid</span> <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">x</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#178;       :<span style="color: #ba2f59; font-weight: bold;"> (Id</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span>) &#8776;<span style="color: #ba2f59; font-weight: bold;"> Id</span>
    <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">concat</span>&#8346;       :<span style="color: #ba2f59; font-weight: bold;"> List Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
</pre>
</div>

<p>
:smile:
</p>
</div>
</div>

<div id="outline-container-org5271776" class="outline-3">
<h3 id="Primed-Decoration-and--rename-mixfix-"><span class="section-number-3">3.9</span> Primed Decoration and <code>rename-mixfix</code></h3>
<div class="outline-text-3" id="text-Primed-Decoration-and--rename-mixfix-">
<p>
When we have two occurrences of a structure, we may want one of them to be decorated
say with a prime so as to disambiguate them easily rather than have to qualify all
of their components.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Intentionally erroenous attempt.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-primed-attempt = :alter-elements (&#955; es &#8594; (--map (map-name (&#955; n &#8594; (rename-mixfix (&#955; np &#8594; (concat np "&#8242;")) n)) it) es))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- M-Set&#8242;-attempt = M-Set record &#10228; primed-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span>&#8242;-<span style="color: #0000cd;">attempt</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;&#8242;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;&#8242;     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;&#8242;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242;        : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242;     : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This is crashing Agda code; as expected. Working improvements below. -}</span>
</pre>
</div>

<p>
There are number of issues to address.
</p>

<ol class="org-ol">
<li>The system comes with a Lisp methods <code>map-name</code> and <code>map-type</code> that yield the name and type part,
respectively, of a PackageFormer element.</li>

<li><p>
The <code>:key value</code> pairs have legitimate Lisp for the <code>value</code> positions.
</p>

<p>
The basics of list processing, such as maps/filters/folds, with Lisp suffice for a rich
inventory of possible configurations. Moreover, the functional nature of such higher-order
functions ought to be familiar to any Agda coder <a href="https://www.phrases.org.uk/meanings/worth-ones-salt.html">worth their salt</a>.
</p>

<p>
Here's a terse tutorial rendered as an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>.
</p></li>

<li><p>
One would expect catenating a prime to the mixfix name <code>_×_</code> would yield <code>_×_′</code> but above
it yielded <code>_×′_</code>. Indeed, the former would yield confusing expressions of the form
<code>1 × 2 ′</code> whereas the latter permits <code>1 ×′ 2</code>. It is with this pragmatic usage that
<code>rename-mixfix</code> performs a rewrite to a name by jumping over the Agda mixfix marker, <code>_</code>,
if it occurs at the start or end of a name.
</p>

<p>
As an additional example, the name
<code>_≈_∶_</code>, under the above scheme, would have rewritten to <code>_≈_∶′_</code> thereby
allowing terms such as <code>x ≈ y ∶ A  →  f x ≈ f y ∶′ B</code> &#x2014;a elegant way to
express that, say, <code>f</code> is a setoid homomorphism.
If the prime scheme were instead a prepend, we would have obtained the name
<code>_′≈_∶_</code>.
</p></li>
</ol>

<p>
Notice that
we have <a href="#orgb32f32d">fields</a> such as <code>𝟙′ : Scalar</code>
whose type is a free variable: <code>Scalar</code> no longer refers to any field.
As such, the above code is ill-typed.
The solution then is to <i>propagate</i> any changes a name has down to its siblings.
We will return to this later in the form of a <code>map</code> variational.
</p>
</div>
</div>

<div id="outline-container-org9478102" class="outline-3">
<h3 id="First-class-PackageFormers"><span class="section-number-3">3.10</span> First-class PackageFormers</h3>
<div class="outline-text-3" id="text-First-class-PackageFormers">
<p>
The previous example caused an Agda typechecking error, however if we do not
invoke the <code>record</code> variational then the result is a non-Agda syntactical item
which can only be the subject of further alteration via PackageFormer combinators.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set&#8242;-attempt-raw = M-Set primed-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set&#8242;-attempt-raw : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar&#8242;      : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector&#8242;      : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;&#8242;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;&#8242;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;&#8242;_     : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId&#8242;      : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc&#8242;       : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;) -}</span>
</pre>
</div>

<p>
This is interesting: We have not generated a concrete &#x2014;legitimate Agda construct&#x2014;
but instead yielded a new abstract grouping mechanism which may be instantiated later on,
whenever desired.
</p>

<p>
Likewise, we have already declared <code>M-Set-Record = M-Set record</code> and now we may apply
our priming variational.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record&#8242; = M-Set-Record primed-attempt -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record M-Set-Record&#8242; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Scalar&#8242;        : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector&#8242;        : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;&#8242;_       : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;&#8242;     : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;&#8242;_       : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId&#8242;        : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc&#8242;     : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><i>We may apply  variationals even to concrete Agda packaging constructs!</i></td>
</tr>
</tbody>
</table>

<p>
Of-course, we may simply want to obtain <code>M-Set-Record′</code> without having first
to define <code>M-Set-Record</code>, and so we may use the variational composition operator <code>⟴</code>.
</p>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record&#8242; = M-Set record &#10228; primed-attempt -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record M-Set-Record&#8242; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Scalar&#8242;        : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector&#8242;        : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;&#8242;_       : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;&#8242;     : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;&#8242;_       : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId&#8242;        : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc&#8242;     : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
</pre>
</div>

<p>
Since the <code>record</code> and <code>primed</code> configurations are ‘disjoint’, they commute
with respect to composition. The reader may want to confirm the following identifications:
</p>
<div class="org-src-container">
<pre class="src src-agda">      <span style="color: #ba2f59; font-weight: bold;">M-Set-Record&#8242;</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; <span style="color: #0000cd;">primed-attempt</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #0000cd;">primed-attempt</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">record</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">record</span>
   &#8776;  <span style="color: #ba2f59; font-weight: bold;">M-Set-Record primed-attempt</span>
</pre>
</div>

<p>
It is important to remember that these primed perspectives do <i>not</i> typecheck in Agda due to the free-variable
issue mentioned earlier. We are only demonstrating composition, <code>⟴</code>, in this section; in a later section we
fix-up <code>primed</code>.
</p>
</div>
</div>

<div id="outline-container-org72b6056" class="outline-3">
<h3 id="Variationals-with-Arguments-----map--rename---co-decorated--subscriptedᵢ--renaming-"><span class="section-number-3">3.11</span> Variationals with Arguments ---<code>map, rename, [co]decorated, subscriptedᵢ, renaming</code></h3>
<div class="outline-text-3" id="text-Variationals-with-Arguments-----map--rename---co-decorated--subscriptedᵢ--renaming-">
<p>
Thus far our variationals have been nullary, let's consider otherwise.
</p>

<p>
For example, let's add arguments to the typeclass variational from earlier.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass height (level 'dec) = record &#10228; :waist height :level level</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set2-Typeclass&#8323; = M-Set typeclass 3 :level 'inc</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set0-Typeclass&#8323; = M-Set typeclass 3</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set2-Typeclass</span>&#8323;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8322; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set0-Typeclass</span>&#8323;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<ul class="org-ul">
<li>Argument come before the <code>=</code> in a variational's definition and
the may be used as if they were constants on the right-hand side.
<ol class="org-ol">
<li>Above we introduced the named arguments <code>height</code> and <code>level</code>.</li>
<li>The first is positional, and the second is a keyword argument
with <i>default</i> value being a decrement value.</li>
<li>We then passed the <i>argument</i> <code>level</code> to the <i>meta-primitive</i> <code>:level</code>.</li>
</ol></li>

<li><p>
Invocation of variationals has positional arguments first then named arguments afterwards.
One supplies a named argument in the form <code>:argument-name the-value</code> &#x2014;this is Lisp-inspired syntax.
</p>

<p>
Consequently, order is irrelevant for named arguments.
</p>

<ul class="org-ul">
<li>Supplying <code>:key value</code> pairs where the <code>key</code> is not a named argument of
the variational yields a error message indicating the allowable keys.</li>
</ul></li>
</ul>

<p>
Let's code up the priming operation as a reusable pattern &#x2014;call it <code>map</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> <span style="color: #6c3163; font-weight: bold;">map</span> elements <span style="color: #6c3163;">(</span>support-mixfix-names nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-coretract nil<span style="color: #6c3163;">)</span>
   <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Apply function ELEMENTS that acts on PackageFormer elements,</span>
<span style="color: #2d9574;">      then propogate all new name changes to subsequent elements.</span>

<span style="color: #2d9574;">      There is minimal support for mixfix names, but it may be</span>
<span style="color: #2d9574;">      ignored by setting SUPPORT-MIXFIX-NAMES to be nil.</span>

<span style="color: #2d9574;">      When ADJOIN-RETRACT is non-nil, we adjoin a &#8220;record {old&#7522; = name&#7522;}&#8221;</span>
<span style="color: #2d9574;">      view morphism; i.e., record translation.</span>

<span style="color: #2d9574;">      Clauses &#8220;f = f&#8221; are considered to occur only in views, record translations,</span>
<span style="color: #2d9574;">      and so only the RHS occurance is updated to a new name.</span>
<span style="color: #2d9574;">      C.f. the definition of element-retract.</span>
<span style="color: #2d9574;">      "</span>
     <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #2d9574;">(</span>es<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>es&#8242;    <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> elements es<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>names  <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> es<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>names&#8242; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> es&#8242;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Replace all occurances of old names with corresponding new ones.</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for old in names
            for new in names&#8242;
            <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> es&#8242; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-replace</span> old new it <span style="color: #3a81c3;">:support-mixfix-names</span> support-mixfix-names<span style="color: #6c3163;">)</span> es&#8242;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return value</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> es&#8242; <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-retract <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; es <span style="color: #3a81c3;">:new</span> es&#8242; <span style="color: #3a81c3;">:name</span> adjoin-retract<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                  <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> adjoin-coretract <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-retract</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; es&#8242; <span style="color: #3a81c3;">:new</span> es <span style="color: #3a81c3;">:name</span> adjoin-coretract <span style="color: #3a81c3;">:contravariant</span> <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
This is a prototype; ideally the variational definition would be rendered in
Agda code. Rather than using functional combinators such as
<code>unzip, map, zip-with</code>, for diversity, we used imperative constructs.
</p>

<p>
Important observations include:
</p>

<ol class="org-ol">
<li>The Lisp code lives in a <code>{-lisp ⋯ -}</code> block.</li>

<li><a href="#org81f2700">700-comments</a> have single-line <code>𝒱-name args = rhs</code>, whereas lisp-blocks
have multi-line <code>(𝒱 name args = rhs)</code> &#x2014;the dash after the 𝒱 is gone and outer-most
parenthesis are added.</li>

<li><p>
To provide minimal accommodation for mixfix names, we simply remove the
Agda argument indicator ‘_’ when performing rewrites.
</p>

<p>
E.g., Agda let's you
declare a name such as <code>_⊕_</code> and use it without mentioning the underscore
as in <code>x ⊕ y</code> and so the rename <code>_⊕_ ↦ _⊕′_</code> would have no effect since <code>_⊕_</code>
does not occur as a substring in <code>x ⊕ y</code>, whence the need to ignore the underscores.
</p></li>
</ol>

<p>
Trying it out:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#120143;    = M-Set record &#10228; map (&#955; e &#8594; (map-name (&#955; n &#8594; (rename-mixfix (&#955; x &#8594; (concat x "&#120143;")) n)) e))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#120143; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120143;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;&#120143;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120143; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120143;
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;&#120143;     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143;
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;&#120143;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#120143;        : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120143;}  &#8594;  &#120793;&#120143; &#183;&#120143; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#120143;     : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120143;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120143;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#120143; <span style="color: #0000cd;">b</span>) &#183;&#120143; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#120143; (<span style="color: #0000cd;">b</span> &#183;&#120143; &#120011;)
</pre>
</div>

<p>
Now for some useful corollaries.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> rename f <span style="color: #6c3163;">(</span>support-mixfix-names nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-retract <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163; font-weight: bold;">=</span>  <span style="color: #2d9574;">"Rename elements using a string-to-string function F acting on names.</span>

<span style="color: #2d9574;">      There is minimal support for mixfix names, which may be tried</span>
<span style="color: #2d9574;">      by setting SUPPORT-MIXFIX-NAMES to be t.</span>

<span style="color: #2d9574;">      When ADJOIN-RETRACT is non-nil, we adjoin a &#8220;record {old&#7522; = name&#7522;}&#8221;</span>
<span style="color: #2d9574;">      view morphism; i.e., record translation.</span>
<span style="color: #2d9574;">     "</span>
     <span style="color: #6c3163; font-weight: bold;">map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">map-name</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> n &#8594; <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> f n <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> 'support-mixfix-names<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
         <span style="color: #3a81c3;">:support-mixfix-names</span> 'support-mixfix-names
         <span style="color: #3a81c3;">:adjoin-retract</span> 'adjoin-retract<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's try this out.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#120170;    = M-Set-Record rename (&#955; n &#8594; (concat n "&#120170;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR-oh  = M-Set-Record rename (&#955; n &#8594; (pcase n ("Scalar" "S") ("&#120793;" "&#949;") (else else)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#120170; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120170;        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;&#120170;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120170; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120170;
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;&#120170;     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170;
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;&#120170;_       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#120170;        : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120170;}  &#8594;  &#120793;&#120170; &#183;&#120170; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#120170;     : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#120170;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#120170;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#120170; <span style="color: #0000cd;">b</span>) &#183;&#120170; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#120170; (<span style="color: #0000cd;">b</span> &#183;&#120170; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR-oh  = M-Set record &#10228; rename (&#955; n &#8594; (pcase n ("Scalar" "S") ("&#120793;" "&#949;") (else else))) -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record MR-oh : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field S      : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector     : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;_        : S &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#949;      : S</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;_        : S &#8594; S &#8594; S</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId     : {&#120011; : Vector}  &#8594;  &#949; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc      : {a b : S} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
</pre>
</div>

<p>
We would expect it to be common to prefix and suffix symbols, so let's make
variationals for these patterns.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> decorated by
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Rename all elements by suffixing string BY to them."</span>
     rename <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> name &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> name by<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> co-decorated by
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Rename all elements by prefixing string BY to them."</span>
     rename <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> name &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> by name<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> primed
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"All elements are renamed with a postfix prime."</span>
    decorated <span style="color: #2d9574;">"&#8242;"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Likewise, for the casing approach, let's make a “to list”.
For now, such lists are necessarily enclosed in double-quotes.
</p>

<ul class="org-ul">
<li>Given a string of “;”-separated items consisting of “to”-separated pairs,
interpret it as a Lisp function where “to”-pairs denote mapping clauses.</li>

<li>E.g., “x₀ to y₀; …; xₙ to yₙ” becomes the function sending value xᵢ to yᵢ,
and behaves as the identity function otherwise unless OTHERWISE is provided,
in which case it acts as a fallback.</li>

<li><p>
Concretely:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">      <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> <span style="color: #2d9574;">"1 to x; 2 to y; p to q"</span><span style="color: #3a81c3;">)</span>
    &#8776; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> arg &#8594; <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> arg <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"1"</span> <span style="color: #2d9574;">"x"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"2"</span> <span style="color: #2d9574;">"y"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"p"</span> <span style="color: #2d9574;">"q"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>otherwise otherwise<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Neato: (reify-to-list "x&#8320;; &#8943;; x&#8345;" nil) &#8658; (&#955; x &#8614; If &#8707; i &#8226; x &#8776; x&#7522; then "" else nil)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">KEY is a function applied to the input argument /before/ casing on LHS &#8614; RHS names.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">INVERSE means to interpret clauses &#8220;x to y&#8221; as mappings &#8220;y &#8614; x&#8221;.</span>
   <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">reify-to-list</span> <span style="color: #6c3163;">(</span>str <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>otherwise 'otherwise<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>key #'<span style="color: #6c3163; font-weight: bold;">identity</span><span style="color: #2d9574;">)</span> inverse<span style="color: #6c3163;">)</span>
   <span style="color: #da8b55; background-color: #ecf3ec;">"Transform &#8220;to list&#8221; STR with default OTHERWISE into a Lisp function.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('reify-to-list)&gt;&gt;"</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span>clauses<span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> str
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">";"</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" to "</span> it<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> it<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">accomodate empty str.</span>
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> cs &#8594; <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> inverse <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-rotate</span> 1 it<span style="color: #2d9574;">)</span> cs<span style="color: #6c3163;">)</span> cs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-cons*</span> '<span style="color: #6c3163; font-weight: bold;">pcase</span> `<span style="color: #b1951d;">(</span>,key arg<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> clauses<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #67b11d;">(</span>arg<span style="color: #67b11d;">)</span> ,<span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">append</span> clauses `<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">(</span>otherwise ,otherwise<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(reify-to-list "a to b; c to d" :inverse t) ;; neato!</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> renaming by <span style="color: #6c3163;">(</span>adjoin-retract <span style="color: #715ab1;">t</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>adjoin-coretract nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>support-mixfix-names nil<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Rename elements using BY, a &#8220;;&#8221;-separated string of &#8220;to&#8221;-separated pairs.</span>

<span style="color: #2d9574;">      There is minimal support for mixfix names, which may be tried</span>
<span style="color: #2d9574;">      by setting SUPPORT-MIXFIX-NAMES to be t.</span>

<span style="color: #2d9574;">      When ADJOIN-RETRACT is non-nil, we adjoin a &#8220;record {old&#7522; = name&#7522;}&#8221;</span>
<span style="color: #2d9574;">      view morphism; i.e., record translation.</span>
<span style="color: #2d9574;">"</span>
  <span style="color: #6c3163; font-weight: bold;">map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">map-name</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> n &#8594; <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> by<span style="color: #3a81c3;">)</span> n <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> 'support-mixfix-names<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
         <span style="color: #3a81c3;">:support-mixfix-names</span> 'support-mixfix-names
         <span style="color: #3a81c3;">:adjoin-retract</span> 'adjoin-retract
         <span style="color: #3a81c3;">:adjoin-coretract</span> 'adjoin-coretract
         <span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
It is common in Agda to provide “to”-lists, so we've provide a variant that supports those
instead of forcing users to produce functions explicitly.
</p>

<p>
We may also prefer writing <code>subscriptedᵢ</code> rather than <code>decorated "ᵢ"</code>.
With a bit of Lisp meta-programming, we can generate these variationals.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">to-subscript</span> <span style="color: #6c3163;">(</span>n<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Associate digit N with its subscript.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">If N &#8712; 0..9, then yield &#8345;, else N."</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> n '<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"&#8320;"</span> <span style="color: #2d9574;">"&#8321;"</span> <span style="color: #2d9574;">"&#8322;"</span> <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #2d9574;">"&#8324;"</span> <span style="color: #2d9574;">"&#8325;"</span> <span style="color: #2d9574;">"&#8326;"</span> <span style="color: #2d9574;">"&#8327;"</span> <span style="color: #2d9574;">"&#8328;"</span> <span style="color: #2d9574;">"&#8329;"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> n<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's make a family of variationals.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for i from 0 to 9
      for &#7522;    <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">to-subscript</span> i<span style="color: #6c3163;">)</span>
      for docs <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Subscript all elementes by suffixing them with %s."</span> i<span style="color: #6c3163;">)</span>
      <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> ,<span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">intern</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"subscripted%s"</span> &#7522;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #6c3163; font-weight: bold;">=</span> ,docs decorated ,&#7522;<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here are some example uses.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MR&#8321;&#8322;   = M-Set-Record decorated "&#8321;" &#10228; decorated "&#8322;" :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">the-MR = M-Set-Record co-decorated "the-"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- MR&#8323;&#8324;   = M-Set-Record subscripted&#8323; &#10228; subscripted&#8324; :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338;   = M-Set-Record renaming "Scalar to S; Vector to V; &#183; to nice"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set-Record renaming "Scalar to Carrier; Vector to Carrier; &#183; to &#215;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8321;&#8322;   = M-Set record &#10228; decorated "&#8321;" &#10228; decorated "&#8322;" -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record MR&#8321;&#8322; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Scalar&#8321;&#8322;       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector&#8321;&#8322;       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;&#8321;&#8322;_      : Scalar&#8321;&#8322; &#8594; Vector&#8321;&#8322; &#8594; Vector&#8321;&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;&#8321;&#8322;        : Scalar&#8321;&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;&#8321;&#8322;_      : Scalar&#8321;&#8322; &#8594; Scalar&#8321;&#8322; &#8594; Scalar&#8321;&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId&#8321;&#8322;       : {&#120011; : Vector&#8321;&#8322;}  &#8594;  &#120793;&#8321;&#8322; &#183;&#8321;&#8322; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc&#8321;&#8322;        : {a b : Scalar&#8321;&#8322;} {&#120011; : Vector&#8321;&#8322;} &#8594; (a &#215;&#8321;&#8322; b) &#183;&#8321;&#8322; &#120011;  &#8801;  a &#183;&#8321;&#8322; (b &#183;&#8321;&#8322; &#120011;)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span> <span style="color: #0000cd;">the-MR</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; <span style="color: #0000cd;">co-decorated</span> <span style="color: #2d9574;">"the-"</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span> <span style="color: #0000cd;">the-MR</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">the-Scalar</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">the-Vector</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _<span style="color: #0000cd;">the-</span>&#183;_        : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Vector</span> &#8594; <span style="color: #0000cd;">the-Vector</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">the-</span>&#120793;      : <span style="color: #0000cd;">the-Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _<span style="color: #0000cd;">the-</span>&#215;_        : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> the-<span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; : <span style="color: #0000cd;">the-Vector</span>}  &#8594;  <span style="color: #0000cd;">the-</span>&#120793; <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> the-<span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> : <span style="color: #0000cd;">the-Scalar</span>} {&#120011; : <span style="color: #0000cd;">the-Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#183; (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">the-</span>&#183; &#120011;)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8323;&#8324;   = M-Set record &#10228; subscripted&#8323; &#10228; subscripted&#8324; -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record MR&#8323;&#8324; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Scalar&#8323;&#8324;       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Vector&#8323;&#8324;       : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#183;&#8323;&#8324;_      : Scalar&#8323;&#8324; &#8594; Vector&#8323;&#8324; &#8594; Vector&#8323;&#8324;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;&#8323;&#8324;        : Scalar&#8323;&#8324;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;&#8323;&#8324;_      : Scalar&#8323;&#8324; &#8594; Scalar&#8323;&#8324; &#8594; Scalar&#8323;&#8324;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId&#8323;&#8324;       : {&#120011; : Vector&#8323;&#8324;}  &#8594;  &#120793;&#8323;&#8324; &#183;&#8323;&#8324; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc&#8323;&#8324;        : {a b : Scalar&#8323;&#8324;} {&#120011; : Vector&#8323;&#8324;} &#8594; (a &#215;&#8323;&#8324; b) &#183;&#8323;&#8324; &#120011;  &#8801;  a &#183;&#8323;&#8324; (b &#183;&#8323;&#8324; &#120011;)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8348;&#8338; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #3a81c3; font-weight: bold;">record</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"Scalar to S; Vector to V; &#183; to nice"</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8348;&#8338; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> S</span>      : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> V</span>      : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _<span style="color: #0000cd;">nice_</span>     :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>}  &#8594;  &#120793; <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">nice</span> (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">nice</span> &#120011;)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set record &#10228; renaming "Scalar to Carrier; Vector to Carrier; &#183; to &#215;" -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record NearMonoid : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field Carrier        : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field _&#215;_        : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field &#120793;      : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field leftId     : {&#120011; : Carrier}  &#8594;  &#120793; &#215; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field assoc      : {a b : Carrier} {&#120011; : Carrier} &#8594; (a &#215; b) &#215; &#120011;  &#8801;  a &#215; (b &#215; &#120011;)</span>
</pre>
</div>

<p>
Some observations are in order:
</p>

<ol class="org-ol">
<li><p>
Example <code>M₁₂</code> demonstrates that composition, ⟴, is sequential from left to right.
That is, “⟴” is just forwards composition: We thread the given PackageFormer
through the variationals <code>vᵢ</code> in order. Operationally:
</p>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Pf v₀ ⟴ ⋯ ⟴ vₙ ≈ ((Pf v₀) v₁) ⋯) vₙ</td>
</tr>

<tr>
<td class="org-left">Pf ⟴ v  ≈  Pf v ⟴  ≈  Pf v</td>
</tr>
</tbody>
</table>

<p>
Note: In the concrete syntax, parenthesisation is not permitted.
</p></li>

<li>Notice that the <code>NearMonoid</code> example demonstrates multiplicity of PackageFormer elements is irrelevant.
That is, elements are algebraically a free monoid with the axiom <code>xs ⊕ ys ⊕ xs ≈ xs ⊕ ys</code>.</li>

<li><p>
<b>Notice that we wanted  Agda-style renaming via <code>to</code>-lists, so we simply code that up!</b>
This is so cool: We can just extend the system with whatever pattern we prefer!
No more bending to the will of language designers! More power to the user!
</p>

<p>
For example, we can codify the previous <code>NearMonoid</code> scheme into a top-level pattern.
</p></li>
</ol>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">is-sort</span> <span style="color: #6c3163;">(</span>element<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Check whether the target of ELEMENT&#8217;s type is &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">Set</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;."</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #2d9574;">"Set"</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> element<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Method &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">target</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is defined in the next subsection, on ADTs.</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> single-sorted with-sort
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Replace all nullary sorts with the provided WITH-SORT string</span>
<span style="color: #2d9574;">     as the name of the new single sort, the universe of discourse."</span>
    <span style="color: #6c3163; font-weight: bold;">map</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">is-sort</span> e<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">map-name</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; with-sort<span style="color: #b1951d;">)</span> e<span style="color: #67b11d;">)</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Then the previous PackageFormer can be obtained with:
Note that the following differs from <code>NearMonoid</code> since it has two binary operations:
Our new variational one alters the number and name of sorts, not other elements.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid&#185; = M-Set-Record single-sorted "Carrier"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> NearMonoid</span>&#185; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>        : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;_        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
<b>Exercise:</b>
Write a variational <code>remove-sorts</code> that strips out all sorts from a PackageFormer.
If elements depend on sorts, as they normally do, then one must remove them as well;
ignore this for now, and we shall return to subgenerated PackageFormers later on.
</p>
</div>
</div>
<div id="outline-container-orgd4b1cc5" class="outline-3">
<h3 id="Forming-Syntax-and-the-Special---𝑛𝑎𝑚𝑒--Variable"><span class="section-number-3">3.12</span> Forming Syntax and the Special <code>$𝑛𝑎𝑚𝑒</code> Variable</h3>
<div class="outline-text-3" id="text-Forming-Syntax-and-the-Special---𝑛𝑎𝑚𝑒--Variable">
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><i>Records provide a semantics, what if we want the syntax?</i></td>
</tr>
</tbody>
</table>

<p>
Since <code>data</code> declarations consist of constructors, whose target type necessarily
begins with the name of the <code>data</code>-type being defined, let's only keep those <a href="#orgb32f32d">fields</a> and drop the rest.
To do so, we use the helper function <code>target</code> which takes a declaration <code>name : type0 → ⋯ → typeN</code> and yields <code>typeN</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #6c3163;">(</span>thing<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return final type mentioned in THING, a string declaration.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Given a type-name &#8216;[name :] &#964;&#8320; &#8594; &#8943; &#8594; &#964;&#8345;&#8217;, yield &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">&#964;&#8345;</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; porition is irrelevant."</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-take-last</span> 1 <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"&#8594;"</span> thing<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
With this in hand, a <code>data</code> presentation requires a designated <code>carrier</code> which is used to
keep only those elements that target it. Finally, as data constructor must target the
type being defined, we alter the filtered elements by changing every instance of the
carrier name with the name of the newly defined PackageFormer &#x2014;which we may access
using the special identifier <code>$𝑛𝑎𝑚𝑒</code>. In a <code>lisp</code> block, we formalise this algorithm as follows.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> data carrier
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Reify as an Agda &#8220;data&#8221; type.</span>

<span style="color: #2d9574;">     Only elements targeting CARRIER are kept.</span>
<span style="color: #2d9574;">    "</span>
    <span style="color: #3a81c3;">:kind</span>  data
    <span style="color: #3a81c3;">:level</span> dec
    <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #2d9574;">(</span>es<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> es
        <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> carrier <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">map-type</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> &#964; &#8594; <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> carrier $&#119899;&#119886;&#119898;&#119890; &#964;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> it<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">ScalarTerm = M-Set data "Scalar"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
   &#120793;        :<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span>
   _&#215;_      :<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span>
</pre>
</div>

<p>
Again:
The meta-primitive <code>:alter-elements</code> is instructed to map over those
elements <code>e</code> that contain the <code>carrier</code> in their <code>target</code> type
by replacing the given <code>carrier</code> with the newly-minted <code>$𝑛𝑎𝑚𝑒</code> of
the grouping mechanism being constructed. Those that do not
contain the given <code>carrier</code> in their target type are filtered out.
</p>

<p>
Notice that <code>$𝑛𝑎𝑚𝑒</code> is a special variable that refers to the newly defined PackageFormer's name.
</p>
<ul class="org-ul">
<li>It is written using <code>\Mi</code> with Agda input; e.g., <code>\Min</code> gives <code>𝑛</code>.</li>
<li>The ‘$’ is intended to further mark the special nature of this variable.</li>
</ul>
</div>
</div>

<div id="outline-container-orgc98c0bf" class="outline-3">
<h3 id="Subpacakges-with--generated--sorts--signature-"><span class="section-number-3">3.13</span> Subpacakges with <code>generated, sorts, signature</code></h3>
<div class="outline-text-3" id="text-Subpacakges-with--generated--sorts--signature-">
<p>
A common grouping operation is to zoom-in to the minimal well-formed
package that contains only certain specified elements. For example,
in our <code>M-Set</code> grouping, we may want to keep only <code>𝟙</code> but to be well-defined
we are forced to also keep the elements on which it depends &#x2014;namely, <code>Scalar</code>.
</p>

<p>
In particular, the following naive approach only works if the elements are
independent of one another &#x2014;which is rarely the case for Agda users.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">cute, but too brutish.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> generated by <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #2d9574;">(</span>es<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-filter</span> by es<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The coherent scheme is straightforward to implement.
For clarity, rather than efficiency,
the algorithm below forms a list <code>yeses</code> of the elements that should be kept
then traverses the elements list, adding all elements needed to ensure that list
is coherent. Moreover, for generality, we consider a predicate rather than an explicit
listing of items to be retained.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> generated by
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Keep the largest well-formed PackageFormer whose elements satisfy BY.</span>

<span style="color: #2d9574;">     BY is a predicate on elements.</span>
<span style="color: #2d9574;">    "</span>
    <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> es &#8594; <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--graph-map</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> by it<span style="color: #67b11d;">)</span> it es<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

</pre>
</div>
<p>
Here's an immediate application: Obtaining the types declared in a grouping mechanism.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> sorts
 <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Obtaining the types declared in a grouping mechanism.</span>

<span style="color: #2d9574;">   For now, only base types; i.e., items targeting &#8220;Set&#8221;.</span>
<span style="color: #2d9574;">   "</span>
   generated <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #2d9574;">"Set"</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Sorts = M-Set record &#10228; sorts</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Sorts</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
</pre>
</div>

<p>
We can even obtain a sub-signature wholesale:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidSignature = M-Set-Record generated (&#955; e &#8594; (and (s-contains? "Scalar" (element-type e)) (not (s-contains? "Vector" (element-type e)))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidSignature</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
</pre>
</div>

<p>
This pattern of having a lawless grouping seems sufficiently desirable that we may
codify it.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">targets-a-sort</span> <span style="color: #6c3163;">(</span>element<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Check whether the given ELEMENT targets a sort.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">The sorts considered refer to those of the *current* PacakgeFormer."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--any</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> it <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> element<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
         <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-map</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-filter</span> #'<span style="color: #6c3163; font-weight: bold;">is-sort</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> signature
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Keep only the elements that target a sort, drop all else."</span>
    generated <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> e &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">targets-a-sort</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here's an example.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonSig = M-Set-Record signature</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonSig</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>     : <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
</pre>
</div>

<p>
Neato! Those were some nifty applications!
</p>

<p>
For practicality, let's also introduce a more concrete syntax
analogous to that of <code>renaming</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> keeping those
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Keep THOSE elements, a &#8220;;&#8221;-separated string of proper names,</span>
<span style="color: #2d9574;">    along with the elements that ensure THOSE is well-defined.</span>
<span style="color: #2d9574;"> "</span>
    generated '<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> those <span style="color: #3a81c3;">:otherwise</span> nil <span style="color: #3a81c3;">:key</span> #'<span style="color: #6c3163; font-weight: bold;">element-name</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2a0a246" class="outline-3">
<h3 id="Shallow-Renaming-with-Agda-s--open---public---renaming---"><span class="section-number-3">3.14</span> Shallow Renaming with Agda's <code>open ⋯ public ⋯ renaming ⋯</code></h3>
<div class="outline-text-3" id="text-Shallow-Renaming-with-Agda-s--open---public---renaming---">
<p>
The previous approach to renaming altered field names literally which is not
desirable when one only wants to refer to field names of multiple instances
of the same record &#x2014;e.g., when forming homomorphisms.
</p>

<p>
A common pattern in Agda is then to open the record and perform the desired
shallow renames. This pattern is so common that the standard library is <a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Structures.html#2757">littered</a>
with instances of it.
We can codify the pattern as a method rather than as a
manual technique.
</p>

<p>
Let's go from zero to one-hundred &#x2014;again: There's a Lisp Cheat Sheet that should
have been consulted at one point.
</p>

<p>
Zero: A module where the elements are all <a href="#orged238e3">parameters</a>.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-empty-module = :kind module :level none :waist 999</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Neato = M-Set empty-module</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> A</span> <span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #3a81c3; font-weight: bold;">where</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">elements</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">all</span> <span style="color: #0000cd;">parameters</span> -}
<span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Neato</span> <span style="color: #3a81c3; font-weight: bold;">using</span> ()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">Neato</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) (&#120793; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (_&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (<span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; &#120793; &#183; &#120011; &#8801; &#120011;) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> &#120011;} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011; &#8801; <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)) <span style="color: #3a81c3; font-weight: bold;">where</span>
</pre>
</div>

<p>
One-hundred: A one-parameter module where elements may be renamed.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> open with <span style="color: #6c3163;">(</span>avoid-mixfix-renaming nil<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163; font-weight: bold;">=</span>
    <span style="color: #2d9574;">"Reify a given PackageFormer as a *parameterised* Agda &#8220;module&#8221; declaration.</span>

<span style="color: #2d9574;">     WITH is a renaming, string to string, function that is applied to the parent record that will</span>
<span style="color: #2d9574;">     be opened and reexported as a module.</span>

<span style="color: #2d9574;">     AVOID-MIXFIX-RENAMING is optional; by default renaming &#8220;jumps over&#8221; underscores,</span>
<span style="color: #2d9574;">     but providing a non-nil value for this argument leaves underscores alone.</span>
<span style="color: #2d9574;">     It is a matter of having, say, default &#8220;_&#8853;&#8345;_&#8221; versus &#8220;_&#8853;_&#8345;&#8221;.</span>

<span style="color: #2d9574;">     The resulting module has a parameter, whose name is irrelevant but is</span>
<span style="color: #2d9574;">     of the form &#8220;Arg&#119993;&#119993;&#119993;&#119993;&#8221; for some digits &#119993; in order to minimise clash with</span>
<span style="color: #2d9574;">     any user-defined names.</span>

<span style="color: #2d9574;">     Besides the addition of a new parameter, all element qualifiers are discarded.</span>
<span style="color: #2d9574;">    "</span>
    <span style="color: #3a81c3;">:kind</span> module
    <span style="color: #3a81c3;">:level</span> none
    <span style="color: #3a81c3;">:waist</span> 1
    <span style="color: #3a81c3;">:alter-elements</span>  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #2d9574;">(</span>fs<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>kind <span style="color: #2d9574;">"{! !}"</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>&#8475; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Ar%s"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">gensym</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:name</span> &#8475; <span style="color: #3a81c3;">:type</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #b1951d;">)</span>
          <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>name <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> avoid-mixfix-renaming <span style="color: #3a81c3;">(</span>with <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> with <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
            <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:name</span> name
                          <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"let open %s %s in %s"</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; &#8475; <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                          <span style="color: #3a81c3;">:equations</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = %s.%s %s"</span> name $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> it<span style="color: #3a81c3;">)</span> &#8475;<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #dc752f; background-color: #fbf8ef;">fs</span><span style="color: #b1951d; background-color: #fbf8ef;">)</span><span style="color: #67b11d; background-color: #fbf8ef;">)</span><span style="color: #2d9574; background-color: #fbf8ef;">)</span><span style="color: #6c3163; background-color: #fbf8ef;">)</span><span style="color: #3a81c3; background-color: #fbf8ef;">)</span>
</pre>
</div>

<p>
Notice that we do not need any <code>open ⋯ public</code> since all elements are top-level.
We are not making using of Agda's renaming facility. An example may clarify this observation.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8321; = M-Set-R &#10228; open (&#955; x &#8594; (concat x "&#8321;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8321;<span style="color: #ba2f59; font-weight: bold;"> (Arg6926</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.S<span style="color: #0000cd;">calar</span><span style="color: #ba2f59; font-weight: bold;"> Arg6926</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.V<span style="color: #0000cd;">ector</span><span style="color: #ba2f59; font-weight: bold;"> Arg6926</span>
   _&#183;&#8321;_     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> ;    _&#183;&#8321;_ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#183;_<span style="color: #ba2f59; font-weight: bold;"> Arg6926</span>
   &#120793;&#8321;       : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;  &#120793;&#8321; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.&#120793;<span style="color: #ba2f59; font-weight: bold;"> Arg6926</span>
   _&#215;&#8321;_     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;    _&#215;&#8321;_ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#215;_<span style="color: #ba2f59; font-weight: bold;"> Arg6926</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span> {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; ;    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">leftId Arg6926</span>
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321;       : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6926</span> <span style="color: #3a81c3; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> &#120011;} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) ; <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">assoc Arg6926</span>
</pre>
</div>

<p>
In-case you've skipped over the above source documentation for <code>open</code>, it's time to read it.
</p>

<p>
Notice that a module opening depends on a record, whence the first declaration of <code>M-Set-R</code>.
</p>

<div class="org-center">
<p>
These kind of open-renamings are so common that the tedium
is actually acceptable by most users &#x2014;it shouldn't be
and now it no longer has to be that way.
</p>
</div>

<p>
It is common in Agda to provide “to”-lists, so let's provide a variant that supports those
instead of forcing users to produce functions explicitly.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> opening with
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Open a record as a module exposing only the names mentioned in WITH.</span>

<span style="color: #2d9574;">    WITH is a string of &#8220;;&#8221;-separated items consisting of &#8220;to&#8221;-separated pairs.</span>
<span style="color: #2d9574;">    "</span>
    open <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">reify-to-list</span> with <span style="color: #3a81c3;">:otherwise</span> <span style="color: #2d9574;">"_"</span><span style="color: #67b11d;">)</span> x<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3;">:avoid-mixfix-renaming</span> <span style="color: #715ab1;">t</span><span style="color: #3a81c3;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Alternatively, we could have used &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">trash</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; names,</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">something like (format "%s" (gensym)), instead of "_".</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R-SV = M-Set-R opening "Scalar to S; Vector to V"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
This opens the <code>M-Set-R</code> record <b>exposing only</b> <code>S</code> and <code>V</code> &#x2014;the rest are ignored using Agda's <code>_</code> mechanism.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">M-Set-R-SV</span><span style="color: #ba2f59; font-weight: bold;"> (Arg6933</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> S</span>        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> S</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.S<span style="color: #0000cd;">calar</span><span style="color: #ba2f59; font-weight: bold;"> Arg6933</span>
  <span style="color: #ba2f59; font-weight: bold;"> V</span>        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> V</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.V<span style="color: #0000cd;">ector</span><span style="color: #ba2f59; font-weight: bold;"> Arg6933</span>
   _        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> ;    _ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#183;_<span style="color: #ba2f59; font-weight: bold;"> Arg6933</span>
   _        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;  _ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.&#120793;<span style="color: #ba2f59; font-weight: bold;"> Arg6933</span>
   _        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;    _ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#215;_<span style="color: #ba2f59; font-weight: bold;"> Arg6933</span>
   _        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span> {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; ;    _ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">leftId Arg6933</span>
   _        : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6933</span> <span style="color: #3a81c3; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> &#120011;} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) ; _ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">assoc Arg6933</span>
</pre>
</div>

<p>
After simplifying the <code>let</code>-expressions, this module definition is equivalent to the following
&#x2014;the types of which may be seen with Agda's <code>C-c C-o</code> call.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">M-Set-R-SV</span><span style="color: #ba2f59; font-weight: bold;"> (Arg</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #3a81c3; font-weight: bold;">where</span>
 <span style="color: #ba2f59; font-weight: bold;"> S</span> :<span style="color: #ba2f59; font-weight: bold;"> (Arg</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> S</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.S<span style="color: #0000cd;">calar</span><span style="color: #ba2f59; font-weight: bold;"> Arg</span>
 <span style="color: #ba2f59; font-weight: bold;"> V</span> :<span style="color: #ba2f59; font-weight: bold;"> (Arg</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) &#8594; <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> V</span> <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.V<span style="color: #0000cd;">ector</span><span style="color: #ba2f59; font-weight: bold;"> Arg</span>
</pre>
</div>

<p>
Let's provide an even more common feature: Opening records with a decoration.
For example, when we have two algebraic structures, we might want the first to be subscripted with ₁
and the second with ₂ &#x2014;this is different than <code>subscriptedᵢ</code> from above, which produces a <i>new</i> record
rather than opening it with renames.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> open-with-decoration ddd
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Open a record, exposing all elements, with decoration DDD.</span>

<span style="color: #2d9574;">    DDD is a string.</span>
<span style="color: #2d9574;">   "</span>
   open <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> x ddd<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here's an example.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8242; = M-Set-R open-with-decoration "&#8242;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> (Arg6938</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #3a81c3; font-weight: bold;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.S<span style="color: #0000cd;">calar</span><span style="color: #ba2f59; font-weight: bold;"> Arg6938</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3; font-weight: bold;">Set</span> ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.V<span style="color: #0000cd;">ector</span><span style="color: #ba2f59; font-weight: bold;"> Arg6938</span>
   _&#183;&#8242;_     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> ;    _&#183;&#8242;_ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#183;_<span style="color: #ba2f59; font-weight: bold;"> Arg6938</span>
   &#120793;&#8242;       : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;  &#120793;&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.&#120793;<span style="color: #ba2f59; font-weight: bold;"> Arg6938</span>
   _&#215;&#8242;_     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> ;    _&#215;&#8242;_ <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>._&#215;_<span style="color: #ba2f59; font-weight: bold;"> Arg6938</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242;      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span> {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; ;    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">leftId Arg6938</span>
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242;       : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R Arg6938</span> <span style="color: #3a81c3; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> &#120011;} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) ; <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>.<span style="color: #ba2f59; font-weight: bold;">assoc Arg6938</span>
</pre>
</div>

<p>
Neato petito :smile:
</p>

<div class="org-center">
<p>
It is important to observe that ‘openings’ are lossy:
They lose the types of the declarations and so cannot be used further to construct
new pacaking mechanisms. They are a terminal construction.
</p>
</div>

<p>
In the next section, we make use of such openings to actually produce
homomorphism constructions.
</p>
</div>
</div>

<div id="outline-container-org7cd516c" class="outline-3">
<h3 id="Automatically-deriving-homomorphism-definitions"><span class="section-number-3">3.15</span> Automatically deriving homomorphism definitions ♥‿♥</h3>
<div class="outline-text-3" id="text-Automatically-deriving-homomorphism-definitions">
<p>
The definition of “structure preservation” is, nearly always, mechanical to
formulate and that's just what we shall do to avoid having to write it out
by hand ever again &#x2014;which the <a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Morphism.html#586">current approach</a> in the Agda standard library.
</p>

<p>
The idea is not too complicated:
</p>
<ol class="org-ol">
<li>Suppose you have an operation <code>_·_ : Scalar → Vector → Vector</code>.</li>
<li>Suppose you have a numbering of the sorts; e.g., <code>sort₁ = Scalar, sort₂ = Vector</code>.</li>
<li>Form functions <code>mapᵢ : sortᵢ → sortᵢ′</code></li>
<li>Include implicit arguments in the type: <code>{x₁ : Scalar} → {x₂ : Vector} → Vector</code>.</li>
<li>The target type <code>Vector = sort₂</code> means we need to apply <code>map₂</code> to the expression
formed from the operation's name along with the arguments.
<ul class="org-ul">
<li>The left hand side is thus <code>map₂ (_·_ x₁ x₂)</code>.</li>
</ul></li>
<li>For the right hand side, we use the target-space's name, say <code>_·′_</code>,
along with <code>mapᵢ</code> applied to <code>xᵢ</code> for each <code>i</code> mentioned in the type.</li>

<li>The result:
<code>pres-· : {x₁ : Scalar} → {x₂ : Vector} →   map₂ (_·_ x₁ x₂)   ≡   _·′_ (map₁ x₁) (map₂ x₂)</code>.</li>
</ol>

<p>
First, we need a helper that forms the preservation formulae.
For example:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">show-element</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">homify</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:name</span> <span style="color: #2d9574;">"_&#183;_"</span> <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"Scalar &#8594; Vector &#8594; Vector"</span><span style="color: #2d9574;">)</span>
                      '<span style="color: #2d9574;">(</span> <span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Scalar"</span> . 4<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #2d9574;">"Vector"</span> . 1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
&#8658;
  pres-&#183; : {x&#8324; : Scalar} &#8594; {x&#8321; : Vector}
         &#8594; map&#8321; <span style="color: #3a81c3;">(</span>_&#183;_ x&#8324; x&#8321;<span style="color: #3a81c3;">)</span>   &#8801;   _&#183;&#8242;_ <span style="color: #3a81c3;">(</span>map&#8324; x&#8324;<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>map&#8321; x&#8321;<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
With this as a specification, in a <code>lisp</code> block:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">homify</span> <span style="color: #6c3163;">(</span>element <span style="color: #6c3163; font-weight: bold;">sort</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given a typed name, produce the associating &#8220;preservation&#8221; formula.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">E.g.,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  _&#183;_    : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  pres-&#183; : {x&#8321; : Scalar} &#8594; {x&#8322; : Vector} &#8594; map&#8322; (x&#8321; &#183; x&#8322;) = map&#8321; x&#8321; &#183;&#8242; map&#8322; x&#8322;</span>


<span style="color: #da8b55; background-color: #ecf3ec;">Type &#964; gets variable x&#7522; provided (i, &#964;) &#8712; SORT;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">likewise we think of map&#7522; : &#964; &#8594; &#964;&#8242;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">Notice that the target name is primed, &#8220;&#183;&#8242;&#8221;</span>

<span style="color: #da8b55; background-color: #ecf3ec;">ELEMENT is the typed-name and SORT is the alist of numbered sorts."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">letf*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sorts     <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163; font-weight: bold;">sort</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>index     <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> it &#8594; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">to-subscript</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> it <span style="color: #6c3163; font-weight: bold;">sort</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #67b11d;">(</span>tn&#8594;       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" &#8594; "</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> element<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>arg-count <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">1-</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> tn&#8594;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #67b11d;">(</span>all-indicies  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> index
                                 <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">member</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> it<span style="color: #2d9574;">)</span> sorts<span style="color: #6c3163;">)</span> tn&#8594;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>indicies  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">-drop-last</span> 1 all-indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>tgt-idx   <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-take-last</span> 1 all-indicies<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #67b11d;">(</span>op        <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> element<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>args      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"x"</span> it<span style="color: #3a81c3;">)</span> indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>lhs       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"map%s (%s %s)"</span> tgt-idx op <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span> args<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #67b11d;">(</span>op&#8242;       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #6c3163;">(</span>n<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> n <span style="color: #2d9574;">"&#8242;"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> op<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>map-args  <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"(map%s x%s)"</span> it it<span style="color: #3a81c3;">)</span> indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #67b11d;">(</span>rhs       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s %s"</span> op&#8242; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span> map-args<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">target</span>    <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"  %s   &#8801;   %s"</span> lhs rhs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Change the target type.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> tn&#8594; <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> it <span style="color: #6c3163; font-weight: bold;">sort</span><span style="color: #3a81c3;">)</span>
                       <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"{x%s : %s}"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> index it<span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #dc752f; background-color: #fbf8ef;">tn&#8594;</span><span style="color: #67b11d; background-color: #fbf8ef;">)</span><span style="color: #2d9574; background-color: #fbf8ef;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> arg-count tn&#8594;<span style="color: #67b11d;">)</span> <span style="color: #6c3163; font-weight: bold;">target</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick it all together, with an updated name.</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span>
     <span style="color: #3a81c3;">:name</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"pres-%s"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">""</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> element<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:type</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" &#8594; "</span> tn&#8594;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Then, we form the variational as follows &#x2014;also in a <code>lisp</code> block.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> hom
  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"Formulate the notion of homomorphism of $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; algebras.</span>

<span style="color: #2d9574;">     &#10153; $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; must be an existing record type used in the resulting formulation.</span>
<span style="color: #2d9574;">    "</span>
    <span style="color: #6c3163; font-weight: bold;">record</span> &#10228;
    <span style="color: #3a81c3;">:waist</span> 2
    <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #2d9574;">(</span>es<span style="color: #2d9574;">)</span>

      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span>maps eqns sorts <span style="color: #b1951d;">(</span>&#119982;&#120007;&#119992; <span style="color: #2d9574;">"Src"</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>&#119983;&#8458;&#120009; <span style="color: #2d9574;">"Tgt"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Construct the map&#7522; : sort&#7522; &#8594; sort&#7522;&#8242;; keeping track of (sort . i) pairs.</span>
        <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for e in es
              for i from 1
         <span style="color: #6c3163; font-weight: bold;">do</span>
           <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">is-sort</span> e<span style="color: #3a81c3;">)</span>
             <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #2d9574;">)</span> i<span style="color: #6c3163;">)</span> sorts<span style="color: #3a81c3;">)</span>
             <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span>
                      <span style="color: #3a81c3;">:qualifier</span> <span style="color: #2d9574;">"field"</span>
                      <span style="color: #3a81c3;">:name</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"map%s"</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">to-subscript</span> i<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                      <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s &#8594; %s&#8242;"</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #887070;">)</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                   maps<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

            <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">targets-a-sort</span> e<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">is-sort</span> e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
              <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">homify</span> e sorts<span style="color: #6c3163;">)</span> eqns<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure we have a source and target space as elements.</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-cons*</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:qualifier</span> <span style="color: #2d9574;">"field"</span> <span style="color: #3a81c3;">:name</span> &#119982;&#120007;&#119992; <span style="color: #3a81c3;">:type</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:qualifier</span> <span style="color: #2d9574;">"field"</span> <span style="color: #3a81c3;">:name</span> &#119983;&#8458;&#120009; <span style="color: #3a81c3;">:type</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span>
        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">map-type</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> &#964; &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"let open %s %s; open %s&#8242; %s in %s"</span>
                                 $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; &#119982;&#120007;&#119992; $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; &#119983;&#8458;&#120009; &#964;<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">map-qualifier</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> _ &#8594; <span style="color: #2d9574;">"field"</span><span style="color: #2d9574;">)</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> eqns maps<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here are two examples. <b>Note</b> that the latter allows us to <i>rename</i> the <code>mapᵢ</code> as we
wish &#x2014;which may be preferable to extending the variational to accommodate for new
names.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Algebra  = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Algebra&#8242; = Algebra open-with-decoration "&#8242;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = Algebra hom</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom&#178; = Algebra hom &#10228; renaming "map&#8321; to scalar; pres-&#120793; to unity" :adjoin-retract nil</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">_ : {Src Tgt : Algebra} &#8594; Hom&#178; Src Tgt &#8594; Algebra.Scalar Src &#8594; Algebra.Scalar Tgt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">_ = Hom&#178;.scalar</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = Algebra hom -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">record Hom (Src : Algebra) (Tgt : Algebra) : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field map&#8321;       : let open Algebra Src; open Algebra&#8242; Tgt in Scalar &#8594; Scalar&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field map&#8322;       : let open Algebra Src; open Algebra&#8242; Tgt in Vector &#8594; Vector&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field pres-&#183;     : let open Algebra Src; open Algebra&#8242; Tgt in {x&#8321; : Scalar} &#8594; {x&#8322; : Vector} &#8594;   map&#8322; (_&#183;_ x&#8321; x&#8322;)   &#8801;   _&#183;&#8242;_ (map&#8321; x&#8321;) (map&#8322; x&#8322;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field pres-&#120793;     : let open Algebra Src; open Algebra&#8242; Tgt in   map&#8321; (&#120793; )   &#8801;   &#120793;&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   field pres-&#215;     : let open Algebra Src; open Algebra&#8242; Tgt in {x&#8321; : Scalar} &#8594; {x&#8321; : Scalar} &#8594;   map&#8321; (_&#215;_ x&#8321; x&#8321;)   &#8801;   _&#215;&#8242;_ (map&#8321; x&#8321;) (map&#8321; x&#8321;)</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>&#178; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span> <span style="color: #0000cd;">hom</span> &#10228; <span style="color: #3a81c3; font-weight: bold;">renaming</span> <span style="color: #2d9574;">"map&#8321; to scalar; pres-&#120793; to unity"</span> -}
<span style="color: #3a81c3; font-weight: bold;">record</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>&#178;<span style="color: #ba2f59; font-weight: bold;"> (Src</span> :<span style="color: #ba2f59; font-weight: bold;"> Algebra</span>)<span style="color: #ba2f59; font-weight: bold;"> (Tgt</span> :<span style="color: #ba2f59; font-weight: bold;"> Algebra</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">scalar</span>     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra Src</span>; <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> Tgt</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">map</span>&#8322;       : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra Src</span>; <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> Tgt</span> <span style="color: #3a81c3; font-weight: bold;">in</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">pres-</span>&#183;     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra Src</span>; <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> Tgt</span> <span style="color: #3a81c3; font-weight: bold;">in</span> {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8322; (_&#183;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8322;)   &#8801;   _&#183;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8322; <span style="color: #0000cd;">x</span>&#8322;)
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">unity</span>      : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra Src</span>; <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> Tgt</span> <span style="color: #3a81c3; font-weight: bold;">in</span>   <span style="color: #0000cd;">scalar</span> (&#120793; )   &#8801;   &#120793;&#8242;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #0000cd;">pres-</span>&#215;     : <span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra Src</span>; <span style="color: #3a81c3; font-weight: bold;">open</span><span style="color: #ba2f59; font-weight: bold;"> Algebra</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> Tgt</span> <span style="color: #3a81c3; font-weight: bold;">in</span> {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594;   <span style="color: #0000cd;">scalar</span> (_&#215;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)   &#8801;   _&#215;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;)
</pre>
</div>

<p>
This is so cool (•̀ᴗ•́)و
</p>

<p>
We leave it to the reader to derive other constructs from a theory presentation.
Examples can be found in these <a href="https://alhassy.github.io/next-700-module-systems/papers/JC_Program_Generation_Talk_IFIP.pdf">Metaprogramming Agda</a> slides:
Homomorphism equality, application to carrier elements, isomorphisms,
isomorphisms where only one direction needs to preserve the structure
and an automatically derivable proof that the other direction is also
structure preserving, endomorphism and automorphism types, kernels,
product &amp; sum &amp; other categorical types.
</p>

<dl class="org-dl">
<dt>Challenge</dt><dd>Design a scheme to produce simple Cartesian products from a given theory.

<ol class="org-ol">
<li><p>
The only variable to this problem is an arbitrary record, say it is <code>M</code>.
</p>

<p>
For this exercise to be tractable, assume <code>M</code> consists of declarations
of sort symbols, function symbols, and nullary (non-implication) equations
which may have implicit arguments.
</p></li>

<li>Ensure you understood the definition of the homomorphism scheme above.</li>
<li>Mimic the homomorphism scheme to produce a typed <code>Prod</code> where <code>Prod A₀ A₁</code>
consists of a <code>M</code> value, say <code>P</code>, and two homomorphisms <code>Hom P Aᵢ</code>.</li>
<li>Write a Lisp code that produces a function <code>MakeProduct : (A₀ A₁ : M) → Prod A₀ A₁</code>.

<ul class="org-ul">
<li>The projection morphisms are straightforward.</li>
<li>Every <i>n</i>-ary function <code>f</code> could be defined by <code>fₚ = zipₙ f₀ f₁</code>.</li>
<li>Every equation <code>e</code> could be defined by <code>eₚ = cong₂ _,_ e₀ e₁</code>.</li>
</ul></li>

<li>If you have actually attempted this, then go on to include the remaining
artefacts to make the construction an actual categorical product.</li>
</ol></dd>
</dl>
</div>
</div>

<div class="outline-text-2" id="text-User-Manual-II--Extending-the-System">
</div>
</div>
<div id="outline-container-org409e4e2" class="outline-2">
<h2 id="Strings-and-Things"><span class="section-number-2">4</span> Strings and Things</h2>
<div class="outline-text-2" id="text-Strings-and-Things">
<p>
Since our prototype is intended to be as minimally obtrusive as possible, we will
need to extract our special 700-syntactical items between delimited tokens
and process them.
</p>

<p>
The following subsections introduce:
</p>
<dl class="org-dl">
<dt><code>get-children</code></dt><dd>Obtaining intended items from a hierarchical listing.</dd>
<dt><code>sub-string-delimited-here</code></dt><dd>Finding the shortest substring between a prefix
<code>𝑳</code> and a postfix <code>𝑹</code> by using the ‘metavariable’ <code>$here</code>; e.g., <code>“𝑳 $here 𝑹”.</code></dd>
<dt><code>buffer-substring-delimited-whole-buffer</code></dt><dd>Yield all portions of the
buffer enclosed in the given delimiters, as a list of strings.</dd>
<dt><code>rename-mixfix</code></dt><dd>Renamaing Agda mixifix names where the rename operation
ignores the outermost (Agda) argument position markers ‘_’.</dd>
<dt><code>extract-imports</code></dt><dd>Obtain all ‘import’ clauses so that they can be
ported over to the generated file.</dd>
</dl>

<p>
First we include an Emacs Lisp <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Library-Headers.html#Library-Headers">library header</a> which declares important meta-data
&#x2014;with the aim of having the resulting software
be distributed with Emacs's largest package repository, MELPA.
Installing this package, from within Emacs, also automatically installs its dependencies,
recursively.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">agda-next-700-module-systems.el --- Making Modules with Meta-Programmed Meta-Primitives, for Agda</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Author: Musa Al-hassy <a href="mailto:alhassy%40gmail.com">&lt;alhassy@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Version: 1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Package-Requires: ((s "1.12.0") (dash "2.16.0") (origami "1.0")  (emacs "24.4"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keywords: agda, modules, packages, theories, languages, convenience, maint, tools</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">URL: https://alhassy.github.io/next-700-module-systems</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Copyright (c) 2019 Musa Al-hassy</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This program is free software; you can redistribute it and/or modify</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">it under the terms of the GNU General Public License as published by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the Free Software Foundation, either version 3 of the License, or</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(at your option) any later version.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This program is distributed in the hope that it will be useful,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">GNU General Public License for more details.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">You should have received a copy of the GNU General Public License</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">along with this program.  If not, see <a href="http://www.gnu.org/licenses/">&lt;http://www.gnu.org/licenses/&gt;</a>.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Commentary:</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This program is intended to reduce the burden in selecting</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the form of records and other kinds of packages in Agda.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For example, the decision of whether a record element should be</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">declared as a field or as a parameter no longer needs to be performed</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">prematurely but rather may be selected when necessary.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We cannot use lexical binding since the package provides a macro called &#119985;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">that acts as an interface for a DSL that generates Lisp functions</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">which requires EVAL to bind staged formal arguments to their runtime values.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This el file has been tangled from a literate, org-mode, file.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">See the documentation on:</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://alhassy.github.io/next-700-module-systems/prototype/package-former.html</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Code:</span>
</pre>
</div>

<p>
First some useful libraries:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">String and list manipulation libraries</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/dash.el</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/s.el</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">s</span><span style="color: #3a81c3;">)</span>               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;The long lost Emacs string manipulation library&#8221;</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">dash</span><span style="color: #3a81c3;">)</span>            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;A modern list library for Emacs&#8221;</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">dash-functional</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Function library; &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">-const</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">-compose</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">-orfn</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">-not</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">-partial</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, etc.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">origami</span><span style="color: #3a81c3;">)</span>         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Folding away regions of text</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">subr-x</span><span style="color: #3a81c3;">)</span>          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Extra Lisp functions; e.g., &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">when-let</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">ert</span><span style="color: #3a81c3;">)</span>             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Testing framework; &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">should</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; for assertions</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">require</span> '<span style="color: #4e3163;">cl-lib</span><span style="color: #3a81c3;">)</span>          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">New Common Lisp library; &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">cl-???</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; forms.</span>
</pre>
</div>
</div>

<div id="outline-container-org8e3f1b8" class="outline-3">
<h3 id="Finding-Children-in-the-Wild"><span class="section-number-3">4.1</span> Finding Children in the Wild</h3>
<div class="outline-text-3" id="text-Finding-Children-in-the-Wild">
<p>
Being a prototype, we are talking a mostly string-based approach to working
with hierarchical phrases.
For example, consider the following todo list,
</p>
<div class="org-src-container">
<pre class="src src-org" id="org52172c3">+ item 0
+ item 1
  - subitem 1.1
    * subsubitem 1.1.1
  - subitem 1.2
+ item 2
  - subitem 2.2
+ item 3
</pre>
</div>

<ul class="org-ul">
<li>item 0</li>
<li>item 1
<ul class="org-ul">
<li>subitem 1.1
<ul class="org-ul">
<li>subsubitem 1.1.1</li>
</ul></li>
<li>subitem 1.2</li>
</ul></li>
<li>item 2
<ul class="org-ul">
<li>subitem 2.2</li>
</ul></li>
<li>item 3</li>
</ul>

<p>
We would think that <code>item 1</code> has two ‘children’, and, moreover, one grand-child.
Whereas <code>item 2</code> has a single child and <code>item 3</code> is barren.
</p>

<p>
Here's my intuitive algorithm: We obtain the indentation of the first child,
then all subsequent lines with at least that much indentation have the same ancestor.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-indentation Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(pf--declare-type pf--get-indentation : string integer)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"How many spaces are there at the front of STRING?</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Property: The resulting number is &#8804; length STRING."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163; font-weight: bold;">string</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-shared-start</span> <span style="color: #6c3163; font-weight: bold;">string</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-repeat</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> 0<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-children Implementation </font> </strong> </summary>

<p>
Go into ‘the-wild’ seeking out the first occurence of ‘parent’,
who once found, ought to have a minimal indentation for its children.
</p>

<p>
“Minimal” in that if there are items with a greater indentation,
then they are children of children and should be kept.
</p>

<p>
The first input argument is of type ‘string’,
the second argument may be of type ‘string’ or ‘list’ of strings
&#x2014;if it's a string, we split along new lines&#x2014;,
the optional ‘then’ is a function acting on children strings.
</p>

<p>
Result is the parent followed by its children, as a list of lines,
where each child has been altered using the optional THEN function.
Moreover, we also return the rest of the unconsidered portion of THE-WILD:
</p>

<p>
Result list: (unconsidered-prefix-of-the-wild
              (cons parent-line children-lines)
              unconsidered-remaining-lines)
</p>

<p>
The first element is the porition that does not contain an occurence
of PARENT.  The second is the parent and its children, if possible.
The third is the remainder of THE-WILD.
</p>

<p>
Implementation: Look at the indentation of the
first child, then use that as a lower bound to find the indentation
of the remaining children.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #6c3163;">(</span>parent the-wild <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>then #'<span style="color: #6c3163; font-weight: bold;">identity</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Returns indented text under a PARENT line.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('get-children)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>lines <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">stringp</span> the-wild<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-lines</span> the-wild<span style="color: #3a81c3;">)</span> the-wild<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>indentation -1<span style="color: #67b11d;">)</span>
        unconsidered
        prefix
        lines&amp;more
        parent-line<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure: lines &#8776; (cons (not-here-prefix) (cons parent-here more-lines) )</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--split-with</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> parent it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Discard prefix, for now.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> prefix <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Discard parent, but remember its contextual line.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> parent-line <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">How far is the first child indented? At least 1 space; otherwise no children.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> indentation <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">max</span> 1 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keep only the children that have at least this level of indentation.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines&amp;more
          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--split-with</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;=</span> indentation <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> unconsidered <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Alter the children according to the given function.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> then lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Yield the parent line along with the children lines;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and the unconsumed wild's prefix and suffix.</span>
    `<span style="color: #2d9574;">(</span>,prefix ,<span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> parent-line lines<span style="color: #67b11d;">)</span> ,unconsidered<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Let's try this out on our example hierarchy, <code>eh</code>, from earlier.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"+ item 1"</span> eh<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
(pf&#x2013;load-package-former (cadr (pf&#x2013;get-children "PackageFormer"
"PackageFormer Test : Set₁ where
PackageFormer Another : Set₁ where
")))
</p>

<p>
Excellent! Let's looks at the other parents.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"+ item 2"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 0</td>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>

<tr>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Notice that we found the parent <code>+ item 2</code> and its only child <code>- subitem 1.2</code>, and
we kept the prefix of <code>eh</code> that did not contain the parent as well as
the remaining unconsidered portion of <code>eh</code>. &#x2014;Moreover, it looks like we obtained
the transpose of the example hierarchy 😛
</p>

<p>
Finally, the barren parents.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"+ item 0"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 0</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
<td class="org-left">+ item 3</td>
</tr>
</tbody>
</table>

<p>
As well as,
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"+ item 3"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 0</td>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Everything before it is considered the prefix. Yay :smile:
</p>

<p>
Before we move on, let's try altering a child clause; e.g., I'd like
<code>* subitem 1.1.1</code> to be renamed to <code>* subitem that is super deep</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"+ item 1"</span> eh
 <span style="color: #3a81c3;">:then</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"1.1.1"</span> <span style="color: #2d9574;">"that is super deep"</span> x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem that is super deep</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Nice :grin:
</p>

<p>
Now the moment of truth, let's try this out on our example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span> <span style="color: #3a81c3; font-weight: bold;">|</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">|</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">|</span> _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #3a81c3; font-weight: bold;">|</span> &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #3a81c3; font-weight: bold;">|</span> _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; <span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) <span style="color: #3a81c3; font-weight: bold;">|</span>
</pre>
</div>

<p>
Also, does the list variant work:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-lines</span> test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span> <span style="color: #3a81c3; font-weight: bold;">|</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">|</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">|</span> _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #3a81c3; font-weight: bold;">|</span> &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #3a81c3; font-weight: bold;">|</span> _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; <span style="color: #3a81c3; font-weight: bold;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) <span style="color: #3a81c3; font-weight: bold;">|</span>
</pre>
</div>

<p>
Test-driven development doesn't seem bad 😲
</p>

<p>
These pretty-coloured tests and results may be nice for exposition,
however for maintenance it is ideal to include unit tests that can
be checked without human intervention. <code>M-x ert &lt;RET&gt; t &lt;RET&gt;</code>, after
executing the following block, will report which tests pass and tries to explain
why tests fail.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">get-ind</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for s in '<span style="color: #2d9574;">(</span>nil <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"x"</span> <span style="color: #2d9574;">"  x"</span> <span style="color: #2d9574;">"  x "</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;=</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> s<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> s<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">get-child</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>eh
<span style="color: #2d9574;">"+ item 1</span>
<span style="color: #2d9574;">  - subitem 1.1</span>
<span style="color: #2d9574;">    * subsubitem 1.1.1</span>
<span style="color: #2d9574;">  - subitem 1.2</span>
<span style="color: #2d9574;">+ item 2</span>
<span style="color: #2d9574;">  - subitem 2.2</span>
<span style="color: #2d9574;">+ item 3"</span><span style="color: #2d9574;">]</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Consider each line above as a parent, with &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">eh</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; as the wild.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for parent in <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"\n"</span> eh<span style="color: #67b11d;">)</span> <span style="color: #6c3163; font-weight: bold;">do</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">(</span>cs <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> parent eh<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
         <span style="color: #3a81c3;">(</span>children <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdadr</span> cs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Result is a list of lists: Each is either nil or a cons.</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for r in cs <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">listp</span> r<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The parent line contains the parent.</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> parent <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">caadr</span> cs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The children all have the same indentation.</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for c in children for d in children
            <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> c<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> d<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Extensionality: Orginal input can be regained from resulting parts.</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> eh <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> it<span style="color: #3a81c3;">)</span> cs<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org290bd6d" class="outline-3">
<h3 id="Substrings-Delimited-by-Tokens"><span class="section-number-3">4.2</span> Substrings Delimited by Tokens</h3>
<div class="outline-text-3" id="text-Substrings-Delimited-by-Tokens">
<div class="org-center">
<p>
<i>How do we find a string delimited by two tokens?</i>
</p>
</div>

<p>
Before we can get to the real stuff, we need to produce a few low-level &#x2014;string manipulation&#x2014;
utilities, so that we can work with higher-level abstract datatypes.
</p>

<ul class="org-ul">
<li><code>substring-delimited</code>: Given <code>prefix</code> and <code>suffix</code>,
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
<li><code>substring-delimited-here</code>: Given <code>"⟪prefix⟫ $here ⟪suffix⟫"</code>
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited Implementation </font> </strong> </summary>

<p>
We convert all adjacent whitespace
characters to a single space in the input STRING and trim any surrounding
whitespace from the resulting output needle string.
</p>

<ul class="org-ul">
<li>NOTE: Delimiters PREFIX and SUFFIX may be empty.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #6c3163;">(</span>prefix suffix <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Assuming &#8220;STRING &#8776; &#8943;PREFIX&#10218;needle&#10219;SUFFIX&#8943;&#8221;, return the first such needle.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('substring-delimited)&gt;&gt;"</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">stringp</span> <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"PF--SUBSTRING-DELIMITED: Argument STRING must be a string"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>new <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span> <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> prefix<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> new <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-take-last</span>
                      <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> prefix suffix<span style="color: #2d9574;">)</span> 2 1<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> prefix new<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> suffix<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> new <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> suffix new<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> new<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">subst-delimit</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>str <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #2d9574;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Pattern for loop: (prefix postfix expected-needle :comment))</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for it in `<span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">""</span> ,str            <span style="color: #3a81c3;">:Identity</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792;"</span> <span style="color: #2d9574;">"&#120798;"</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:Boundaries</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#120798;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span> <span style="color: #3a81c3;">:NoLeft</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792;"</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #3a81c3;">:NoRight</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800;"</span> <span style="color: #2d9574;">""</span>  ,str          <span style="color: #3a81c3;">:BogusL</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#8734;"</span>  ,str          <span style="color: #3a81c3;">:BogusR</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800;"</span> <span style="color: #2d9574;">"&#8734;"</span> ,str          <span style="color: #3a81c3;">:BogusLR</span><span style="color: #b1951d;">)</span>
             <span style="color: #67b11d;">)</span>
      <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">third</span> it<span style="color: #3a81c3;">)</span>
                        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">second</span> it<span style="color: #6c3163;">)</span> str<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120795;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#120794;"</span> <span style="color: #2d9574;">"&#120796;"</span> str<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Identical boundaries.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923; &#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;&#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiple occurances of prefix or postfix</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"y"</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"x"</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> pf--substring-delimited-here Implementation </font> </strong> </summary>

<ul class="org-ul">
<li><p>
That is, assuming “CONTEXT ≈ PREFIX $here SUFFIX”
and “STRING ≈ ⋯PREFIX ⟪needle⟫ SUFFIX⋯”, return the <i>first</i> such needle.
</p>

<p>
That is, we place template CONTEXT “on top of” provide STRING,
then return whatever falls under position ‘$here’.
</p></li>

<li>NOTE: PREFIX and SUFFIX cannot be empty strings!</li>

<li>We convert all adjacent whitespace
characters to a single space in the input ‘string’ and trim any surrounding
whitespace from the resulting output needle string.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #6c3163;">(</span>context <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #6c3163;">)</span> <span style="color: #da8b55; background-color: #ecf3ec;">"\</span>
<span style="color: #da8b55; background-color: #ecf3ec;">Assuming &#8220;CONTEXT &#8776; PREFIX $here SUFFIX&#8221; yield the value of needle &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">$here</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('substring-delimited-here)&gt;&gt;"</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>pre-post <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"$here"</span> context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> pre-post<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                             <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> pre-post<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                             <span style="color: #6c3163; font-weight: bold;">string</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">subst-delimit-here</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>str <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #2d9574;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Pattern for loop: (prefix postfix expected-needle :comment)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for it in `<span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here"</span> ,str              <span style="color: #3a81c3;">:Identity</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792; $here &#120798;"</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:Boundaries</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here &#120798;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:NoLeft</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792; $here"</span>  <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #3a81c3;">:NoRight</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800; $here"</span>   ,str          <span style="color: #3a81c3;">:BogusL</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here &#8734;"</span>   ,str          <span style="color: #3a81c3;">:BogusR</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800; $here &#8734;"</span> ,str          <span style="color: #3a81c3;">:BogusLR</span><span style="color: #b1951d;">)</span>
             <span style="color: #67b11d;">)</span>
      <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">second</span> it<span style="color: #3a81c3;">)</span>
                        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> it<span style="color: #6c3163;">)</span> str<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Longest substring</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120795;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#120794; $here &#120796;"</span> str<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Identical boundaries.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792; &#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792;&#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiple occurances of prefix or postfix</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"y"</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"x"</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Space irrelevance for keyword &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">$here</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;:</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923; $here&#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923;$here &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923;$here&#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"&#119923;      $here  &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Suppose a user provides us with an awkwardly spaced PackageFormer header,
our string manipulation setup is robust enough to get at the constituents:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #6c3163;">[</span>header <span style="color: #2d9574;">"PackageFormer  Semigroup   (  v : Variation) : Set (  &#8467;expr)   where"</span><span style="color: #6c3163;">]</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Three kinds of invocations; the last is my preferred choice &#9829;&#8255;&#9829;</span>
  `<span style="color: #6c3163;">(</span> ,<span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited</span> <span style="color: #2d9574;">"PackageFormer "</span> <span style="color: #2d9574;">"("</span> header<span style="color: #2d9574;">)</span>
     ,<span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"PackageFormer $here ("</span> header<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Semigroup</td>
<td class="org-left">Semigroup</td>
</tr>
</tbody>
</table>

<p>
The aim is to eventually have an interface that interacts with an buffer containing Agda code.
To that end, we propose that our fictitious syntax be directly embedded via special comments,
<code>{-700 ⋯ -}</code>, henceforth referred to as “<a id="org81f2700">700-comments</a>”.
</p>

<ul class="org-ul">
<li><code>(pf--buffer-substring-delimited starting-regexp ending-regexp)</code> yields the <i>next</i> portion of the buffer
as a string, relative to the current position of the cursor, that is contained in the ‘parenthesis’
<code>starting-regexp</code> and <code>ending-regexp</code>.</li>

<li><code>(pf--buffer-substring-delimited-whole-buffer starting-regexp ending-regexp)</code> yields <i>all</i> portions of the buffer,
contained in the ‘parenthesis’ <code>starting-regexp</code> and <code>ending-regexp</code>, as a list of strings.

<ul class="org-ul">
<li>Cursor position is saved.</li>
<li>This function let's us obtain the contents of <i>all</i> <a href="#org81f2700">700-comments</a>.</li>
</ul></li>
</ul>

<p>
Where we have the following value:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf-folding</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"Should 700 and Lisp blocks be folded away when &#119914;-&#119888; &#119914;-&#119897;."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> pf--buffer-substring-delimited Implementation </font> </strong> </summary>
<ul class="org-ul">
<li>Get the current buffer's <i>next</i> available substring that is delimited
between the regexp tokens START up to END, exclusively.</li>

<li>If no tokens are found, an error is thrown.</li>

<li>MORE is a function that is called on the found instance:
It is a function of the start and end positions of the occurance.</li>

<li>REGEXP indicates whether we are using regular expression strings, or literals.
It is nil by default.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pf--declare-type has no support for optionals yet</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited</span>
    <span style="color: #6c3163;">(</span>start end <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> more <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>regexp <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return next delimited substring in the current buffer.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('buffer-substring-delimited)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span>start-pos end-pos sp ep content<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> regexp <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">re-search-forward</span> start<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">search-forward</span> start<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> start-pos <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">backward-word</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> sp <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> regexp <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">re-search-forward</span> end<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">search-forward</span> end<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> ep <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">backward-word</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> end-pos <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> content  <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">buffer-substring-no-properties</span> start-pos end-pos<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> more <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> more sp ep<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #715ab1;">pf-folding</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">origami-close-node-recursively</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">current-buffer</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    content<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> pf--buffer-substring-delimited-whole-buffer Implementation </font> </strong> </summary>
<ul class="org-ul">
<li>Return a list of all substrings in the current buffer that
are delimited by regexp tokens START and END, exclusively.</li>

<li>MORE is a function that is called on the found instance:
It is a function of the start and end positions of the occurance.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pf--declare-type has no support for optionals yet</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited-whole-buffer</span> <span style="color: #6c3163;">(</span>start end <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> more<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return all delimited substrings in the current buffer.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('buffer-substring-delimited-whole-buffer)&gt;&gt;"</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Colour 700 keywords red &#8220;'error&#8221;</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">highlight-phrase</span> start '<span style="color: #6c3163; font-weight: bold;">error</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">highlight-phrase</span> end '<span style="color: #6c3163; font-weight: bold;">error</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">save-excursion</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>l nil<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>continue <span style="color: #715ab1;">t</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">while</span> continue
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">condition-case</span> nil
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">attemptClause</span>
     <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> l <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited</span> start end more<span style="color: #2d9574;">)</span> l<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">recoveryBody</span>
     <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> continue nil<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We've collected items as we saw them, so &#8216;l&#8217; is in reverse.</span>
    <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> l<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Here are some possible invocations, the last one being our use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by quotes</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited</span> <span style="color: #2d9574;">"^\""</span> <span style="color: #2d9574;">"^\""</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by usual Agda comments</span>
<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited</span> <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Execute the following in an Agda buffer to see this function in action.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> it <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited-whole-buffer</span> <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7463337" class="outline-3">
<h3 id="Agda-Mixfix-Renaming-and-Imports"><span class="section-number-3">4.3</span> Agda Mixfix Renaming and Imports</h3>
<div class="outline-text-3" id="text-Agda-Mixfix-Renaming-and-Imports">
<p>
Renamaing Agda mixifix names where the rename operation ignores the outermost
position markers ‘_’.
</p>

<ul class="org-ul">
<li>Given an Agda mixfix operator OP, apply a function on strings F on
the inner-most delimiting tokens of the operator, in-particular ignoring
outer argument markers ‘_’.</li>

<li>For example, if you wish to decorate an operator with a prime or a subscript,
we cannot simply catenate else we obtain “_⊕_₁” rather than “_⊕₁_”.</li>

<li>Here are some sample results, assuming “f ≈ (λ it → (format “₀%s¹” it))”:
<ul class="org-ul">
<li><span class="underline">⊕</span>     ↦  <span class="underline">₀⊕¹</span></li>
<li>_[_⊗_]  ↦  _₀[_⊗_]¹</li>
<li>he<sub>lo</sub>   ↦  ₀he<sub>lo</sub>¹</li>
<li>he-lo   ↦  ₀he-lo¹</li>
</ul></li>

<li><p>
AVOID-MIXFIX-RENAMING is optional; by default renaming “jumps over”
underscores, but providing a non-nil value for this argument leaves
underscores alone.
</p>

<p>
It is a matter of having, say, default “_⊕ₙ_” versus “_⊕<sub>ₙ</sub>”.
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> <span style="color: #6c3163;">(</span>f op <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> avoid-mixfix-renaming<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Rename an operation by &#8220;leaping over&#8221; Agda positional markers.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('rename-mixfix)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>parts <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"_"</span> op<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>front <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> parts<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>rear <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">last</span> parts<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> avoid-mixfix-renaming
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> f op<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--&gt;</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> front <span style="color: #2d9574;">"_"</span><span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">"$here"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> rear <span style="color: #2d9574;">"_"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> it op<span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> f it<span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> front <span style="color: #2d9574;">"_"</span><span style="color: #3a81c3;">)</span> it <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> rear <span style="color: #2d9574;">"_"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We also want to prefix the generated file with the imports of the current file.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> extract-imports Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf-generated-suffix</span> <span style="color: #2d9574;">"-generated"</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"The suffix applied to a file's name to produce it's generated counterpart."</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sometimes we may want the full name due to files being in a nested</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">directory hierarchy: (file-name-sans-extension buffer-file-name)</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--generated-file-name</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Name of the generated file."</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">file-name-sans-extension</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">buffer-name</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #715ab1;">pf-generated-suffix</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--extract-imports</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return substring of buffer whose lines mention &#8220;import&#8221;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Throw away any that mention the substring &#8220;&#10218;FileName&#10219;-generated&#8221;."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">buffer-substring-no-properties</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point-max</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #2d9574;">"import "</span> it<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--remove</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--generated-file-name</span><span style="color: #b1951d;">)</span> it<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
So much string meddling, hopefully no more 🙈 :hear<sub>no</sub><sub>evil</sub>: :speak<sub>no</sub><sub>evil</sub>:
</p>
</div>
</div>

<div id="outline-container-org79ae19a" class="outline-3">
<h3 id="-λ--for-the-Agda-User"><span class="section-number-3">4.4</span> “λ” for the Agda User</h3>
<div class="outline-text-3" id="text--λ--for-the-Agda-User">
<p>
Let's make this prototype more accessible to the Agda user
by providing an abbreviation of Lisp functions <code>(lambda (x₀ … xₙ) body)</code>
into the Agda-like syntax <code>(λ x₀ ⋯ xₙ → body)</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">&#955;</span> <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Implementing Agda style, interactive, lambdas; ideally for inline use:</span>

<span style="color: #da8b55; background-color: #ecf3ec;">&#8220;&#955; &#945; &#946; &#8230; &#969; &#8594; BODY&#8221;  becomes an interactive function with arguments &#945;, &#8230;, &#969;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">The args list may be empty, in which case the separator &#8220;&#8594;&#8221; may be omitted</span>
<span style="color: #da8b55; background-color: #ecf3ec;">entirely, if desired.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">A BODY must always be supplied, even if the literal nil."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>parts <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">-split-on</span> '&#8594; body<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> args <span style="color: #6c3163; font-weight: bold;">rest</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;=</span> 2 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> parts<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> args <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> parts<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #6c3163; font-weight: bold;">rest</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> parts<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Otherwise, only one part was found ---no arguments were provided.</span>
         <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> args nil<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #6c3163; font-weight: bold;">rest</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> parts<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

   `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> ,args <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #67b11d;">)</span> ,@rest<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org253a37e" class="outline-2">
<h2 id="The--package-former--Datatype"><span class="section-number-2">5</span> The <code>package-former</code> Datatype</h2>
<div class="outline-text-2" id="text-The--package-former--Datatype">
<p>
For this prototype's <a href="#org83c5020">constraints</a>, a PackageFormer will generally declared as
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer Name</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #0000cd;">level</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
     &#8942;
</pre>
</div>

<p>
The body, <code>⋮</code>, of such a declaration consists of a number of name-type declarations
and, equations ---<b>not yet supported</b>&#x2014; so let's form a type to work with these
components rather than meddle with strings all the time.
</p>

<ul class="org-ul">
<li>‘docstring’: Relevant documentation about this structure; e.g.,
what is the instance declaration that generated this type, if any.</li>

<li>‘kind’: PackageFormer, record, data, module, function, etc.</li>

<li>‘name’: The name of the grouping mechanism schema.</li>

<li>‘level’: The universe level that the instantiations will inhabit.
The universe level of the PackageFormer.</li>

<li>Finally, the children <a href="#orgb32f32d">fields</a> are the typed-names that constitute the body of the
grouping mechanism. As long as consistent indentation is selected, it does not matter how much.
As such, we keep track of these indentation numerics ourselves in case we need to tweak them.</li>

<li>The first ‘waist’-many elements are considered <a href="#orged238e3">parameters</a>.</li>
</ul>

<p>
TODO: Eventually need to support variations?
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defstruct</span> pf--package-former
  <span style="color: #da8b55; background-color: #ecf3ec;">"Record of components that form a PackageFormer.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('package-former)&gt;&gt;"</span>
  docstring
  kind
  name
  level

  waist <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Delimits elements into parameters and fields.</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">children</span>
  indentation <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">useful for when new elements are added.</span>
  elements
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We will keep track of all such declarations in a global list, and provide a minimal user-interface to it.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf--package-formers</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"The list of PackageFormer schema declarations in the current Agda buffer."</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;-&#119900;&#119891;</span> <span style="color: #6c3163;">(</span>pf<span style="color: #6c3163;">)</span>
 <span style="color: #da8b55; background-color: #ecf3ec;">"Return elements of a given PackageFormer's name, PF.</span>

<span style="color: #da8b55; background-color: #ecf3ec;"> This is provided to users; it is one of the few utilities that</span>
<span style="color: #da8b55; background-color: #ecf3ec;"> makes use of implementation specfic details.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box (format "%s" (nth 1 (backtrace-frame 30))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-let [here (progn (goto-char (point-min)) (search-forward pf) (thing-at-point 'line 'no-properties))]</span>

 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure the given PackageFormer is defined.</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> pf <span style="color: #715ab1;">pf--package-formers</span><span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Undefined PackageFormer &#8220;%s&#8221;"</span> pf<span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> pf<span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">"Ensure you spelled the name correctly."</span>
             <span style="color: #2d9574;">"Use the PackageFormer menu to see which PackageFormers are defined."</span><span style="color: #6c3163;">)</span>

 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return its elements.</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> pf <span style="color: #715ab1;">pf--package-formers</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's also declare a global variable for keeping track of whether 700-syntactical
should be coloured or not. Below we use a particular set of default colours.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf-highlighting</span> <span style="color: #715ab1;">t</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Should PackageFormer syntactical items be coloured?</span>

<span style="color: #da8b55; background-color: #ecf3ec;">&#10153; Yellow for PackageFormer content.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&#10153; Red for delimiters 700 and Lisp.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&#10153; Green for names of variationals."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-orge3bb030" class="outline-3">
<h3 id="Locally-Opening-a-PackageFormer"><span class="section-number-3">5.1</span> Locally Opening a PackageFormer</h3>
<div class="outline-text-3" id="text-Locally-Opening-a-PackageFormer">
<p>
It will get rather redundant to write <code>(pf--package-former-X p)</code> to project the constituents of a PackageFormer <code>p</code>. As such, let's introduce
a useful macro to “open p” locally.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">An anaphoric macro ^_^</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">pf--open-pf</span> <span style="color: #6c3163;">(</span>p <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Open a package-former P so no qualifiers are required in form BODY."</span>
  `<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span>
    <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>docstring             <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-docstring</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>kind                  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-kind</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>name                  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-name</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>level                 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>waist                 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-waist</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>indentation           <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-indentation</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>elements              <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>parameters            <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">-take</span> waist elements<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>fields                <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">-drop</span> waist elements<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    ,@body<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
( Lisp convention would advise this function to be named <code>with-pf</code>, but I'm using the prefix <code>open</code>,
as it is closer to the object language, Agda. )
</p>

<p>
It is crucial to realise that we have just established a convention
that partitions the elements of a PackageFormer:
</p>
<ul class="org-ul">
<li><a id="orged238e3">parameters</a> are the elements before the waist line.</li>
<li><a id="orgb32f32d">fields</a> are the elements after the waist line.</li>
</ul>
</div>
</div>

<div id="outline-container-orgbd15a12" class="outline-3">
<h3 id="Elements"><span class="section-number-3">5.2</span> Elements</h3>
<div class="outline-text-3" id="text-Elements">
<p>
A PackageFormer is a list of elements.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defstruct</span> element
  qualifier <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">E.g., &#8220;private, field&#8221;</span>
  name      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The lhs of an equation and a typed-name</span>
  type      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The type of a typed-name</span>
  equations <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">List of definitional clauses: &#8220;same-name-as-above args = term&#8221;</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's produce the associated useful map functions.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for place in '<span style="color: #6c3163;">(</span>qualifier name type equations<span style="color: #6c3163;">)</span>
      <span style="color: #6c3163; font-weight: bold;">do</span>
      <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>loc <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">intern</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"element-%s"</span> place<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
        <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> ,<span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">intern</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"map-%s"</span> place<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>f e<span style="color: #b1951d;">)</span>
           ,<span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Alter the &#8216;</span><span style="color: #4e3163;">%s</span><span style="color: #2d9574;">&#8217; field of an &#8216;</span><span style="color: #4e3163;">element</span><span style="color: #2d9574;">&#8217; value."</span> place<span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #3a81c3;">[</span>e&#8242; <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">copy-element</span> e<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">]</span>
             <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #6c3163;">(</span>,loc e&#8242;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> f <span style="color: #2d9574;">(</span>,loc e&#8242;<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
             e&#8242;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Now a method for replacing textual strings within an element structure.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">element-contains</span> <span style="color: #6c3163;">(</span>needle e<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Check whether string NEEDLE occurs anywhere in element E."</span>
    <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--any</span> it
           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for place in '<span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-qualifier</span> <span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #6c3163; font-weight: bold;">element-type</span><span style="color: #b1951d;">)</span>
                         collect <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #6c3163;">(</span>,place e<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">string-match-p</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\\b%s\\b"</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> needle<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>,place e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                   <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for <span style="color: #6c3163; font-weight: bold;">eq</span> in <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> e<span style="color: #b1951d;">)</span>
                         collect <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">string-match-p</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\\b%s\\b"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> needle<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                                 <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"="</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"="</span> <span style="color: #6c3163; font-weight: bold;">eq</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure we do not consider the LHS of an equation.</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">element-replace</span> <span style="color: #6c3163;">(</span>old new e <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>support-mixfix-names nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Replace every occurance of word OLD by string NEW in element E.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">We account for &#8220;OLD = [qualifier.]OLD&#8221; translations, as in function ELEMENT-RETRACT,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">by transforming them into &#8220;OLD = [qualifier.]NEW&#8221;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">When SUPPORT-MIXFIX-NAMES is true, we ignore underscores."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>e&#8242;    <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">copy-element</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>score <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> support-mixfix-names <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>old&#8242;  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> score old<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>temp  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s%s"</span> new <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">gensym</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>new&#8242;  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"_"</span> score new<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>offend  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = </span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">(</span><span style="color: #2d9574;">.+</span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">)</span><span style="color: #2d9574;">?%s"</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> temp<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> temp<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;l = [qualifier.]l&#8221;</span>
         <span style="color: #67b11d;">(</span>correct <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s = \\1%s"</span> old new<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;\\1&#8221; refers to the matched qualifier.</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Also account for &#8220;l = l&#8221; translations; c.f., element-retract.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">E.g., with &#8220;old, new &#8788; y, x&#8221; we have</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;let x = y in f x  &#10239;  let x = temp in f x  &#10239;  let x = x in f x&#8221;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Without the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">temp</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; switch, we would have had: &#8220;let x = y in f x  &#10239; let x = x in f x &#10239; let y = x in f x&#8221;,</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">which may be fine in a let-clause, but ruins a record having &#8220;x&#8221; as a field.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for <span style="color: #67b11d;">(</span>this . that<span style="color: #67b11d;">)</span> in `<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>,old&#8242; . ,temp<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>,offend . ,correct<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>,<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> temp<span style="color: #3a81c3;">)</span> . ,new&#8242;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #6c3163; font-weight: bold;">do</span>

          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for place in '<span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-qualifier</span> <span style="color: #6c3163; font-weight: bold;">element-name</span> <span style="color: #6c3163; font-weight: bold;">element-type</span><span style="color: #b1951d;">)</span>
                <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #6c3163;">(</span>,place e&#8242;<span style="color: #6c3163;">)</span>
                            <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #2d9574;">(</span>,place e&#8242;<span style="color: #2d9574;">)</span>
                                  <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">replace-regexp-in-string</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\\b%s\\b"</span> ,this<span style="color: #887070;">)</span>
                                                            that <span style="color: #887070;">(</span>,place e&#8242;<span style="color: #887070;">)</span> <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Replacements in the equations as well.</span>
          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> e&#8242; <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">map-equations</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> eqs &#8594; <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">replace-regexp-in-string</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\\b%s\\b"</span> this<span style="color: #887070;">)</span> that it <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span> eqs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> e&#8242;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
   <span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return value</span>
    e&#8242;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Above test: (element-replace "y" "x" (car (parse-elements '("here : let R = {x = y} in R.x f"))))</span>
</pre>
</div>

<p>
Given a typed name, return the name.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">parse-name</span> <span style="color: #6c3163;">(</span>element<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given an string representation of an ELEMENT, yield the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; component.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">The shape of the input may be &#8220;qualifier lhs ~ rhs&#8221; where &#8216;~&#8217; is either &#8216;:&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">or &#8216;=&#8217;.  The qualifier is a &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">special</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; word: field, private."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>lhs <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" "</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" = "</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" : "</span> element<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">&lt;</span> 1 <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> lhs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--special</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 0 lhs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> lhs<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lhs<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Parsing a list of interleaved elements in concrete syntax.
</p>

<ul class="org-ul">
<li>Given a list of PackageFormer ELEMENTS, as strings, parse them into the
‘element’ datatype.  Declarations and equations may be interspersed, as along
as equations of names follow their declarations.</li>

<li>The order is preserved in-case there are declarations that make use of
definitions.</li>

<li>Types must always be supplied &#x2014;in general, type inference is
undecidable in DTLs.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">parse-elements</span> <span style="color: #6c3163;">(</span>elements<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse string representation of elements into the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">element</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; record type.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('parse-elements)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>es <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">list</span> elements<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Maintain a list of related items.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for i from 0
          for e in es
          for name <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">parse-name</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for j from 0 to <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">1-</span> i<span style="color: #b1951d;">)</span>
                   <span style="color: #6c3163; font-weight: bold;">do</span>
                   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If the name of &#8216;e&#8217; occurs in the prefix,</span>
                   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then move &#8216;e&#8217; to the location in the prefix,</span>
                   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and zero-out the current location.</span>
                   <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> name <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">parse-name</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> j es<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> <span style="color: #2d9574;">""</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Use an empty string in-case the location is nil.</span>
                     <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> j es<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">append</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> j es<span style="color: #2d9574;">)</span> e<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                     <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> i es<span style="color: #6c3163;">)</span> nil<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Drop the nils.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> es <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">--reject</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> it<span style="color: #b1951d;">)</span> es<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We now have a list of related items,</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">with the car of each being a qualified typed-name</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and the cdr of each being a list of equational clauses</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">associated with that name.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for e in es
          for &#964;    <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" : "</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          for nom  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">parse-name</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> &#964;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">In case there is no qualifier; regexp-quote to avoid regexp ops in a name.</span>
          for qual <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #b1951d;">[</span>pts <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> nom<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> &#964;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">]</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">=</span> 2 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> pts<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> pts<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          for qual <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> nom <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> &#964;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          for _    <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> &#964;<span style="color: #b1951d;">)</span>
                                 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Type not supplied for %s!"</span> nom<span style="color: #b1951d;">)</span>
                                 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n\t\t"</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-take</span> 5 elements<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                                 <span style="color: #2d9574;">"&#8943; Add a type!"</span><span style="color: #67b11d;">)</span>
          for ty   <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" : "</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> &#964;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          collect
          <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">make-element</span> <span style="color: #3a81c3;">:qualifier</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> qual<span style="color: #3a81c3;">)</span> qual<span style="color: #b1951d;">)</span>
                        <span style="color: #3a81c3;">:name</span> nom
                        <span style="color: #3a81c3;">:type</span> ty
                        <span style="color: #3a81c3;">:equations</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Notice that the equations do not necessarily immediately follow their associated declarations.
</p>
</div>
</div>

<div id="outline-container-org81de7d1" class="outline-3">
<h3 id="Well-formed-checks----Error-reporting"><span class="section-number-3">5.3</span> Well-formed checks &#x2014;Error reporting</h3>
<div class="outline-text-3" id="text-Well-formed-checks----Error-reporting">
<p>
What is the above “fancy cons” we mentioned? Here it is.
</p>

<ul class="org-ul">
<li>Ensure CONDITION is true and defined, otherwise emit MESSAGE
and indicate the offending CONTEXT.
If there are any SUGGESTIONS to the user, then we show those too.</li>

<li>If CONDITION is defined and non-nil, whence true, we return it.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">eval-and-compile</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defmacro</span>  <span style="color: #6c3163; font-weight: bold;">-ensure</span> <span style="color: #6c3163;">(</span>condition <span style="color: #6c3163; font-weight: bold;">message</span> context <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> suggestions<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Ensure provided CONDITION is true, otherwise report an error.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('ensure)&gt;&gt;"</span>
  `<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>&#4314;\(&#3232;&#30410;&#3232;\)&#4314;
           <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"700: %s\n\n\t&#8680;\t%s%s%s"</span> ,<span style="color: #6c3163; font-weight: bold;">message</span> ,context
                   <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,suggestions<span style="color: #6c3163;">)</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #2d9574;">""</span><span style="color: #3a81c3;">)</span>
                   <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\t&#8680;\t%s"</span> it<span style="color: #2d9574;">)</span>
                                       <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,suggestions<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Try to evaluate the condition.</span>
          <span style="color: #67b11d;">(</span>res <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">condition-case</span> nil ,condition <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> &#4314;\(&#3232;&#30410;&#3232;\)&#4314;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If we've made it here, then the condition is defined.</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">It remains to check that it's true.</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> res <span style="color: #67b11d;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> &#4314;\(&#3232;&#30410;&#3232;\)&#4314;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>This operation checks that the VALUE of KEY
is well-formed according to 700-specifications &#x2014;which are stated
explicitly within this method&#x2014; and if it is well-formed we
return the VALUE <i>interpreted</i> along with the KEY.</li>

<li>When the value is not well-formed, we use the provided CONTEXT
in an error message.  No error is reported if VALUE is an ARGument, ARGS,
of a variational begin declared.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">eval-and-compile</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">-wf</span> <span style="color: #6c3163;">(</span>key value <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> context args<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Report an error unless provided key-value are well-formed.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('wf)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">case</span>
            <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> key
              <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:kind</span> `<span style="color: #6c3163;">(</span>,<span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">record</span> data module PackageFormer<span style="color: #887070;">)</span> value<span style="color: #2d9574;">)</span>
                       This kind &#8220; ,value &#8221; is <span style="color: #6c3163; font-weight: bold;">not</span> support by Agda!
                       Valid kinds: record&#10814; data&#10814; module&#10814; PackageFormer!<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
              <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:waist</span> `<span style="color: #6c3163;">(</span>,<span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">numberp</span> value<span style="color: #2d9574;">)</span>
                        The waist <span style="color: #6c3163; font-weight: bold;">should</span> be a number&#10814; which &#8220; ,value &#8221; is not!<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
              <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:level</span> `<span style="color: #6c3163;">(</span>,<span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #887070;">(</span>inc dec none<span style="color: #887070;">)</span> value<span style="color: #2d9574;">)</span>
                        The &#8220;level&#8221; must be &#8220;inc&#8221; <span style="color: #6c3163; font-weight: bold;">or</span> &#8220;dec&#8221; <span style="color: #6c3163; font-weight: bold;">or</span> &#8220;none&#8221;&#10814;
                        which &#8220; ,value &#8221; is not!<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>condition <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163; font-weight: bold;">case</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">message</span>   <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">mapconcat</span> #'<span style="color: #6c3163; font-weight: bold;">prin1-to-string</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #6c3163; font-weight: bold;">case</span><span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TODO: Acount for alter-elements well-formedness?</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(:alter-elements (functionp value)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(format "Componenet alter-elements should be a function;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">which &#8220;%s&#8221; is not." value))</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #6c3163; font-weight: bold;">case</span>
      <span style="color: #67b11d;">(</span> <span style="color: #6c3163; font-weight: bold;">-ensure</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> condition <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> args value<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #6c3163; font-weight: bold;">message</span> context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return the key-value as a pair for further processing.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:kind and :level values are symbols and so cannot be evaluated furthur.</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> key
          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> args value<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #6c3163;">(</span><span style="color: #3a81c3;">:kind</span> <span style="color: #3a81c3;">:level</span><span style="color: #6c3163;">)</span> key<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
              value
            <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> value<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfab3d2c" class="outline-3">
<h3 id="Package-Former-Parsing-and-Pretty-Printing"><span class="section-number-3">5.4</span> Package Former Parsing and Pretty Printing</h3>
<div class="outline-text-3" id="text-Package-Former-Parsing-and-Pretty-Printing">
<p>
With this in hand, let's produce a robust parser.
</p>

<ul class="org-ul">
<li>The input LINES must be a list of lines forming a full
PackageFormer declaration; e.g., obtained by calling ‘pf&#x2013;get-children’.</li>

<li>It is parsed and a ‘package-former’ value is returned.</li>

<li>Whitespace is stripped off of items.</li>

<li>Docstrings are ignored.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #6c3163;">(</span>lines<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Load a string representation of a &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">package-former</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; into our global list.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('load-package-former)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> lines<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"PF--LOAD-PACKAGE-FORMER: Error: Input must be non-empty list"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span>pf
         <span style="color: #67b11d;">(</span>header <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">""</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>name <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"PackageFormer $here :"</span> header<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>level <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--substring-delimited-here</span> <span style="color: #2d9574;">"Set $here where"</span> header<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #715ab1;">pf-highlighting</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">mapc</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> it &#8594; <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">highlight-phrase</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> it<span style="color: #6c3163;">)</span> '<span style="color: #655370; background-color: #fbf8ef;">hi-yellow</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> pf
          <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">make-pf--package-former</span>
           <span style="color: #3a81c3;">:kind</span>                     <span style="color: #2d9574;">"PackageFormer"</span>
           <span style="color: #3a81c3;">:name</span>                     name
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">level</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; may be &#8220;&#8221;, that's okay.</span>
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">It may be a subscript or implicitly zero, so no space after &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">Set</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
           <span style="color: #3a81c3;">:level</span>                    level
           <span style="color: #3a81c3;">:waist</span>                    0
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TODO: Currently no parameter support for arbitrary PackageFormers.</span>
           <span style="color: #3a81c3;">:indentation</span>              <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">max</span> 4 <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-indentation</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">4 spaces is the minimum</span>
           <span style="color: #3a81c3;">:elements</span>  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--remove</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-starts-with?</span> <span style="color: #2d9574;">"-- "</span> it<span style="color: #6c3163;">)</span>
                                                <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> it<span style="color: #2d9574;">)</span>
                                                       <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> name pf<span style="color: #67b11d;">)</span> <span style="color: #715ab1;">pf--package-formers</span><span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return value</span>
      pf<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's try this out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">#s(package-former nil PackageFormer M-Set ₁ 0 nil 3 (#s(element nil Scalar Set nil) #s(element nil Vector Set nil) #s(element nil <span class="underline">·</span> Scalar → Vector → Vector nil) #s(element nil 𝟙 Scalar nil) #s(element nil <span class="underline">×</span> Scalar → Scalar → Scalar nil) #s(element nil leftId {𝓋 : Vector}  →  𝟙 · 𝓋  ≡  𝓋 nil) #s(element nil assoc {a b : Scalar} {𝓋 : Vector} → (a × b) · 𝓋  ≡  a · (b · 𝓋) nil)))</td>
</tr>
</tbody>
</table>

<p>
Conversely, let's have a pretty printer.
</p>

<ul class="org-ul">
<li>Special elements F, for whatever reason are exceptional, and so
are maked as singleton lists and their indentation is lessened.
That is, these denote sibling <a href="#orgb32f32d">fields</a> rather than more children.</li>

<li>Special elements include: field, private.</li>

<li>See ‘show-package-former’ for their use and how their printed.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--special</span> <span style="color: #6c3163;">(</span>f<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Test whether an element F is special or not.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('special)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--any?</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> it f<span style="color: #2d9574;">)</span> '<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"field"</span> <span style="color: #2d9574;">"private"</span> <span style="color: #2d9574;">"open"</span> <span style="color: #2d9574;">"top-level"</span> <span style="color: #2d9574;">"sibling"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
A “sibling” item has no indentation.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">show-element</span> <span style="color: #6c3163;">(</span>e <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> omit-qualifier<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Render an &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">element</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; value E in the form:</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   qualifier name : type ; equational-clause&#8320; ; &#8943; ; equational-clause&#8345;</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Optional OMIT-QUALIFIER is useful for when</span>
<span style="color: #da8b55; background-color: #ecf3ec;">elements are in a parameter position."</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" ;\t"</span>
          <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span>
           <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s%s\t\t: %s"</span>
                   <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #3a81c3;">[</span>it <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">element-qualifier</span> e<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">]</span>
                     <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> it<span style="color: #2d9574;">)</span> omit-qualifier<span style="color: #6c3163;">)</span> <span style="color: #2d9574;">""</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s "</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                   <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-name</span> e<span style="color: #b1951d;">)</span>
                   <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">element-type</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
           <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">element-equations</span> e<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> <span style="color: #6c3163;">(</span>pf<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Pretty print a package-former PF record value."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--open-pf</span> pf
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-cons*</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The documentation string</span>
       <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> docstring <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"{- %s -}"</span> docstring<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The schema declaration</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span>
        <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span>
                <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> kind
                      name
                      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span>
                              <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"("</span>
                                             <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">show-element</span> it <span style="color: #3a81c3;">:omit-qualifier</span><span style="color: #6c3163;">)</span>
                                             <span style="color: #2d9574;">")"</span><span style="color: #3a81c3;">)</span>
                                     parameters<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> level 'none<span style="color: #887070;">)</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">": Set"</span> level<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                      <span style="color: #2d9574;">"where"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The elements of a PackageFormer</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">align-regexp</span>
       <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> fields
         <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s%s"</span>
                        <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-repeat</span> indentation <span style="color: #2d9574;">" "</span><span style="color: #887070;">)</span>
                        <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">show-element</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
</pre>
</div>

<p>
Let's test it out by <i>introducing</i> a whole new local variable and trying
to include the <code>field</code> Agda keyword.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>raw <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span>pf <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> raw<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span>waist 2<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-waist</span> pf<span style="color: #2d9574;">)</span> waist<span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">mark all items as "fields"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">element-qualifier</span> it<span style="color: #67b11d;">)</span> <span style="color: #2d9574;">"field"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> pf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inject new items at the waist line</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for new in <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">parse-elements</span> '<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"private n : &#8469;"</span> <span style="color: #2d9574;">"n = 3"</span> <span style="color: #2d9574;">"&#119982;&#8495;&#120009; : Set&#8321;"</span> <span style="color: #2d9574;">"&#119982;&#8495;&#120009; = Set"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
        <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> new
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nthcdr</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">1-</span> waist<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> pf<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set (Scalar</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #3a81c3; font-weight: bold;">where</span>
   &#119982;&#8495;&#120009;      :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; ;    &#119982;&#8495;&#120009; <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #3a81c3; font-weight: bold;">Set</span>
   <span style="color: #3a81c3; font-weight: bold;">private</span>  <span style="color: #0000cd;">n</span>       : <span style="color: #ba2f59; font-weight: bold;">&#8469;</span> ;   <span style="color: #0000cd;">n</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #a020f0;">3</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#183;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> &#120793;      :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> _&#215;_        :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>     : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #3a81c3; font-weight: bold;">field</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>      : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
Notice that the \(𝒮ℯ𝓉 = Set\) alias is a top-level item, with respect to the current PackageFormer.
</p>

<p>
We can phrase an approximation of the opinion that parsing and showing
should be inverses.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #6c3163;">[</span>pf <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<div class="org-center">
<p>
( <i>In Lisp, <code>t</code> denotes “true”!</i> )
</p>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">pf-parse</span> <span style="color: #6c3163;">()</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Error on empty list of lines.</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should-error</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">No crash on empty line.</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">""</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">No crash on PackageFormer with no elements.</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"PackageFormer PF : Set &#8467; where"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Levels</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#8467;"</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"PackageFormer PF : Set &#8467; where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">""</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"PackageFormer PF : Set  where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"PackageFormer PF : Set&#8323; where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"(Level.suc &#8467;)"</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"PackageFormer PF : Set (Level.suc &#8467;) where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Full parsing.</span>
   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>pf <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
     <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s"</span> pf<span style="color: #67b11d;">)</span>
            <span style="color: #2d9574;">"#s(pf--package-former nil PackageFormer M-Set &#8321; 0 nil 3 (Scalar  : Set Vector  : Set _&#183;_     : Scalar &#8594; Vector &#8594; Vector &#120793;       : Scalar _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)))"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #2d9574;">[</span>pf <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-concat</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                   <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org708989b" class="outline-2">
<h2 id="Variational-Language"><span class="section-number-2">6</span> Variational Language</h2>
<div class="outline-text-2" id="text-Variational-Language">
<p>
A variational has the syntactic form specfied by
</p>
<div class="org-src-container">
<pre class="src src-text">        &#120011;   ::=  identifier (identifier)* = &#120011;&#119992;
        &#120011;&#119992;  ::= [identifier] (:key value)* (&#10228; &#120011;&#119992;)*

        identifier &#8776; key &#8776; value &#8776; string of text
</pre>
</div>

<p>
With the intention that <code>l a = r</code> is a list of key-value pairs
determined from the right-hand side where the arguments <code>a</code>
are to be considered place-holders. Whenever one mentions free variables,
or terms, one actually speaks of functions. Hence, let's reify these as functions.
</p>

<p>
Let's keep track of the user defined variationals, so that we can display them to the
user via menus, as well as highlight them, and attach tooltips to them.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf--variationals</span> nil
    <span style="color: #da8b55; background-color: #ecf3ec;">"Association list of Agda-user defined variational operators."</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's be somewhat agonstic regardiing the variational composition operator;
users are welcome to use any other symbol.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf-variational-composition-operator</span> <span style="color: #2d9574;">"&#10228;"</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"The operator that composes varitionals."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org1dcf5fb" class="outline-3">
<h3 id="Well-formed-checks----Error-reporting"><span class="section-number-3">6.1</span> Well-formed checks &#x2014;Error reporting</h3>
<div class="outline-text-3" id="text-Well-formed-checks----Error-reporting">
<p>
What is the above “fancy cons” we mentioned? Here it is.
</p>

<ul class="org-ul">
<li>Ensure CONDITION is true and defined, otherwise emit MESSAGE
and indicate the offending CONTEXT.
If there are any SUGGESTIONS to the user, then we show those too.</li>

<li>If CONDITION is defined and non-nil, whence true, we return it.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">pf--ensure</span> <span style="color: #2d9574;">(</span>condition <span style="color: #6c3163; font-weight: bold;">message</span> context <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> suggestions<span style="color: #2d9574;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Ensure provided CONDITION is true, otherwise report an error.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('ensure)&gt;&gt;"</span>
  `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>&#4314;\(&#3232;&#30410;&#3232;\)&#4314;
           <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"700: %s\n\n\t&#8680;\t%s%s%s"</span> ,<span style="color: #6c3163; font-weight: bold;">message</span> ,context
                   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,suggestions<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>
                   <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\t&#8680;\t%s"</span> it<span style="color: #887070;">)</span>
                                       <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,suggestions<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Try to evaluate the condition.</span>
          <span style="color: #b1951d;">(</span>res <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">condition-case</span> nil ,condition <span style="color: #6c3163;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> &#4314;\(&#3232;&#30410;&#3232;\)&#4314;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If we've made it here, then the condition is defined.</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">It remains to check that it's true.</span>
     <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> res <span style="color: #b1951d;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> &#4314;\(&#3232;&#30410;&#3232;\)&#4314;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>This operation checks that the VALUE of KEY
is well-formed according to 700-specifications &#x2014;which are stated
explicitly within this method&#x2014; and if it is well-formed we
return the VALUE <i>interpreted</i> along with the KEY.</li>

<li>When the value is not well-formed, we use the provided CONTEXT
in an error message.  No error is reported if VALUE is an ARGument, ARGS,
of a variational begin declared.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--wf</span> <span style="color: #2d9574;">(</span>key value <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> context args<span style="color: #2d9574;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Report an error unless provided key-value are well-formed.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('wf)&gt;&gt;"</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">case</span>
            <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> key
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3;">:kind</span> `<span style="color: #2d9574;">(</span>,<span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">record</span> data module PackageFormer<span style="color: #3a81c3;">)</span> value<span style="color: #887070;">)</span>
                       This kind &#8220; ,value &#8221; is <span style="color: #6c3163; font-weight: bold;">not</span> support by Agda!
                       Valid kinds: record&#10814; data&#10814; module&#10814; PackageFormer!<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3;">:waist</span> `<span style="color: #2d9574;">(</span>,<span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">numberp</span> value<span style="color: #887070;">)</span>
                        The waist <span style="color: #6c3163; font-weight: bold;">should</span> be a number&#10814; which &#8220; ,value &#8221; is not!<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3;">:level</span> `<span style="color: #2d9574;">(</span>,<span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #3a81c3;">(</span>inc dec none<span style="color: #3a81c3;">)</span> value<span style="color: #887070;">)</span>
                        The &#8220;level&#8221; must be &#8220;inc&#8221; <span style="color: #6c3163; font-weight: bold;">or</span> &#8220;dec&#8221; <span style="color: #6c3163; font-weight: bold;">or</span> &#8220;none&#8221;&#10814;
                        which &#8220; ,value &#8221; is not!<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span>condition <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163; font-weight: bold;">case</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">message</span>   <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapconcat</span> #'<span style="color: #6c3163; font-weight: bold;">prin1-to-string</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #6c3163; font-weight: bold;">case</span><span style="color: #6c3163;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TODO: Acount for alter-elements well-formedness?</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(:alter-elements (functionp value)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(format "Componenet alter-elements should be a function;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">which &#8220;%s&#8221; is not." value))</span>

    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #6c3163; font-weight: bold;">case</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> condition <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> args value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #6c3163; font-weight: bold;">message</span> context<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return the key-value as a pair for further processing.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:kind and :level values are symbols and so cannot be evaluated furthur.</span>
    <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> key
          <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> args value<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-contains?</span> '<span style="color: #2d9574;">(</span><span style="color: #3a81c3;">:kind</span> <span style="color: #3a81c3;">:level</span><span style="color: #2d9574;">)</span> key<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
              value
            <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> value<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org19285c4" class="outline-3">
<h3 id="𝒱𝒸---𝒱---and-𝒱"><span class="section-number-3">6.2</span> 𝒱𝒸,  𝒱-, and 𝒱</h3>
<div class="outline-text-3" id="text-𝒱𝒸---𝒱---and-𝒱">
<p>
Variationals are refieid as functions with the prefix 𝒱-;
doing otherwise may override existing utilities in Emacs
&#x2014;for example, ‘record’ is a useful name for a variational
but is a super important utility function in Emacs.
The apporach we take is to allow users to write ‘record’
but the implementation will refer to it with a prefix.
</p>

<p>
Parsing variational clauses is then straightforward:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> nil *parent-context* nil
  <span style="color: #2d9574;">"For error report; what is the current parent context of a child item.</span>

<span style="color: #2d9574;">   Should be set whenver a parent invokes a child.</span>
<span style="color: #2d9574;">   Since we have no grandchildren, we only need one level.</span>
<span style="color: #2d9574;">"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
If there is a ‘label’, then yield ‘(label :key value ⋯)’
since ‘label’ is assumed to exist as a variational having the given
keys as arguments.  The result should be a list of pairs.
</p>

<p>
BODY-LIST consists of elements of this shape.
</p></li>

<li>If there is no label, the parse the list of pairs.</li>

<li><p>
For example,
</p>

<p>
(cl-defun 𝒱-test (&amp;key height kind) (list (format "%s &amp; %s" height kind)))
</p>

<p>
(𝒱𝒸 '(test :height 3 :kind 'data)) ≈ (test :height 3 :kind data) ≈ (“3 &amp; data”)
</p>

<p>
(𝒱𝒸 '(     :height 3 :kind data))  ≈ ((:height . 3) (:kind . data))
</p></li>

<li>Newer items c₀ ⟴ ⋯ ⟴ cₙ should be at the front of the list;
access should then be using ‘assoc’.</li>

<li>CONTEXT is the parent context that contains an invocation of this method.</li>

<li>ARGS is the list of names that are bound, and so are variational args.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> <span style="color: #2d9574;">(</span>body-list <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> context args<span style="color: #2d9574;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse a single &#119985;ariational &#119992;lause, &#8220;[label] (:key :value)*&#8221;, as a list.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('&#119985;&#119992;)&gt;&gt;"</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #67b11d;">(</span>res<span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for clause in <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">-split-on</span> '&#10228; body-list<span style="color: #b1951d;">)</span>
          <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> res <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span>
                        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Symbols starting with &#8220;:&#8221; are keywords.</span>
                        <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">keywordp</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> clause<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Function invocation case</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We turn everything into a string so that we may</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">prepend the function name with a &#119985;-</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then turn that into Lisp with the first eval</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then invoke the resulting function call</span>
                            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">with the second eval.</span>
                            <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span>
                              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The variational being called is defined.</span>
                              <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">fboundp</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> clause<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                                          <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s %s &#8220;%s&#8221; %s"</span>
                                                  <span style="color: #2d9574;">"Did you mistype a"</span>
                                                  <span style="color: #2d9574;">"variational's name:"</span>
                                                  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> clause<span style="color: #6c3163;">)</span>
                                                  <span style="color: #2d9574;">"is not defined."</span><span style="color: #3a81c3;">)</span>
                                          context
                                          <span style="color: #2d9574;">"Use the PackageFormer menu</span>
<span style="color: #2d9574;">                                                 to see which variationals</span>
<span style="color: #2d9574;">                                                 are defined."</span><span style="color: #887070;">)</span>
                              <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #3a81c3;">(</span> ,<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> clause<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> ,@<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> clause<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">List of key-value pairs</span>
                          `,<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for key   in clause by #'<span style="color: #6c3163; font-weight: bold;">cddr</span>
                                  for value in <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> clause<span style="color: #887070;">)</span> by #'<span style="color: #6c3163; font-weight: bold;">cddr</span>
                                  collect <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">pf--wf</span> key value context args<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;pf--wf&#8221; is just a fancy &#8220;cons&#8221;.</span>
                        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Newer items c&#8320; &#10228; &#8943; &#10228; c&#8345; should be at the</span>
                        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">front of the list;</span>
                        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">access should then be using assoc.</span>
                        res<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    res<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
Where we have used the following helper to prefix Lisp code with “𝒱-”.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;-</span> <span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Prefix the Lisp data NAME with a &#8220;&#119985;-&#8221; then yield that as a Lisp datum."</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">symbolp</span> name<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> name
    <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"&#119985;-%s"</span><span style="color: #67b11d;">)</span>
    <span style="color: #6c3163; font-weight: bold;">read-from-string</span>
    <span style="color: #6c3163; font-weight: bold;">car</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We now handle variational declarations by introducing a DSL; i.e., a macro that
expects the syntax outlined earlier.
</p>

<ul class="org-ul">
<li><p>
The grammar:
</p>

<p>
𝓋   ::= [docstring] identifier ([“(”]identifier[“)”])* = 𝓋𝒸
</p>

<p>
𝓋𝒸  ::= [identifier] (:key value)* (⟴ 𝓋𝒸)*
</p></li>

<li>The result is a function NAME prefixed by 𝒱- whose BODY is an alist
obtained from the aforementioned key-value pairs.</li>

<li>E.g., (𝒱 tes positional (keyword 3) = :kind data)
This defines a variational with one positional and one keyword argument having
3 as default.</li>

<li>The resulting generated function has its code embeded as a docstring viewable
with “𝑪-𝒉 𝒐” &#x2014;catented after any provided user documentation.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">eval-and-compile</span>
<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">&#119985;</span> <span style="color: #2d9574;">(</span>name <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #2d9574;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Reify as Lisp a variational declaration using the variational grammar.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('&#119985;)&gt;&gt;"</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Main code follows.</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>context <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapconcat</span> <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">&#955;</span> x &#8594; <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">prin1-to-string</span> x <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> name body<span style="color: #6c3163;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
         <span style="color: #b1951d;">(</span>args-body <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">-split-on</span> '<span style="color: #6c3163; font-weight: bold;">=</span> body<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
         args pargs kargs argnames docs body res actual-code<span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">length</span> args-body<span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span>2 <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> args <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> args-body<span style="color: #6c3163;">)</span>
               body <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> args-body<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span>_ <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> body <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> args-body<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Realise the arguments as either &#119979;ositinal or &#119974;ey arguments.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for a in args
          <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">consp</span> a<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> a kargs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> a pargs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The arguments are in reverse now, which doesn't matter for keywords</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">yet is crucial for positional arguments. So let's fix that.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> pargs <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> pargs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keep track of only the argument names, omitting any default values.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> argnames <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">append</span> pargs <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">car</span> kargs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Set any documentation string and reify the body's variational clauses.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">stringp</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> body<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> docs <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> body<span style="color: #3a81c3;">)</span> body <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> body<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> res <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> body context argnames<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">I want to be able to actually, visually, see the resulting</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">generated definition of a function.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Hence, I embed its source code as a string in the code.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">I'm using strings so that they appear in the docstring via C-h o.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> actual-code
    `<span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> ,<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> name<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>,@pargs <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> ,@kargs<span style="color: #3a81c3;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stage the formal names *now*, then evaluate their values at run time.</span>
       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Traverse the list of pairs and change the nested formal names with the</span>
       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">given values. Praise the Lord!</span>
      <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>give-goal <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,res<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>give-goal&#8320; give-goal<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
        <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,argnames<span style="color: #2d9574;">)</span>

          <span style="color: #2d9574;">"Stage the formal names *now*, then evaluate their values at run time."</span>
          <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for arg in <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">quote</span> ,argnames<span style="color: #887070;">)</span>
                <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> give-goal <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cl-subst</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> arg<span style="color: #6c3163;">)</span> arg give-goal<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TODO, maybe.</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Check that substituted values are well-typed"</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(--map (pf--wf (car it) (or (cdr it)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                        </span><span style="color: #2aa1ae; background-color: #ecf3ec;">;; Mention which argument is not supplied.</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                         </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(format "No Value for :%s Provided!"</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                       </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(cdr (assoc (car it) (reverse give-goal&#8320;))))</span>
          <span style="color: #6c3163;">)</span>

         give-goal<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Now set the code as a documentation string in it, after the fact.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> docs <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Arguments:\t%s %s\n%s"</span> pargs <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> kargs<span style="color: #3a81c3;">)</span>
                       <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> docs<span style="color: #6c3163;">)</span> <span style="color: #2d9574;">"Undocumented user-defined variational."</span>
                         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keep paragraph structure, but ignore whitespace.</span>
                         <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> docs
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"\n\n"</span><span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span><span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">s-trim</span><span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n\n"</span><span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-word-wrap</span> 70<span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\n%s\n\n\n"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">When the user provides documentation, they may not want to see</span>
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the raw and expansions, so we pad extra whitespace before them.</span>

    <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">put</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> name<span style="color: #b1951d;">)</span> 'function-documentation
         <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s\n&#10218;User Definition&#10219;\n\n%s\n\n&#10218;Lisp Elaboration&#10219;\n\n%s"</span>
                 docs context <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pp-to-string</span> actual-code<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Register this new item in our list of variationals.</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> name docs<span style="color: #b1951d;">)</span> <span style="color: #715ab1;">pf--variationals</span><span style="color: #67b11d;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return value:</span>
    actual-code<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Consequently, any item declared with 𝒱 now has a docstring containing its user-facing
definition as well as its Lisp realisation ^_^ &#x2014;simply press “C-h o ENTER” on its name.
</p>

<p>
Here's an example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> test positional <span style="color: #6c3163;">(</span>keyword 3<span style="color: #6c3163;">)</span> another <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #2d9574;">"I have two mandatory arguments and one keyword argument"</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-test</span> <span style="color: #2d9574;">"positional arg&#8321;"</span> <span style="color: #2d9574;">"positional arg&#8322;"</span> <span style="color: #3a81c3;">:keyword</span> 25<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8658; nil ^_^</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a3fec6" class="outline-3">
<h3 id="Loading-Variationals--Super-Simple-Conversion-From-String-to-Lisp"><span class="section-number-3">6.3</span> Loading Variationals: Super Simple Conversion From String to Lisp</h3>
<div class="outline-text-3" id="text-Loading-Variationals--Super-Simple-Conversion-From-String-to-Lisp">
<ul class="org-ul">
<li><p>
A VARIATION-STRING line is something like:
</p>

<p>
𝒱-name x₀ … xₙ  =  ([label₀] :key₀ val₁ ⋯ :keyₘ valₘ ⟴)*
</p></li>

<li>The result is a list of 3-tuples (name (x₀ ⋯ xₙ) ((key₀ val₀) ⋯ (keyₘ valₘ))),
containing the clause's name, argument list, and key-value pairs.</li>

<li>For now, the RHS must be an expression of the form
“:key₀ value₀ ⋯ :keyₙ valueₙ”
<ul class="org-ul">
<li>where the valueᵢ are legitmate Lisp expressions</li>
<li>and the LHS is an atomic name, possibly with argument names.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--load-variational</span> <span style="color: #6c3163;">(</span>variation-string<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Obtain lines of the buffer that start with &#8220;&#119985;-&#8221; as a Lisp alist.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('load-variational)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span> variation-string
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-replace</span> <span style="color: #2d9574;">"&#119985;-"</span> <span style="color: #2d9574;">"&#119985; "</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"(%s)"</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163; font-weight: bold;">read-from-string</span>
    <span style="color: #6c3163; font-weight: bold;">car</span>
    <span style="color: #6c3163; font-weight: bold;">eval</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-&#119985;&#119992;</span> <span style="color: #6c3163;">()</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;-</span> 'nice<span style="color: #67b11d;">)</span>
                 '&#119985;-nice<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> 'data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>


  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Error along with &#8220;noice&#8221;.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should-error</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #67b11d;">(</span><span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> datda<span style="color: #67b11d;">)</span> 'noice nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nice error.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should-error</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #67b11d;">(</span><span style="color: #3a81c3;">:level</span> 3<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;-test</span> <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">&amp;key</span> height kind<span style="color: #2d9574;">)</span> `<span style="color: #2d9574;">(</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> . ,height<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">second</span> . ,kind<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #b1951d;">(</span>test <span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> 'three &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">second</span> . three<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NOTE: &#119985;-tests&#8242; :kind is optional</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #b1951d;">(</span>test <span style="color: #3a81c3;">:height</span> 3 &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">first</span> . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">second</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> 3 &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> . 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Recursively place 3 (new) wherever 'it (old) occurs.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This' a standard Lisp utility.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span>
           <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">subst</span> 3 'it '<span style="color: #b1951d;">(</span>1 2 it 4 <span style="color: #3a81c3;">(</span>5 it<span style="color: #3a81c3;">)</span> 7 <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">+</span> 8 it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
           '<span style="color: #67b11d;">(</span>1 2 3 4 <span style="color: #b1951d;">(</span>5 3<span style="color: #b1951d;">)</span> 7 <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">+</span> 8 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-&#119985;</span> <span style="color: #6c3163;">()</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Nullary</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> test&#8320;  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #3a81c3;">:kind</span> '<span style="color: #6c3163; font-weight: bold;">record</span> <span style="color: #3a81c3;">:waist</span> 3<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span>&#119985;-test&#8320;<span style="color: #67b11d;">)</span>
               '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . <span style="color: #6c3163; font-weight: bold;">record</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Unary</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> test&#8321; heightish <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #3a81c3;">:kind</span> '<span style="color: #6c3163; font-weight: bold;">record</span> <span style="color: #3a81c3;">:waist</span> heightish<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span>&#119985;-test&#8321; <span style="color: #3a81c3;">:heightish</span> 6<span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . <span style="color: #6c3163; font-weight: bold;">record</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 6<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invoking the previously defined variational</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> test&#8322;  <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #3a81c3;">:kind</span> 'data &#10228; test&#8321; <span style="color: #3a81c3;">:heightish</span> 2<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span>&#119985;-test&#8322;<span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . <span style="color: #6c3163; font-weight: bold;">record</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 2<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">See a nice error message ^_^</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should-error</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">&#119985;</span> test&#8323; <span style="color: #6c3163; font-weight: bold;">=</span> <span style="color: #3a81c3;">:kind</span> recordd<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-loading</span> <span style="color: #6c3163;">()</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-variational</span> <span style="color: #2d9574;">"&#119985;-tc this height = :level this :waist height"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NEATO! (Has desired error)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(-let [*parent-context* "woadh"]</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985;-tc :height 'no :this 'inc))</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Does not pass: I've commented out the type checking in &#119985; above, for now.</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span>&#119985;-tc <span style="color: #3a81c3;">:height</span> 9 <span style="color: #3a81c3;">:this</span> 'inc<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:a</span> 'b &#10228; tc <span style="color: #3a81c3;">:height</span> 1<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:level</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 1<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:a</span> . b<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-orge3e791c" class="outline-2">
<h2 id="Loading-an-Agda-Buffer"><span class="section-number-2">7</span> Loading an Agda Buffer</h2>
<div class="outline-text-2" id="text-Loading-an-Agda-Buffer">
<p>
Before we can parse an Agda buffer, we need to be able to parse an instantiation declaration;
for which we would later generate code.
</p>
</div>

<div id="outline-container-org01ac33d" class="outline-3">
<h3 id="Loading-an-Instance----The-Core-Utility"><span class="section-number-3">7.1</span> Loading an Instance &#x2014;The Core Utility</h3>
<div class="outline-text-3" id="text-Loading-an-Instance----The-Core-Utility">
<p>
An instance declaration is of the form:
</p>
<div class="org-src-container">
<pre class="src src-results-agda">PF&#8242; <span style="color: #3a81c3; font-weight: bold;">=</span><span style="color: #ba2f59; font-weight: bold;"> PF</span> <span style="color: #0000cd;">variational</span>&#8321; <span style="color: #0000cd;">args</span>&#8321; &#10228;  &#8943; &#10228; <span style="color: #0000cd;">variational</span>&#8345; (<span style="color: #0000cd;">args</span>&#8345;)
</pre>
</div>

<p>
This gives rise to a simple nice structure:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defstruct</span> pf-instance-declaration
  <span style="color: #da8b55; background-color: #ecf3ec;">"Record of components for an PackageFormer instance declaration:</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#10218;name&#10219; = &#10218;package-former&#10219; (&#10228; &#10218;variation&#10219; [&#10218;args&#10219;])*</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  docstring      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">What the declaration looks like, useful for reference.</span>
  name           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Left-hand side</span>
  package-former <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Parent grouping mechanism</span>
  alterations    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">List of variationals along with their arguments.</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Loading an instantiation into our list is now trivial.
</p>

<ul class="org-ul">
<li>If the current LINE string is an instance declaration,
then produce a new PackageFormer from it.  Else, do nothing.</li>

<li>Whitespace is automatically collopased from LINE.</li>

<li>Nil elements are discarded; e.g., due to a filter.</li>

<li>Duplicates are discarded; e.g., due to a rename.</li>

<li>Variational clauses may mention
<ul class="org-ul">
<li>$𝑛𝑎𝑚𝑒: The name of the PackageFormer currently being declared;
i.e., the LHS name.</li>
<li>$𝑒𝑙𝑒𝑚𝑒𝑛𝑡𝑠: Many variationals will act on individal elements, but may check a
property relative to all elements and this name allows us to avoid
having variationals that simply accomodate for binary functions
that operate on an individual element while also needing to refer to
all elements.  For example, a variational that keeps an element if
it's related to another element somehow.</li>
</ul></li>

<li>SHOW-IT: For testing, and presentation, this optional value indicates whether
the resulting PackageFormer should be pretty-printed or not.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--load-instance-declaration</span> <span style="color: #6c3163;">(</span>line <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> show-it<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Reify concrete instance declarations as &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">package-former</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; values.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('load-instance-declaration)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">letf*</span> <span style="color: #2d9574;">(</span>
     <span style="color: #67b11d;">(</span>pieces <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">" "</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span> line<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119899;&#119886;&#119898;&#119890;      <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 0 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;    nil<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>eqSymb     <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 1 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;     <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> 2 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>variations <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">nthcdr</span> 3 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>alterations nil<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>self <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">copy-pf--package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; <span style="color: #715ab1;">pf--package-formers</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>&#8265;
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If componenet &#8216;c&#8217; is in the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">alterations</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; list of the</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">instance declaration, then evalaute any given &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">more</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; code,</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">get the value for &#8216;c&#8217; and turn it</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">into a string, if &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">str</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is true, then set the new PackageFormer's &#8216;c&#8217;</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">componenet to be this value.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Well-formedness checks happen at the &#119985; and &#119985;&#119992; stages, see below.</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #3a81c3;">(</span>c <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> str more<span style="color: #3a81c3;">)</span>
        <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">when-let</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>it <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">intern</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">":%s"</span> c<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> alterations<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
          <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> ,@more<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
          <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> str <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> it <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s"</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
          <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> `<span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #887070;">(</span>,<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">read-from-string</span>
                               <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"pf--package-former-%s"</span> c<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #dc752f; background-color: #fbf8ef;">self</span><span style="color: #887070; background-color: #fbf8ef;">)</span>
                       it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure instance declaration is well-formed.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> $&#119899;&#119886;&#119898;&#119890;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"="</span> eqSymb<span style="color: #b1951d;">)</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #67b11d;">)</span>
                <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"An instance declaration is of the form "</span>
                        <span style="color: #2d9574;">"&#8220;new-name = parent-package-former "</span>
                        <span style="color: #2d9574;">"variational-clauses&#8221;."</span><span style="color: #67b11d;">)</span>
                line<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's not overwrite existing PackageFormers.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">or</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">assoc</span> $&#119899;&#119886;&#119898;&#119890; <span style="color: #715ab1;">pf--package-formers</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> $&#119899;&#119886;&#119898;&#119890; <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"PackageFormer &#8220;%s&#8221; is already defined; use a new name."</span>
                        $&#119899;&#119886;&#119898;&#119890;<span style="color: #67b11d;">)</span>
                line<span style="color: #2d9574;">)</span>
                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Also, &#8220;_&#8221; is the name of anonymous PackageFormers."</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure the PackageFormer to be instantiated is defined.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">pf--ensure</span> self
                <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Parent &#8220;%s&#8221; not defined."</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #67b11d;">)</span>
                line
                <span style="color: #2d9574;">"Use the PackageFormer Emacs menu to see which PackageFormers are defined."</span>
                <span style="color: #2d9574;">"Perhaps you did not enclose the parent in 700-comments?"</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update the new PackageFormer with a docstring of its instantiation</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">as well as its name.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-docstring</span> self<span style="color: #67b11d;">)</span> line<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-name</span> self<span style="color: #67b11d;">)</span> $&#119899;&#119886;&#119898;&#119890;<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904; <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Copy so that user does not inadvertently</span>
                  <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">alter shared memory locations!</span>
          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for e in <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> self<span style="color: #b1951d;">)</span>
                collect <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">copy-element</span> e<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Parse the &#8220;&#120011;&#8320; &#10228; &#8943; &#10228; &#120011;&#8345;&#8221; portion of an instance declaration.</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">thread-last</span>  variations
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">" "</span><span style="color: #67b11d;">)</span>     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick the rest back together.</span>
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"'(%s)"</span><span style="color: #67b11d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Construe as a lisp list</span>
       <span style="color: #6c3163; font-weight: bold;">read-from-string</span>
       <span style="color: #6c3163; font-weight: bold;">cadar</span>
       <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> variations<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> alterations <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> variations line<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">c.f. &#8265; above</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Now that the aterations have been parsed, let's attach</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the new components of the PackageFormer being made.</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:kind &#8776; The vocabulary that replaces &#8220;PackageFormer&#8221;.</span>
      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> &#8265; 'kind 'string-please<span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:waist &#8776; The division between parameters and remaining elements.</span>
      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> &#8265; 'waist<span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:level &#8776; Either 'inc or 'dec, for increment or decrementing the level.</span>
      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> &#8265; 'level nil <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">'string-please</span>
         '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>lvl <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-level</span> self<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                  <span style="color: #6c3163;">(</span>toLevel <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #887070;">(</span>n<span style="color: #887070;">)</span>
                             <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">""</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-concat</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-repeat</span> n <span style="color: #2d9574;">"Level.suc ("</span><span style="color: #6c3163;">)</span>
                                                 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">list</span> <span style="color: #2d9574;">"Level.zero"</span><span style="color: #6c3163;">)</span>
                                                 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">-repeat</span> n <span style="color: #2d9574;">")"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                 <span style="color: #6c3163;">(</span>subs `<span style="color: #2d9574;">(</span><span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#8321;"</span> <span style="color: #2d9574;">"&#8322;"</span> <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #2d9574;">"&#8324;"</span> <span style="color: #2d9574;">"&#8325;"</span> <span style="color: #2d9574;">"&#8326;"</span> <span style="color: #2d9574;">"&#8327;"</span> <span style="color: #2d9574;">"&#8328;"</span> <span style="color: #2d9574;">"&#8329;"</span>
                         ,<span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> toLevel 10<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                 <span style="color: #6c3163;">(</span>here <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">-elem-index</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> lvl<span style="color: #887070;">)</span> subs<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
             <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> it
                   <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> here

                       <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> it
                         <span style="color: #887070;">(</span>'inc <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">1+</span> here<span style="color: #6c3163;">)</span> subs<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                         <span style="color: #887070;">(</span>'dec <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">nth</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">1-</span> here<span style="color: #6c3163;">)</span> subs<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

                     <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">pcase</span> it
                       <span style="color: #887070;">(</span>'inc <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"Level.suc (%s)"</span> lvl<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                       <span style="color: #887070;">(</span>'dec <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"suc"</span>
                                     <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"suc"</span> lvl <span style="color: #3a81c3;">:omit-nulls</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

             <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> it <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> it 'none<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:alter-elements &#8776; Access the typed name constituents list.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Perform *all* element alterations,</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in the left-to-right &#10228; order; if any at all.</span>
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for ae in <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">mapcar</span> #'<span style="color: #6c3163; font-weight: bold;">cdr</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span>
                                              <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> '<span style="color: #3a81c3;">:alter-elements</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                                              alterations<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
            <span style="color: #6c3163; font-weight: bold;">do</span>
            <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;
                  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">cl-remove-duplicates</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">--filter</span> it <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">funcall</span> ae $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                                     <span style="color: #3a81c3;">:test</span> #'<span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #3a81c3;">:from-end</span> <span style="color: #715ab1;">t</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Filter in only the non-nil constituents &amp; those not</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">starting with &#8220;--&#8221; &amp; remove duplicates.</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We do this each time, rather than at the end, since</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">variationals may loop over all possible elements and we do not</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;;  </span><span style="color: #2aa1ae; background-color: #ecf3ec;">want to consider intermediary nils or duplicates.</span>
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setf</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-elements</span> self<span style="color: #67b11d;">)</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;<span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We've just formed a new PackageFormer, which can be modified,</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">specialised, later on.</span>
      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">add-to-list</span> '<span style="color: #715ab1;">pf--package-formers</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> $&#119899;&#119886;&#119898;&#119890; self<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> show-it <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> self<span style="color: #67b11d;">)</span> $&#119899;&#119886;&#119898;&#119890;<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org748efc0" class="outline-3">
<h3 id="-pf--load-700-comments--and--lisp--blocks"><span class="section-number-3">7.2</span> <code>pf--load-700-comments</code> and <code>lisp</code> blocks</h3>
<div class="outline-text-3" id="text--pf--load-700-comments--and--lisp--blocks">
<p>
We already two global lists &#x2014;for our loaded PackageFormers and varitionals
declarared&#x2014; we need two additional globals: One for the contents of <a href="#org81f2700">700-comments</a>,
primarily for basic efficiency, and the other to port whatever is within
<a href="#org81f2700">700-comments</a> but is not <a href="#orge0fd48a">700-syntax</a>. The latter is for when we want definitions
or generalised variables to be accessible in <i>both</i> <a href="#org81f2700">700-comments</a> and the
surrounding script. Which is achieved since the matter is exported to
the generated file in the Elisp stage, then imported at the Agda level.
</p>

<p>
However, since content to be ported may occur between PackageFormer definitions
and instance declarations, we need to remember the position of items that are ported.
The simplest thing to do is simply place items for porting into the package-formers
list &#x2014;then take care to check if an item is for porting or not when printing
PackageFormers to a generated file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf--annotations</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"The contents of the PackageFormer annotations.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">If this variable does not change, we short-circut all processing."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<ul class="org-ul">
<li>Parse comments of the form “{-700 ⋯ -}” and add all PackageFormer declarations
to the ‘package-formers’ list and load all instantations to the list as well.</li>

<li><p>
We also execute any valid Lisp code in “{-lisp -}” comments;
which may contain an arbitrary number of Lisp forms
&#x2014;a ‘progn’ is auto provided.
</p>

<p>
Lisp is executed before any pf&#x2013;annotations are; which is preferable
due to Lisp's dynamic scope.
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">pf--load-pf--annotations</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse and load {-700&#8943;-} syntax.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('load-pf--annotations)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">First, let's run all the lisp. We enclose each in a progn in-case the user</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">has multiple forms in a single lisp-block.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for <span style="color: #2d9574;">(</span>lispstart . lispend<span style="color: #2d9574;">)</span> in '<span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-lisp"</span> . <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
        <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for lispstr in
                 <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited-whole-buffer</span> lispstart lispend<span style="color: #67b11d;">)</span>
                 <span style="color: #6c3163; font-weight: bold;">do</span>
                 <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">eval</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">read-from-string</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"(progn %s)"</span> lispstr<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For now, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">item</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is a PackageFormer,</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">instantiation declaration, or other Agda code.</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let</span> <span style="color: #2d9574;">(</span>item lines 700-cmnts<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Catenate all pf--annotations into a single string.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> 700-cmnts <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span>
                            <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited-whole-buffer</span>
                             <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span>
                             <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #715ab1;">pf--annotations</span> 700-cmnts<span style="color: #67b11d;">)</span>

        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"pf--annotations Unchanged."</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update global.</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">pf--annotations</span> 700-cmnts<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">View comments as a sequence of lines, ignore empty lines</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">---which are not in our grammar.</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--remove</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-collapse-whitespace</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                            <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-lines</span> <span style="color: #715ab1;">pf--annotations</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Traverse the pf--annotations:</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; Skip comments; lines starting with &#8220;-- &#8221;.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we see a &#8220;&#119985;-lhs = rhs&#8221; equation, then load it as a variational.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we view a &#8220;lhs = rhs&#8221; equation, then load it as an</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">instance delcaration.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we view a PackageFormer declaration, then load it into our</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">package-formers list.</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">while</span> lines
        <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> item <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

        <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-shared-start</span> <span style="color: #2d9574;">"-- "</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> item<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
            <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

          <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-blank?</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">s-shared-start</span> <span style="color: #2d9574;">"&#119985;-"</span> item<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-variational</span> item<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

            <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">s-contains?</span> <span style="color: #2d9574;">" = "</span> item<span style="color: #2d9574;">)</span>
                <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">progn</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-instance-declaration</span> item<span style="color: #887070;">)</span>
                       <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> lines<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Else we have a PackageFormer declaration</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and other possiblly-non-700 items.</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> item <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">pf--get-children</span> <span style="color: #2d9574;">"PackageFormer"</span> lines<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">port non-700 items to generated file</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> 'porting <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> item<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                    <span style="color: #715ab1;">pf--package-formers</span><span style="color: #2d9574;">)</span>

              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">acknowledge PackageFormer declaration, if any</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> item<span style="color: #887070;">)</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-package-former</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">cadr</span> item<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update lines to be the unconsidered porition</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">of the wild comments.</span>
              <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> lines <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">caddr</span> item<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"Finished parsing pf--annotations."</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org68c368b" class="outline-2">
<h2 id="Emacs-Interface"><span class="section-number-2">8</span> Emacs Interface</h2>
<div class="outline-text-2" id="text-Emacs-Interface">
</div>

<div id="outline-container-org01fbbe2" class="outline-3">
<h3 id="Tooltips"><span class="section-number-3">8.1</span> Tooltips</h3>
<div class="outline-text-3" id="text-Tooltips">
<p>
It gets rather tedious to jump to the generated files to see the elaborations
of 700-syntactical items. As such, let's tie existing occurrences of a PackageFormer's
name to its elaboration.
</p>

<p>
We only add tooltips to PHRASE as a standalone word, not as a subword.
</p>

<p>
The PHRASE is taken literally; no regexp operators are recognised.
</p>

<p>
Useful info on tooltips:
</p>
<ul class="org-ul">
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2013/04/12/Tool-tips-on-text-in-Emacs/">http://kitchingroup.cheme.cmu.edu/blog/2013/04/12/Tool-tips-on-text-in-Emacs/</a></li>
<li><a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Changing-Properties.html">https://www.gnu.org/software/emacs/manual/html_node/elisp/Changing-Properties.html</a></li>
<li><a href="http://kitchingroup.cheme.cmu.edu/blog/2016/03/16/Getting-graphical-feedback-as-tooltips-in-Emacs/">http://kitchingroup.cheme.cmu.edu/blog/2016/03/16/Getting-graphical-feedback-as-tooltips-in-Emacs/</a></li>
<li><a href="https://stackoverflow.com/questions/293853/defining-new-tooltips-in-emacs">https://stackoverflow.com/questions/293853/defining-new-tooltips-in-emacs</a></li>
</ul>

<p>
The second resource above shows how to alter the phrase's font to indicate that it has
a tooltip. It is not desirable for us, since we want to add onto Agda's colouring.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Nearly instantaneous display of tooltips.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #6c3163; font-weight: bold;">tooltip-delay</span> 0<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Give user 30 seconds before tooltip automatically disappears.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">tooltip-hide-delay</span> 30<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--tooltipify</span> <span style="color: #6c3163;">(</span>phrase notification<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Add a tooltip to every instance of PHRASE to show NOTIFICATION.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">&lt;&lt;docs('tooltipify)&gt;&gt;"</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">stringp</span> phrase<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">should</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">stringp</span> notification<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">save-excursion</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return cursour to current-point afterwards.</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> 1<span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The \b are for empty-string at the start or end of a word.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">search-forward-regexp</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"\\b%s\\b"</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">regexp-quote</span> phrase<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-max</span><span style="color: #b1951d;">)</span> <span style="color: #715ab1;">t</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">put-text-property</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">match-beginning</span> 0<span style="color: #b1951d;">)</span>
                         <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">match-end</span> 0<span style="color: #b1951d;">)</span>
                         'help-echo
                         <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-trim</span> notification<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
New textual occurrences of a name obtain tooltips when <code>C-c C-l</code> is invoked.
</p>
</div>
</div>
<div id="outline-container-orgf3241f5" class="outline-3">
<h3 id="Advising-our-Beloved--C-c-C-l-"><span class="section-number-3">8.2</span> Advising our Beloved <code>C-c C-l</code></h3>
<div class="outline-text-3" id="text-Advising-our-Beloved--C-c-C-l-">
<p>
Let's give the current buffer access to the location of the generated file.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--insert-generated-import</span> <span style="color: #6c3163;">(</span>name-of-generated-file<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Insert an import pointing to the generated file.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">In the current file, find the top-most module declaration</span>
<span style="color: #da8b55; background-color: #ecf3ec;">then insert an import to NAME-OF-GENERATED-FILE."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">save-excursion</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">condition-case</span> _
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">attemptClause:</span>
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">re-search-forward</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"open import "</span> name-of-generated-file<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">recoveryBody:</span>
      <span style="color: #67b11d;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box (format "%s" the-err))</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">re-search-forward</span> <span style="color: #2d9574;">"</span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">(</span><span style="color: #2d9574;">module.*</span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">)</span><span style="color: #2d9574;">"</span><span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">replace-match</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"\\1\nopen import "</span> name-of-generated-file<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The aim is to process test enclosed in <code>{-700 ⋯ -}</code> comments,
produce legitimate Agda from that, and ensure the generated Agda is accessible to the
current buffer automatically.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf-waiting-for-agda-threshhold</span> 14 <span style="color: #da8b55; background-color: #ecf3ec;">"\</span>
<span style="color: #da8b55; background-color: #ecf3ec;">How long we should wait for Agda before giving up on colouring and tooltips.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">Default is to wait 4 &#215; 0.5 milliseconds.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">Why? An inital &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">agda2-load</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; of a ~300 line file may take some time."</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf--reify-package-formers</span> <span style="color: #6c3163;">(</span>orig-fun <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> args<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse package-former syntax and produce Agda when possible.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">ORIG-FUN is intended to be the Agda loading process with arguments ARGS."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span>printed-pfs
        <span style="color: #67b11d;">(</span>parent-dir <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"/"</span>
                            <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">-drop-last</span> 1 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">s-split</span> <span style="color: #2d9574;">"/"</span> <span style="color: #715ab1;">buffer-file-truename</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>generatedmodule  <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--generated-file-name</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>newfile <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> parent-dir <span style="color: #2d9574;">"/"</span> generatedmodule <span style="color: #2d9574;">".agda"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>parent-imports <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--extract-imports</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Load variationals, PackageFormers, instantiations, and porting list.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Setting the following to nil each time is not ideal.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span>   <span style="color: #715ab1;">pf--variationals</span>
             <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">-take-last</span> <span style="color: #715ab1;">&#9839;standard-variationals</span> <span style="color: #715ab1;">pf--variationals</span><span style="color: #67b11d;">)</span>
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">take last n items, those being exported into the .el.</span>
             <span style="color: #715ab1;">pf--package-formers</span>       nil
             <span style="color: #715ab1;">pf--annotations</span>           nil<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--load-pf--annotations</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">with-temp-buffer</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Copy/paste imports from parent file.</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">insert</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n"</span> `<span style="color: #3a81c3;">(</span>
         <span style="color: #2d9574;">"{- This file is generated ;; do not alter. -}\n"</span>
         ,parent-imports
         <span style="color: #2d9574;">"open import Level as Level using (Level)"</span>
         ,<span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"module %s where "</span> generatedmodule<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Print the package-formers</span>
      <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> printed-pfs
            <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">--map</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">cond</span>
               <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> 'porting <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s"</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
               <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"_"</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">car</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>      <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Anonymous PackageFormers</span>
               <span style="color: #6c3163;">(</span><span style="color: #715ab1;">t</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">format</span>
                <span style="color: #887070;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">pf--package-former-kind</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cdr</span> it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                    <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"{- Kind &#8220;PackageFormer&#8221; does not correspond "</span>
                            <span style="color: #2d9574;">" to a concrete Agda type. \n%s\n -}"</span><span style="color: #3a81c3;">)</span>
                       <span style="color: #2d9574;">"%s"</span><span style="color: #887070;">)</span> <span style="color: #887070; background-color: #fbf8ef;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">pf--show-package-former </span><span style="color: #3a81c3; background-color: #fbf8ef;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">cdr it</span><span style="color: #3a81c3; background-color: #fbf8ef;">)</span><span style="color: #887070; background-color: #fbf8ef;">)</span><span style="color: #2d9574; background-color: #fbf8ef;">)</span><span style="color: #6c3163; background-color: #fbf8ef;">)</span><span style="color: #3a81c3; background-color: #fbf8ef;">)</span>
             <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">reverse</span> <span style="color: #715ab1;">pf--package-formers</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">insert</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">s-join</span> <span style="color: #2d9574;">"\n\n\n"</span> printed-pfs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(setq package-formers nil) ;; So no accidental</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Replace tabs with spaces</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">untabify</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-max</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">write-region</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">point-max</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> newfile<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--insert-generated-import</span> generatedmodule<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Need to revert buffer to discard old colours.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(save-buffer) (revert-buffer t t t)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">call agda2-load</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">apply</span> orig-fun args<span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Agda attaches &#8220;jump to definition&#8221; tooltips; we add to those.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For some reason we need a slight delay between when Agda is done checking</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and when we can add on our tooltips.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Attach tooltips only for existing occurrences; update happens with C-c C-l.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Wait until Agda is finished highlighting, then do ours (&#3591;&#3232;_&#3232;)&#3591;</span>
  <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">-let</span> <span style="color: #67b11d;">[</span>counter 0<span style="color: #67b11d;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">agda2-in-progress</span>
    <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #715ab1;">agda2-highlight-in-progress</span>
      <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">&gt;</span> counter <span style="color: #715ab1;">pf-waiting-for-agda-threshhold</span><span style="color: #3a81c3;">)</span>
        <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"PackageFormer &#8759; "</span>
                       <span style="color: #2d9574;">"Items generated, but not coloured; "</span>
                       <span style="color: #2d9574;">"Agda seems busy..."</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">incf</span> counter<span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">sleep-for</span> 0.5<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">In case Agda errors on a term, no more waiting.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for <span style="color: #67b11d;">(</span>name . pf<span style="color: #67b11d;">)</span> in <span style="color: #715ab1;">pf--package-formers</span>
          <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">unless</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">equal</span> 'porting name<span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--tooltipify</span> name <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">pf--show-package-former</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Special anonymous names.</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">pf--tooltipify</span> <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">"&#8220;_&#8221; is the name of anonymous PackageFormers, which cannot be elaborated."</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's also add tooltips for the variationals &amp; colour them.</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for <span style="color: #67b11d;">(</span>v . docs<span style="color: #67b11d;">)</span> in <span style="color: #715ab1;">pf--variationals</span>
          <span style="color: #6c3163; font-weight: bold;">do</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--tooltipify</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s"</span> v<span style="color: #b1951d;">)</span> docs<span style="color: #67b11d;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For beauty, let's colour variational names green.</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Only colour occurances that have a space before or after.</span>
          <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">when</span> <span style="color: #715ab1;">pf-highlighting</span>
            <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">highlight-phrase</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"[- </span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">|</span><span style="color: #2d9574;"> ]%s "</span> v<span style="color: #3a81c3;">)</span> '<span style="color: #655370; background-color: #fbf8ef;">hi-green</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"PackageFormer &#8759; All the best coding! (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Personal note:
Using <code>(write-file "Generated.agda")</code> means we make a file
then the temporary buffer <i>visits</i> the Agda file, which loads the
Agda process therein, which is undesirable since it could leave
Agda working on the buffer even after it has been killed!
</p>
<ul class="org-ul">
<li>This would necessiate calling <code>(agda2-restart)</code> afterwards.</li>
<li>Instead we write the whole region, without visiting the resuting file.</li>
</ul>
</div>
</div>

<div id="outline-container-orgefcc738" class="outline-3">
<h3 id="Menu-matter"><span class="section-number-3">8.3</span> Menu matter</h3>
<div class="outline-text-3" id="text-Menu-matter">
<p>
Let's quickly add a menu bar that allows users to enable or disable using PackageFormer's;
along with a brief help menu.
</p>

<p>
Names with a double dash are intended to be private, not to be touched by users.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defvar</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">make-sparse-keymap</span> <span style="color: #2d9574;">"PackageFormer"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Enabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-enable-package-formers</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Enable PackageFormer Generation"</span> <span style="color: #6c3163; font-weight: bold;">pf-enable-package-formers</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-enable-package-formers</span> <span style="color: #6c3163;">()</span>
 <span style="color: #da8b55; background-color: #ecf3ec;">"Add a menubar, and make Agda's &#119914;-&#119888; &#119914;-&#119949; consider package-former syntax."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">global-map</span> <span style="color: #2d9574;">[</span>menu-bar pf--menu<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #715ab1;">pf--menu-bar</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">advice-add</span> '<span style="color: #6c3163; font-weight: bold;">agda2-load</span> <span style="color: #3a81c3;">:around</span> #'<span style="color: #6c3163; font-weight: bold;">pf--reify-package-formers</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">message-box</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">concat</span> <span style="color: #2d9574;">"C-c C-l now reifies PackageFormer annotations"</span>
                      <span style="color: #2d9574;">"into legitimate Agda."</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Disabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-disable-package-formers</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Disable PackageFormer Generation"</span> <span style="color: #6c3163; font-weight: bold;">pf-disable-package-formers</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-disable-package-formers</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Remove menubar, and make Agda's &#119914;-&#119888; &#119914;-&#119949; act as normal."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">global-map</span> <span style="color: #2d9574;">[</span>menu-bar pf--menu<span style="color: #2d9574;">]</span> nil<span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">advice-remove</span> '<span style="color: #6c3163; font-weight: bold;">agda2-load</span> #'<span style="color: #6c3163; font-weight: bold;">pf--reify-package-formers</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">global-mode-string</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">remove</span> <span style="color: #2d9574;">"PackageFormer (&#8226;&#768;&#7447;&#8226;&#769;)&#1608; "</span> <span style="color: #715ab1;">global-mode-string</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">message-box</span> <span style="color: #2d9574;">"C-c C-l now behaves as it always has."</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> About menu </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-package-formers-about</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"About PackageFormers"</span> <span style="color: #6c3163; font-weight: bold;">pf-package-formers-about</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-package-formers-about</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Show help about the PackageFormer system."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">switch-to-buffer</span> <span style="color: #2d9574;">"*PackageFormer-About*"</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">insert</span> <span style="color: #2d9574;">"\</span>
<span style="color: #2d9574;">This is an editor extension prototyping &#8220;the next 700 module systems&#8221;</span>
<span style="color: #2d9574;">proposed research.</span>

<span style="color: #2d9574;">An informal documentation, with examples, page can be found at</span>
<span style="color: #2d9574;">https://alhassy.github.io/next-700-module-systems/prototype/package-former.html</span>

<span style="color: #2d9574;">The technical matter can be found at</span>
<span style="color: #2d9574;">https://alhassy.github.io/next-700-module-systems/</span>

<span style="color: #2d9574;">If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #2d9574;">please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Bare Bones Agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span>pf--bare-bones<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Copy file with PackageFormer annotations stripped away"</span>
              pf--bare-bones<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-bare-bones</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Duplicate the current buffer with PackageFormer annotations stripped away."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>src <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">file-name-sans-extension</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">buffer-name</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>src-agda <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s.agda"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>bare-agda <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"%s-bare.agda"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
   <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">with-temp-buffer</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">insert-file-contents</span> src-agda<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">re-search-forward</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"module %s"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">replace-match</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">format</span> <span style="color: #2d9574;">"module %s-bare"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">loop</span> for pre in '<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-lisp"</span> <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span><span style="color: #b1951d;">)</span>
      <span style="color: #6c3163; font-weight: bold;">do</span>
      <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">point-min</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">pf--buffer-substring-delimited-whole-buffer</span> pre <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span>
           <span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">lambda</span> <span style="color: #6c3163;">(</span>sp ep<span style="color: #6c3163;">)</span>
             <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">save-excursion</span>
             <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">goto-char</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">-</span> sp 2<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">push-mark</span> ep<span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">mark-active</span> <span style="color: #715ab1;">t</span><span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">delete-region</span> <span style="color: #887070;">(</span><span style="color: #6c3163; font-weight: bold;">-</span> sp 2<span style="color: #887070;">)</span> ep<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">write-file</span> bare-agda<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"%s_Bare.agda has been written."</span> src<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Menu of Defined PackageFormer Contents </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-show-variationals</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Show all registered variationals"</span> <span style="color: #6c3163; font-weight: bold;">pf-show-variationals</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-show-variationals</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Show all user declared &#119985;ariationals in another buffer."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">occur</span> <span style="color: #2d9574;">"&#119985;[ </span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">|</span><span style="color: #2d9574;">-]"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-show-pfs</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Show all concrete PackageFormers"</span> <span style="color: #6c3163; font-weight: bold;">pf-show-pfs</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-show-pfs</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Show all user declared PackageFormer's in another buffer."</span>
 <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">occur</span> <span style="color: #2d9574;">"PackageFormer .* where"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Folding Away PackageFormer Annotations </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">pf--menu-bar</span> <span style="color: #6c3163;">[</span><span style="color: #6c3163; font-weight: bold;">pf-fold-annotations</span><span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Toggle folding away &#8220;700&#8221; and &#8220;lisp&#8221; blocks"</span>
              <span style="color: #6c3163; font-weight: bold;">pf-fold-annotations</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defun</span> <span style="color: #6c3163; font-weight: bold;">pf-fold-annotations</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Fold all items enclosed in Agda comments &#8220;{- &#8943; -}&#8221;."</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">interactive</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">setq</span> <span style="color: #715ab1;">pf-folding</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">not</span> <span style="color: #715ab1;">pf-folding</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #715ab1;">pf-folding</span>
      <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"Use &#8220;C-c f t&#8221; to toggle folding blocks"</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">origami-open-all-nodes</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">current-buffer</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">message</span> <span style="color: #2d9574;">"Blocks &#8220;700&#8221; and &#8220;lisp&#8221; have been unfolded."</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Basic origami support for Agda.</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">push</span> <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> '<span style="color: #6c3163; font-weight: bold;">agda2-mode</span> <span style="color: #2d9574;">(</span><span style="color: #6c3163; font-weight: bold;">origami-markers-parser</span> <span style="color: #2d9574;">"{-"</span> <span style="color: #2d9574;">"-}"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
      <span style="color: #715ab1;">origami-parser-alist</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Along with a hydra for super quick navigation</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and easily folding, unfolding blocks!</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">defhydra</span> folding-with-origami-mode <span style="color: #6c3163;">(</span><span style="color: #715ab1;">global-map</span> <span style="color: #2d9574;">"C-c f"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"h"</span> <span style="color: #6c3163; font-weight: bold;">origami-close-node-recursively</span> <span style="color: #2d9574;">"Hide"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"o"</span> <span style="color: #6c3163; font-weight: bold;">origami-open-node-recursively</span>  <span style="color: #2d9574;">"Open"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"t"</span> <span style="color: #6c3163; font-weight: bold;">origami-toggle-all-nodes</span>  <span style="color: #2d9574;">"Toggle buffer"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"n"</span> <span style="color: #6c3163; font-weight: bold;">origami-next-fold</span> <span style="color: #2d9574;">"Next"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #2d9574;">"p"</span> <span style="color: #6c3163; font-weight: bold;">origami-previous-fold</span> <span style="color: #2d9574;">"Previous"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Let's pack these together into a minor mode.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Minor mode </font> </strong> </summary>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;;;</span><span style="color: #2aa1ae; background-color: #ecf3ec;">###</span><span style="color: #dc752f; background-color: #fbf8ef;">autoload</span>
<span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">define-minor-mode</span> <span style="color: #6c3163; font-weight: bold;">agda-next-700-module-systems-mode</span> <span style="color: #da8b55; background-color: #ecf3ec;">"\</span>
<span style="color: #da8b55; background-color: #ecf3ec;">An editor extension prototyping &#8220;the next 700 module systems&#8221; proposed research.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">An informal documentation, with examples, page can be found at</span>
<span style="color: #da8b55; background-color: #ecf3ec;">https://alhassy.github.io/next-700-module-systems-proposal/PackageFormer.html</span>

<span style="color: #da8b55; background-color: #ecf3ec;">The technical matter can be found at</span>
<span style="color: #da8b55; background-color: #ecf3ec;">https://alhassy.github.io/next-700-module-systems-proposal/</span>

<span style="color: #da8b55; background-color: #ecf3ec;">If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;"</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Icon to display indicating the mode is enabled.</span>
  <span style="color: #3a81c3;">:lighter</span> <span style="color: #2d9574;">" PackageFormer (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span>
  <span style="color: #3a81c3;">:require</span> 'foo

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Toggle the menu bar</span>
  <span style="color: #6c3163;">(</span><span style="color: #6c3163; font-weight: bold;">define-key</span> <span style="color: #715ab1;">global-map</span> <span style="color: #2d9574;">[</span>menu-bar pf--menu<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">and</span> <span style="color: #6c3163; font-weight: bold;">agda-next-700-module-systems-mode</span> <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">cons</span> <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #715ab1;">pf--menu-bar</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">letf</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span><span style="color: #6c3163; font-weight: bold;">symbol-function</span> '<span style="color: #6c3163; font-weight: bold;">message-box</span><span style="color: #b1951d;">)</span> #'<span style="color: #6c3163; font-weight: bold;">message</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163; font-weight: bold;">agda-next-700-module-systems-mode</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Initilisation</span>
        <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf-enable-package-formers</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Closing</span>
      <span style="color: #67b11d;">(</span><span style="color: #6c3163; font-weight: bold;">pf-disable-package-formers</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The file ought to also contain one or more autoload magic comments, as explained in
<a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Packaging-Basics.html#Packaging-Basics">Packaging Basics</a>.
</p>

</details>
</div>
</div>
</div>

<div id="outline-container-orge8dc799" class="outline-2">
<h2 id="Work"><span class="section-number-2">9</span> <span class="done Future">Future</span> &amp; Related Work</h2>
<div class="outline-text-2" id="text-Work">
<p>
Well, that was a lot of Lisp I had to learn <code>(งಠ_ಠ)ง</code>
</p>

<p>
Hopefully the resulting prototype will be useful to others;
drop me a line if you're interested in this effort or have
any feedback or pointers!
</p>

<div class="org-center">
<p>
★ ★ ★
</p>
</div>
</div>

<div id="outline-container-orge4ad328" class="outline-3">
<h3 id="Features-Wish-list"><span class="section-number-3">9.1</span> Features Wish-list</h3>
<div class="outline-text-3" id="text-Features-Wish-list">
<p>
We check them off, rather than deleting them,
to produce a ‘tada’ list of features ;-)
</p>

<ul class="org-ul">
<li class="on"><code>[X]</code> For now, arguments must be enclosed in parenthesis.
<ul class="org-ul">
<li class="on"><code>[X]</code> This is likely to be dropped in a future edition of the system.</li>
</ul></li>

<li class="on"><code>[X]</code> Colouring for 700-syntactical items.</li>

<li class="on"><code>[X]</code> Tooltips</li>

<li class="off"><code>[&#xa0;]</code> Some menu items are a bit buggy &#x2014;this is low-priority.</li>

<li class="off"><code>[&#xa0;]</code> MA: WK: hiding ↦ dropping</li>

<li class="off"><code>[&#xa0;]</code> Use pf&#x2013;buffer-substring-delimited-whole-buffer to parse <i>multiple</i>
pf&#x2013;annotations!</li>

<li class="off"><code>[&#xa0;]</code> Add a level component to an instance structure; reduce it if Carrier is a parameter and otherwise leave it alone.
Instead, let the level of a PackageFormer denote the level of the typeclass instantiation, then with this in mind
we increase the level component of an instance structure only for those variations that keep the carrier as a field.
When we move to multi-sorted, as in Graphs, this issue will need to be revisited.</li>

<li class="on"><code>[X]</code> Currently can only perform simple variational clauses; need to support complex clauses.</li>

<li class="on"><code>[X]</code> Support for equations in PackageFormers: Easy, nothing new needed! Thank-you <code>alter-elements</code>!</li>

<li class="on"><code>[X]</code> Examples from the user-manual
should be exported into an Agda file which is then easily checked;
or the resulting generated code should be generated when export happens.</li>

<li class="off"><code>[&#xa0;]</code> We can only perform “LHS = PF 𝓋𝒸”, do we also want stand-alone “PF 𝓋𝒸”?
<ul class="org-ul">
<li>Maybe not? Maybe it suffices to use, say, “_ = PF 𝓋𝒸”?</li>
</ul></li>

<li class="on"><code>[X]</code> Need to implement a <b>front-end</b> system to extend variational clauses.</li>

<li class="off"><code>[&#xa0;]</code> The <code>elements</code> of a PackageFormer should be  an alist, <code>'(name . type)</code>.
<ul class="org-ul">
<li>Maybe not, the front-end lets users treat them as strings, easily.</li>
<li>Maybe such a view is useful for the user? It is provided via <code>get-name</code> and <code>get-type</code>.</li>
</ul></li>

<li class="on"><code>[X]</code> Refactor load-instantions function to make use of an <code>alter</code> field rather than overloading alter-<a href="#orgb32f32d">fields</a> in reify-instances.</li>

<li class="on"><code>[X]</code> Refactor <code>instantiate</code> to make use of an <code>instance</code> structure, rather than 13 arguments.
<ul class="org-ul">
<li>In my defence, 13 arguments was because I was trying to find out what were the key ingredients
necessary to form different variational presentations. It seems I only needed 5 ^_^</li>
</ul></li>

<li class="off"><code>[&#xa0;]</code> Why does ‘pf&#x2013;buffer-substring-delimited-whole-buffer’ return a list of strings? Why not join its result to simply return a list?</li>

<li class="on"><code>[X]</code> Generated.agda needs to inherit all open/import declarations from parent.</li>

<li class="off"><code>[&#xa0;]</code> Give an example PackageFormer with some definitions or derived constructs, then hoist-up your waist so that the non-defined items are <code>module</code> <a href="#orged238e3">parameters</a>.</li>

<li class="on"><code>[X]</code> PF's should account for equations. For simplicity they become components of a record &amp; module, but derived operations on datatypes.</li>

<li class="off"><code>[&#xa0;]</code> Demonstrate how generative modules can be emulated.</li>

<li class="off"><code>[&#xa0;]</code> The global variables package-formers &amp; instance-declaration should be <i>buffer</i> specific?</li>

<li class="on"><code>[X]</code> Assign to a local var, check equality against global pf&#x2013;annotations,
if identical, no more processing since everything already generated.</li>

<li class="off"><code>[&#xa0;]</code> Make use of docstring so that when a user enters a key sequence or selects from a menu, we can show them a listing of all ‘major’ components of a program: An org-mode file is displayed with an enumeration of the items, each being a link to the source, and only their docstring is shown. This is a nice ‘overview’ of the program source.</li>

<li class="on"><code>[X]</code> Currently it looks like we are a minor mode, but this is not true. We only have a menu and the icon (•̀ᴗ•́)و is displayed when our feature is supported.
<ul class="org-ul">
<li>Now a minor mode.</li>
</ul></li>

<li class="off"><code>[&#xa0;]</code> Generate all instances of a PackageFormer schema.</li>

<li><code>MR = M-Set primed</code> crashes!</li>

<li class="off"><code>[&#xa0;]</code> Look into <a href="https://github.com/KestrelInstitute/Specware"><b>Specware</b></a>.

<ul class="org-ul">
<li>Structures are created using colimits.</li>
<li>Are hierarchical considerations leaked by the resulting structures?</li>
</ul></li>

<li class="on"><code>[X]</code> <p>
PackageFormer.ext ↦ package-former.ext
</p>

<p>
⇨ kebab-case is conventional of Lisp
</p></li>
<li class="on"><code>[X]</code> <p>
Arguments, in tooltip renditions, are in reverse order; c.f. 𝒱-open.
</p>

<p>
This is because 𝒱 lists them in the wrong order!
</p></li>
<li class="on"><code>[X]</code> colouring should be whole words only; see tooltipify</li>
<li class="on"><code>[X]</code> <p>
Improved concept of PackageFormer constituents
</p>

<p>
Element  ≈  [qualifier] [lhs] [:] [type] [list-of definitional clauses]
</p>

<p>
Eqn      ≈  [same-lhs-as-before] [args] ≈ [term]
</p></li>
<li class="on"><code>[X]</code> extensions of structures can be formed;</li>
<li class="on"><code>[X]</code> Form sum of two PackageFormers!</li>
<li class="on"><code>[X]</code> <p>
Form library of common or useful variations or combinators, using the meta-primitives.
</p>
<dl class="org-dl">
<dt>renaming</dt><dd>Given a function f, apply it to all names.</dd>
<dt>map-elements f</dt><dd>Apply function f to each element.</dd>
<dt>prefix-elements</dt><dd>Given a list of new elements, prepend them to the current list of elements.</dd>
<dt>postfix-elements</dt><dd>Given a list of new elements, postpend them to the current list of elements.</dd>
<dt>drop-elements</dt><dd>Given a predicate, drop the <a href="#orgb32f32d">fields</a> that satisfy it.
<ul class="org-ul">
<li>Moreover, drop additional <a href="#orgb32f32d">fields</a> if they depend on dropped <a href="#orgb32f32d">fields</a>? (maybe).</li>
</ul></dd>
<dt>opening f</dt><dd>Module renaming according to f.</dd>
<dt>manifest</dt><dd>Mention one form; briefly mention others.</dd>
</dl>

<p>
Note that package formation has been liberated from the backend and brought to the user
via our 5 meta-primitives: preamble, kind, waist, waist-strings, level, alter-elements.
</p></li>
<li class="on"><code>[X]</code> Allow “:level” to be ‘inc, dec, omit’ where the last option omits the “: Set ℓ” declaration altogether.
<ul class="org-ul">
<li>Useful for module setups.</li>
</ul></li>
<li class="on"><code>[X]</code> Make a “raw” variation that allows meta-primitives to be invoked whenever.
<ul class="org-ul">
<li>Maybe called 𝓌𝒾𝓉𝒽 ?
➱ Look at load variations, if there are any 𝓌𝒾𝓉𝒽 clauses, then add them to the
   variation's pairs. assoc ensures only latest items are picked up and so
   these would overwrite whatever the variation wanted; neato.
   Perhaps check that 𝓌𝒾𝓉𝒽 clauses only allow meta-primitives?

<ul class="org-ul">
<li>This is accomplished by a combination of a meta-primitive followed by “⟴”.</li>
<li>Unless needed otherwise, this is a non-issue.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org60561c3" class="outline-3">
<h3 id="Equality--From---to---to---"><span class="section-number-3">9.2</span> Equality: From ≡ to ≈ to ≈′</h3>
<div class="outline-text-3" id="text-Equality--From---to---to---">
<p>
One may start from a basic ≡-equality, then <b>mechanically</b> move to a setoid one
by including congruence laws.
</p>
<ul class="org-ul">
<li>Interestingly, sometimes such constructions are invariant under equivalent equalities.
<ul class="org-ul">
<li><a href="http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Props.Lattice.html#2531">http://www.cse.chalmers.se/~nad/listings/lib/Algebra.Props.Lattice.html#2531</a></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org821b3da" class="outline-3">
<h3 id="PackageFormers-with-variational-parameters"><span class="section-number-3">9.3</span> PackageFormers with variational <a href="#orged238e3">parameters</a></h3>
<div class="outline-text-3" id="text-PackageFormers-with-variational-parameters">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> For now, PackageFormer's have no other <a href="#orged238e3">parameters</a> besides the variation symbol &#x2014;not even that atm.</li>
</ul>

<p>
Allow package formers to have explicit <code>Variation</code> <a href="#orged238e3">parameters</a>; but
      how do we then deal with nested invocations? What are the uses of
      having differing invocations?
</p>

<p>
For example,
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer LawfullyPointed</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
   <span style="color: #0000cd;">point</span> :<span style="color: #ba2f59; font-weight: bold;"> LawfullyPointed</span> <span style="color: #0000cd;">v</span>
   <span style="color: #0000cd;">law</span>   :<span style="color: #ba2f59; font-weight: bold;"> LawfullyPointed FOL</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Concrete variation -}</span>

</pre>
</div>
<p>
Would elaborate to something like:
</p>
<div class="org-src-container">
<pre class="src src-agda">       <span style="color: #3a81c3; font-weight: bold;">data</span><span style="color: #ba2f59; font-weight: bold;"> LP-Term (Vars</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) : <span style="color: #3a81c3; font-weight: bold;">Set</span> <span style="color: #3a81c3; font-weight: bold;">where</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Abstract fields from constituents of packageformer -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        Point    : LP-Term</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        </span><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #ba2f59; font-weight: bold;"> Fragment</span> <span style="color: #0000cd;">of</span> <span style="color: #0000cd;">first</span> <span style="color: #0000cd;">order</span> <span style="color: #0000cd;">logic</span> <span style="color: #0000cd;">term</span> <span style="color: #0000cd;">formation</span> -}
        _&#8242;       :<span style="color: #ba2f59; font-weight: bold;"> Vars</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Injection of vars as terms -}</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        _&#8776;_      : LP-Term &#8594; LP-Term &#8594; LP-Term</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        &#8704;&#8242; &#8707;&#8242;    : (Vars &#8594; LP-Term) &#8594; LP-Term</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">       record LP : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     constructor _,_,_</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     field</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        point   : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        law     : LP-Term Carrier</span>
</pre>
</div>

<p>
With the following example uses.
</p>
<div class="org-src-container">
<pre class="src src-agda">     <span style="color: #ba2f59; font-weight: bold;"> Contractable</span> :<span style="color: #ba2f59; font-weight: bold;"> (A</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>) (<span style="color: #0000cd;">a</span> :<span style="color: #ba2f59; font-weight: bold;"> A</span>) &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP</span>
     <span style="color: #ba2f59; font-weight: bold;"> Contractable A</span> <span style="color: #0000cd;">a</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;"> A</span> , <span style="color: #0000cd;">a</span> , &#8704;&#8242; (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">a</span> &#8242;)

     <span style="color: #ba2f59; font-weight: bold;"> Indistinguishable</span> :<span style="color: #ba2f59; font-weight: bold;"> (A</span> : <span style="color: #3a81c3; font-weight: bold;">Set</span>)  &#8594; <span style="color: #ba2f59; font-weight: bold;"> LP</span> <span style="color: #3a81c3; font-weight: bold;">hiding</span> <span style="color: #0000cd;">point</span>
     <span style="color: #ba2f59; font-weight: bold;"> Indistinguishable A</span> <span style="color: #0000cd;">a</span> <span style="color: #3a81c3; font-weight: bold;">=</span> <span style="color: #ba2f59; font-weight: bold;"> A</span> , &#8704;&#8242; (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; &#8704;&#8242; (<span style="color: #3a81c3; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">y</span>))
</pre>
</div>
<p>
Where <code>PF hiding c</code> is the largest sub-PackageFormer of <code>PF</code> with constituent <code>c</code>
removed &#x2014;in particular, constituents that depend on <code>c</code> would also be dropped.
</p>
</div>
</div>

<div id="outline-container-org97af640" class="outline-3">
<h3 id="Related-Work"><span class="section-number-3">9.4</span> Related Work</h3>
<div class="outline-text-3" id="text-Related-Work">
<ul class="org-ul">
<li><p>
Theory Presentation Combinators [<a class='org-ref-reference' href="#tpc">tpc</a>]
</p>

<p>
This work aims to provide a sound categorical basis for most of the combinators
in section 2 above, in-particular: Extensions, renames, and pushouts.
The work emphasises the importance of these combinators at the PackageFormer
level but also at the level of morphisms between them &#x2014;which is not something
we are even considering.
</p></li>

<li><p>
<a href="https://github.com/ysharoda/PhD-Proposal/blob/master/proposal.pdf">Leveraging the information contained in theory presentations</a> (PhD Proposal)
</p>

<p>
This work focuses on <i>library combinators that give free common constructions</i>
such as deriving the type of homomorphisms from a given PackageFormer.
We have shown this particular example, in section 2 of the user manual, to
demonstrate how our low-level setup can be used in the creation of such
combinators.
</p>

<p>
<b>We provide a low-level kernel which supports the creation of such combinators, but we are not studying such combinators, their use, their classifications, nor their theory.</b>
</p></li>

<li><p>
A Scalable Module System [link]
</p>

<p>
An impressive work, the MMT language &#x2014;a module system for mathematical theories&#x2014;
may serve as a standardised representation format for a formal,
web-scalable, digital
library that supports mathematical knowledge management ‘in the large’.
The resulting system is not only logic-independent but also foundation-independent;
unlike [<a class='org-ref-reference' href="#tpc">tpc</a>], it shifts semantic concerns to concrete instances but
allows more than first-class morphisms between contexts, going up to morphisms
between logics.
</p>

<p>
<b>Whereas one focus of this work is the developement of a standardised format and library of mathematical knowledge management, our aims are more humble: An extensible and mouldable module system for programmers via a kernel of meta-primitives.</b>
</p></li>
</ul>
</div>
</div>
</div>
<p>

<h1 class='org-ref-bib-h1'>Bibliography</h1>
<ul class='org-ref-bib'><li><a id="agda_overview">[agda_overview]</a> <a name="agda_overview"></a>Ana Bove, Peter Dybjer & Ulf Norell, A Brief Overview of Agda -- A Functional Language  with Dependent Types, 73-78, in in: Theorem Proving in Higher Order Logics, 22nd
                  International Conference, TPHOLs 2009, Munich,
                  Germany, August 17-20, 2009. Proceedings, edited by (2009)</li>
<li><a id="tpc">[tpc]</a> <a name="tpc"></a>Carette & O’Connor, Theory Presentation Combinators, <i>Intelligent Computer Mathematics</i>,  202–215 (2012). <a href="http://dx.doi.org/10.1007/978-3-642-31374-5_14">doi</a>.</li>
<li><a id="little_theories">[little_theories]</a> <a name="little_theories"></a>"Farmer, , Guttman, & Javier Thayer, Little theories, 567-581, in in: "Automated Deduction--CADE-11", edited by "Kapur, Springer Berlin Heidelberg (1992)</li>
</ul>
</p>
<div id="outline-container-orgf2a86d5" class="outline-2">
<h2 id="Works-to-look-into"><span class="section-number-2">10</span> <span class="todo TODO">TODO</span> Works to look into</h2>
<div class="outline-text-2" id="text-Works-to-look-into">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> <p>
Mei — A Module System for Mechanized Mathematics Systems
</p>
<ol class="org-ol">
<li>Xu</li>
</ol>
<p>
In: J. Carette and F. Wiedijk, eds., Proceedings of Programming Languages for Mechanized Mathematics (PLMMS 2007), 17 pp., Hagenburg, Austria, June 29-30, 2007.
</p></li>

<li class="off"><code>[&#xa0;]</code> <p>
Formalizing mathematical knowledge as a biform theory graph: A case study Abstract PDF
</p>
<ol class="org-ol">
<li>Carette and W. M. Farmer</li>
</ol>
<p>
In: H. Geuvers, M. England, O. Hasan, F. Rabe, and O. Teschke, eds., Intelligent Computer Mathematics (CICM 2017), Lecture Notes in Computer Science (LNCS), 10383:9–24, 2017 (without appendices). Preprint with appendices: arXiv: 1704.02253 (43 pp.), 2017.
</p></li>

<li class="off"><code>[&#xa0;]</code> J. Carette and W. M. Farmer. High-level theories. In A. Autexier et al., editor,
Intelligent Computer Mathematics, volume 5144 of Lecture Notes in Computer
Science, pages 232–245. Springer-Verlag, 2008.</li>

<li class="off"><code>[&#xa0;]</code> CoFI (The Common Framework Initiative). Casl Reference Manual. LNCS Vol.
2960 (IFIP Series). Springer-Verlag, 2004.</li>

<li class="off"><code>[&#xa0;]</code> W. M. Farmer. Biform theories in Chiron. In M. Kauers, M. Kerber, R. R.
Miner, and W. Windsteiger, editors, Towards Mechanized Mathematical Assistants,
volume 4573 of Lecture Notes in Computer Science, pages 66–79. Springer-Verlag,
<ol class="org-ol">
<li></li>
</ol></li>

<li class="off"><code>[&#xa0;]</code> W. M. Farmer, J. D. Guttman, and F. J. Thayer. IMPS: An Interactive Mathematical Proof System. Journal of Automated Reasoning, 11:213–248, 1993.</li>

<li class="off"><code>[&#xa0;]</code> <p>
Meaning formulas for syntax-based mathematical algorithms PDF
</p>
<ol class="org-ol">
<li>M. Farmer</li>
</ol>
<p>
In: T. Kutsia and A. Voronkov, eds., SCSS 2014 (6th International Symposium on Symbolic Computation in Software Science), EasyChair Proceedings in Computing (EPiC), 30:10–11, 2014.
Extended Abstract.
</p></li>

<li class="off"><code>[&#xa0;]</code> Richard D. Jenks and Robert S. Sutor. AXIOM: The Scientific Computation
System. Springer-Verlag, 1992.</li>

<li class="off"><code>[&#xa0;]</code> Douglas R. Smith. Constructing specification morphisms. Journal of Symbolic
Computation, 15:5–6, 1993.</li>

<li class="off"><code>[&#xa0;]</code> <p>
Douglas R. Smith. Mechanizing the development of software. In M. Broy and
</p>
<ol class="org-ol">
<li>Steinbrueggen, editors, Calculational System Design, Proceedings of the NATO</li>
</ol>
<p>
Advanced Study Institute, pages 251–292. IOS Press, Amsterdam, 1999.
</p></li>

<li class="off"><code>[&#xa0;]</code> Wikipedia “List of algebraic structures”.
<a href="http://en.wikipedia.org/wiki/List%20of%20algebraic%20structures">http://en.wikipedia.org/wiki/List%20of%20algebraic%20structures</a>.</li>
</ul>
</div>
</div>
</div>
</body>
</html>