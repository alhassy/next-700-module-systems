<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-06-10 Mon 20:07 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Package Formers</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Musa Al-hassy" />
<meta name="description" content="Generalising ADTS, records, typeclasses to ‚Äúpackage formers‚Äù."
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
	     margin-bottom: .2em; }
  .subtitle { text-align: center;
	      font-size: medium;
	      font-weight: bold;
	      margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
	    padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Package Formers</h1>

<style>

/* wrap lengthy lines for code blocks */
pre{white-space:pre-wrap}

/* inline code; see here for other colours: https://www.w3schools.com/colors/colors_names.asp */
code { background: LightGray;
       border-radius: 5px; /* How curvy the borders should be. */
}

table {
    background: pink;
    border-radius: 10px; /* How curvy the borders should be. */
    /* width:90% */

    border-bottom: hidden;
    border-top: hidden;

    /* Put table in the center of the page, horizontally. */
    margin-left:auto;margin-right:auto;

    font-family:"Courier New";
    font-size:90%;
}

/* table ‚Äòd‚Äôata elements */
td {
    border: 1px solid red; padding: 1em;
    /* border: none;
    border-left: 1px solid transparent;
    border-right: 1px solid transparent; */


}


/* Alter visible labels of source blocks */
pre.src-agda:before { content: 'Agda'; }
pre.src-haskell:before { content: 'Agda'; }
pre.src-org:before { content: 'Text'; }

/* Using source blocks ‚Äúagda-results‚Äù as pink-background coloured blocks in HTML. */
/* pre.src-results-agda:before { content: 'Results: Agda'; } */
pre.src-results-agda { background: pink;}
/* Execute this for alias: (add-to-list 'org-src-lang-modes '("results-agda" . org-agda)) */

</style>


<div class="org-center">
<p>
<b>Abstract</b>
</p>
</div>

<p>
Editor extension for supporting <a href="https://alhassy.github.io/next-700-module-systems-proposal/">‚Äúthe next 700 module systems‚Äù proposal</a>.
</p>

<p>
In some sense, we are ‚Äúcontinuing‚Äù the story of the Z's schemas.
</p>

<div class="org-center">
<p>
<i>Everything here works with Agda version 2.6.0.</i>
</p>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Results of tests will be in pink, like this (‚îÄ‚Äø‚Äø‚îÄ)</td>
</tr>
</tbody>
</table>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge7b4925">1. <span class="done DONE">DONE</span> Aim: <i>Scrap the Repetition</i></a></li>
<li><a href="#org2302fb5">2. <span class="done DONE">DONE</span> Global Preconditions</a></li>
<li><a href="#org32a9b69">3. <span class="done DONE">DONE</span> Finding Children in the Wild</a></li>
<li><a href="#orgc4e820f">4. <span class="done DONE">DONE</span> Substrings Delimited by Tokens</a></li>
<li><a href="#orgf95b0d4">5. <span class="done DONE">DONE</span> The <code>package-former</code> Datatype</a>
<ul>
<li><a href="#org6340bc8">5.1. Typed Names</a></li>
<li><a href="#org83b39e9">5.2. Package Former Parsing and Pretty Printing</a></li>
</ul>
</li>
<li><a href="#orge6af346">6. Parsing an Agda Buffer</a>
<ul>
<li><a href="#org50bca1f">6.1. instantiations-remaining list</a></li>
<li><a href="#org9fb4831">6.2. parse-700-comments</a></li>
</ul>
</li>
<li><a href="#orgd89ab1e">7. <code>instantiate</code> &#x2014;the core utility</a></li>
<li><a href="#org072bcef">8. Instantiate all items in ‚Äòinstantiations-remaining‚Äô</a></li>
<li><a href="#org4694022">9. Testing&#xa0;&#xa0;&#xa0;<span class="tag"><span class="neato">neato</span></span></a></li>
</ul>
</div>
</div>

<div id="outline-container-orge7b4925" class="outline-2">
<h2 id="orge7b4925"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> Aim: <i>Scrap the Repetition</i></h2>
<div class="outline-text-2" id="text-1">
<p>
We're going to write a code generator in Lisp that is going to interpret
fictitious Agda code &#x2014;henceforth referred to as ‚Äú700 code‚Äù&#x2014;
into currently legitimate Agda code.
</p>

<p>
For example, something like the following, henceforth referred to as <code>test</code>:
</p>
<div class="org-src-container">
<pre class="src src-agda" id="orgcf27a70"><span style="color: #ba2f59; font-weight: bold;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #ba2f59; font-weight: bold;">Semigroup-semantics</span>  <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #cd6600;">record</span>
<span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>     <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #cd6600;">data</span>
<span style="color: #ba2f59; font-weight: bold;">SemigroupOn</span>          <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #cd6600;">typeclass</span>
</pre>
</div>

<p>
Will behave as if it were written:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #cd6600;">record</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-semantics</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #cd6600;">data</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span> : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> SemigroupD</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> SemigroupD</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> SemigroupD</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> SemigroupD</span>

<span style="color: #cd6600;">record</span> <span style="color: #ba2f59; font-weight: bold;">SemigroupOn (Carrier</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>
<p>
This is a nearly <a id="org39a139b">200% increase</a> in size; that is, our fictitious code will
save us a lot of repetition.
</p>
</div>
</div>

<div id="outline-container-org2302fb5" class="outline-2">
<h2 id="org2302fb5"><span class="section-number-2">2</span> <span class="done DONE">DONE</span> Global Preconditions</h2>
<div class="outline-text-2" id="text-2">
<p>
For this prototype, we have the following <a id="orga797d87">constraints</a>:
</p>

<ol class="org-ol">
<li>All package formers have exactly one explicit <code>Variation</code> parameter.
<ul class="org-ul">
<li>They have no other parameters.</li>
</ul></li>

<li>The type of a PackageFormer is <code>Set ‚Ñì</code> where <code>‚Ñì</code> is the empty string
or an expression of type <code>Level</code>.
<ul class="org-ul">
<li>In-particular, subscript types are not yet supported.</li>
</ul></li>

<li>The <code>where</code> keyword appears on the same line as the <code>PackageFormer</code> key-phrase.</li>

<li>The name of the PackageFormer should not contain <code>PackageFormer</code> as a sub-identifier.</li>

<li>The first child of the package former is the <code>field</code> declaration, on its own line.</li>

<li><p>
We are only considering single-sorted structures, for now.
</p>

<p>
The research <a href="https://alhassy.github.io/next-700-module-systems-proposal/">proposal</a> addresses how to move beyond this issue.
</p></li>
</ol>

<p>
There are many other useful features outlined in the proposal, such as default implementations, that we
hope to include in the future. For now, we just want something that works, is decently documented, and
can be useful.
</p>
</div>
</div>
<div id="outline-container-org32a9b69" class="outline-2">
<h2 id="org32a9b69"><span class="section-number-2">3</span> <span class="done DONE">DONE</span> Finding Children in the Wild</h2>
<div class="outline-text-2" id="text-3">
<p>
Being a prototype, we are talking a mostly sting-based approach to working
with hierarchical phrases.
For example, consider the following todo list,
</p>
<div class="org-src-container">
<pre class="src src-org" id="org3898f95">+ item 1
  - subitem 1.1
    * subsubitem 1.1.1
  - subitem 1.2
+ item 2
  - subitem 1.2
+ item 3
</pre>
</div>

<p>
We would think that <code>item 1</code> has two ‚Äòchildren‚Äô, and, moreover, one grand-child.
Whereas <code>item 2</code> has a single child and <code>item 3</code> is barren.
</p>

<p>
Here's my intuitive algorithm: We obtain the indentation of the first child,
then all subsequent lines with at least that much indentation have the same ancestor.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-indentation Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">get-indentation</span> <span style="color: #6c3163;">(</span>string<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"How many spaces are there at the front of &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217;?</span>

<span style="color: #da8b55;">  Property: The resulting number is &#8216;&#8804; length string&#8217;.</span>
<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> string <span style="color: #2d9574;">(</span>length <span style="color: #67b11d;">(</span>s-shared-start string <span style="color: #b1951d;">(</span>s-repeat <span style="color: #3a81c3;">(</span>length string<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> 0<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-children Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">get-children</span> <span style="color: #6c3163;">(</span>parent the-wild <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>then #'identity<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Go into &#8216;</span><span style="color: #4e3163;">the-wild</span><span style="color: #da8b55;">&#8217; seeking out the first occurence of &#8216;</span><span style="color: #4e3163;">parent</span><span style="color: #da8b55;">&#8217;,</span>
<span style="color: #da8b55;">   who once found, ought to have a minimal indentation for its children.</span>

<span style="color: #da8b55;">   &#8220;Minimal&#8221; in that if there are items with a greater indentation,</span>
<span style="color: #da8b55;">    then they are children of children and should be kept.</span>

<span style="color: #da8b55;">   The first input argument is of type &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217;,</span>
<span style="color: #da8b55;">   the second argument may be of type &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217; or &#8216;</span><span style="color: #4e3163;">list</span><span style="color: #da8b55;">&#8217; of strings</span>
<span style="color: #da8b55;">   ---if it's a string, we split along new lines---,</span>
<span style="color: #da8b55;">   the optional &#8216;</span><span style="color: #4e3163;">then</span><span style="color: #da8b55;">&#8217; is a function acting on children strings.</span>

<span style="color: #da8b55;">   Result is the parent followed by its children, as a list of lines,</span>
<span style="color: #da8b55;">   where each child has been altered using the optional &#8216;</span><span style="color: #4e3163;">then</span><span style="color: #da8b55;">&#8217; function.</span>
<span style="color: #da8b55;">   Moreover, we also return the rest of the unconsidered portion of &#8216;</span><span style="color: #4e3163;">the-wild</span><span style="color: #da8b55;">&#8217;:</span>
<span style="color: #da8b55;">   Result: ( (cons parent-line children-lines) . unconsidered-remaining-lines )</span>

<span style="color: #da8b55;">   Warning: We do /not/ return the unconsidered prefix of &#8216;</span><span style="color: #4e3163;">the-wild</span><span style="color: #da8b55;">&#8217;; i.e,</span>
<span style="color: #da8b55;">   the porition that does not contain an occurence of &#8216;</span><span style="color: #4e3163;">parent</span><span style="color: #da8b55;">&#8217;.</span>
<span style="color: #da8b55;">   Why? I currently have no need for it, so I throw it away.</span>

<span style="color: #da8b55;">   Implementation: Look at the indentation of the</span>
<span style="color: #da8b55;">   first child, then use that as a lower bound to find the indentation</span>
<span style="color: #da8b55;">   of the remaining children.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span> <span style="color: #67b11d;">(</span>lines <span style="color: #b1951d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #3a81c3;">(</span>stringp the-wild<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>s-lines the-wild<span style="color: #3a81c3;">)</span> the-wild<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>indentation -1<span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>parent-line nil<span style="color: #67b11d;">)</span> <span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure: lines &#8776; (parent-here . more-lines)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">while</span> <span style="color: #67b11d;">(</span><span style="color: #cd6600;">and</span> <span style="color: #b1951d;">(</span>car lines<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>not <span style="color: #3a81c3;">(</span>s-contains? parent <span style="color: #6c3163;">(</span>car lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">and</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; in-case parent is not even in the list, and so we reach nil.</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #b1951d;">(</span>cdr lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Throw away parent, but keep its contextual line.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> parent-line <span style="color: #67b11d;">(</span>car lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>cdr lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">How far is the first child indented?</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> indentation <span style="color: #67b11d;">(</span>get-indentation <span style="color: #b1951d;">(</span>car lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keep only the children that have at least this level of indentation.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines&amp;more <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--split-with</span> <span style="color: #b1951d;">(</span>&lt;= indentation <span style="color: #3a81c3;">(</span>get-indentation it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>car lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> unconsidered <span style="color: #67b11d;">(</span>cadr lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Alter the children according to the given function.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>mapcar then lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Yield the parent line along with the children lines.</span>
    `<span style="color: #2d9574;">(</span> ,<span style="color: #67b11d;">(</span>cons parent-line lines<span style="color: #67b11d;">)</span> . ,unconsidered <span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Let's try this out on our example hierarchy, <code>eh</code>, from earlier.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"+ item 1"</span> eh<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Excellent! Let's looks at the other parents.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"+ item 2"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">nil</td>
</tr>
</tbody>
</table>

<p>
Notice that we found the parent <code>+ item 2</code> and its only child <code>- subitem 1.2</code>, and
we dropped the prefix of <code>eh</code> that did not contain the parent but have kept
the remaining unconsidered portion of <code>eh</code>.
</p>

<p>
Finally, the barren parent.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"+ item 3"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">nil</td>
</tr>
</tbody>
</table>

<p>
Yay :smile:
</p>

<p>
Before we move on, let's try altering a child clause; e.g., I'd like
<code>* subitem 1.1.1</code> to be renamed to <code>* subitem that is super deep</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"+ item 1"</span> eh
 <span style="color: #3a81c3;">:then</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>s-replace <span style="color: #2d9574;">"1.1.1"</span> <span style="color: #2d9574;">"that is super deep"</span> x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem that is super deep</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Nice :grin:
</p>

<p>
Now the moment of truth, let's try this out on our example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span> <span style="color: #cd6600;">|</span> <span style="color: #cd6600;">field</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>) <span style="color: #cd6600;">|</span>
</pre>
</div>

<p>
Also, does the list variant work:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #2d9574;">(</span>s-lines test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span> <span style="color: #cd6600;">|</span> <span style="color: #cd6600;">field</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>) <span style="color: #cd6600;">|</span>
</pre>
</div>

<p>
Test-driven development doesn't seem bad üò≤
</p>
</div>
</div>

<div id="outline-container-orgc4e820f" class="outline-2">
<h2 id="orgc4e820f"><span class="section-number-2">4</span> <span class="done DONE">DONE</span> Substrings Delimited by Tokens</h2>
<div class="outline-text-2" id="text-4">
<div class="org-center">
<p>
<i>How do we find a string delimited by two tokens?</i>
</p>
</div>

<p>
Before we can get to the real stuff, we need to produce a few low-level &#x2014;string manipulation&#x2014;
utilities, so that we can work with higher-level abstract datatypes.
</p>

<ul class="org-ul">
<li><code>substring-delimited</code>: Given <code>prefix</code> and <code>suffix</code>,
this operation takes a string of the form  <code>‚ãØ‚Äòprefix‚Äô‚ü™needle‚ü´‚Äòsuffix‚Äô‚ãØ</code> and yields <code>needle</code>.</li>
<li><code>substring-delimited-$</code>: Given <code>"‚ü™prefix‚ü´ $here ‚ü™suffix‚ü´"</code>
this operation takes a string of the form  <code>‚ãØ‚Äòprefix‚Äô‚ü™needle‚ü´‚Äòsuffix‚Äô‚ãØ</code> and yields <code>needle</code>.</li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">substring-delimited</span>
    <span style="color: #6c3163;">(</span>prefix suffix string <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> preserve-spaces longest-substring<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Assuming &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #4e3163;">prefix</span><span style="color: #da8b55;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #4e3163;">suffix</span><span style="color: #da8b55;">&#8217;&#8943;, return the /first/ such needle</span>
<span style="color: #da8b55;">   by default, unless &#8216;</span><span style="color: #4e3163;">longest-substring</span><span style="color: #da8b55;">&#8217; is true, in which case yield /longest/</span>
<span style="color: #da8b55;">   such needle.</span>

<span style="color: #da8b55;">  Unless &#8216;</span><span style="color: #4e3163;">preserve-spaces</span><span style="color: #da8b55;">&#8217; is true, we convert all adjacent whitespace</span>
<span style="color: #da8b55;">  characters to a single space in the input &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217; and trim any surrounding</span>
<span style="color: #da8b55;">  whitespace from the resulting output needle string.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>longest-needle context first-ending result<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">unless</span> preserve-spaces <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> string <span style="color: #b1951d;">(</span>s-collapse-whitespace string<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> context <span style="color: #67b11d;">(</span>concat prefix <span style="color: #2d9574;">".*"</span> suffix<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> longest-needle <span style="color: #67b11d;">(</span>s-chop-prefix prefix
			   <span style="color: #b1951d;">(</span>s-chop-suffix suffix
			     <span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>s-match context string<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> first-ending <span style="color: #67b11d;">(</span>s-index-of suffix longest-needle<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> result <span style="color: #67b11d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">and</span> <span style="color: #3a81c3;">(</span>not longest-substring<span style="color: #3a81c3;">)</span> first-ending<span style="color: #b1951d;">)</span>
		       <span style="color: #b1951d;">(</span>substring longest-needle 0 <span style="color: #3a81c3;">(</span>1- first-ending<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
		       longest-needle<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">if</span> preserve-spaces result <span style="color: #67b11d;">(</span>s-trim result<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited-$ Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">substring-delimited-$</span>
    <span style="color: #6c3163;">(</span>context string <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> preserve-spaces longest-substring<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Assuming &#8216;</span><span style="color: #4e3163;">context</span><span style="color: #da8b55;">&#8217; = &#8220;&#10218;prefix&#10219; $here &#10218;suffix&#10219;&#8221;</span>
<span style="color: #da8b55;">   and &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #4e3163;">prefix</span><span style="color: #da8b55;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #4e3163;">suffix</span><span style="color: #da8b55;">&#8217;&#8943;, return the /first/ such needle</span>
<span style="color: #da8b55;">   by default, unless &#8216;</span><span style="color: #4e3163;">longest-substring</span><span style="color: #da8b55;">&#8217; is true, in which case yield /longest/</span>
<span style="color: #da8b55;">   such needle.</span>

<span style="color: #da8b55;">  Unless &#8216;</span><span style="color: #4e3163;">preserve-spaces</span><span style="color: #da8b55;">&#8217; is true, we convert all adjacent whitespace</span>
<span style="color: #da8b55;">  characters to a single space in the input &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #da8b55;">&#8217; and trim any surrounding</span>
<span style="color: #da8b55;">  whitespace from the resulting output needle string.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>pre-post <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">"$here"</span> context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span>substring-delimited <span style="color: #67b11d;">(</span>car pre-post<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>s-trim <span style="color: #b1951d;">(</span>cadr pre-post<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> string
     <span style="color: #3a81c3;">:preserve-spaces</span> preserve-spaces <span style="color: #3a81c3;">:longest-substring</span> longest-substring<span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Suppose a user provides us with an awkwardly spaced PackageFormer header,
our string manipulation setup is robust enough to get at the constituents:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>header <span style="color: #2d9574;">"PackageFormer  Semigroup   (  v : Variation) : Set (  &#8467;expr)   where"</span><span style="color: #6c3163;">]</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Three kinds of invocations; the last is my preferred choice &#9829;&#8255;&#9829;</span>
  `<span style="color: #6c3163;">(</span> ,<span style="color: #2d9574;">(</span>substring-delimited <span style="color: #2d9574;">"PackageFormer "</span> <span style="color: #2d9574;">"("</span> header <span style="color: #3a81c3;">:preserve-spaces</span> t <span style="color: #3a81c3;">:longest-substring</span> t<span style="color: #2d9574;">)</span>
     ,<span style="color: #2d9574;">(</span>substring-delimited <span style="color: #2d9574;">"PackageFormer "</span> <span style="color: #2d9574;">"("</span> header<span style="color: #2d9574;">)</span>
     ,<span style="color: #2d9574;">(</span>substring-delimited-$ <span style="color: #2d9574;">"PackageFormer $here ("</span> header<span style="color: #2d9574;">)</span>
   <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Semigroup   (  v : Variation) : Set</td>
<td class="org-left">Semigroup</td>
<td class="org-left">Semigroup</td>
</tr>
</tbody>
</table>

<p>
The aim is to eventually have an interface that interacts with an buffer containing Agda code.
To that end, we propose that our fictitious syntax be directly embedded into via special comments,
<code>{-700 ‚ãØ -}</code>, henceforth referred to as ‚Äú<a id="orgaeed2f3">700-comments</a>‚Äù.
</p>

<ul class="org-ul">
<li><code>(buffer-substring-delimited starting-regexp ending-regexp)</code> yields the <i>next</i> portion of the buffer
as a string, relative to the current position of the cursor, that is contained in the ‚Äòparenthesis‚Äô
<code>starting-regexp</code> and <code>ending-regexp</code>.</li>

<li><code>(buffer-substring-delimited-whole-buffer starting-regexp ending-regexp)</code> yields <i>all</i> portions of the buffer,
contained in the ‚Äòparenthesis‚Äô <code>starting-regexp</code> and <code>ending-regexp</code>, as a list of strings.

<ul class="org-ul">
<li>Cursor position is saved.</li>
<li>This function let's us obtain the contents of <i>all</i> <a href="#orgaeed2f3">700-comments</a>.</li>
</ul></li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">buffer-substring-delimited</span> <span style="color: #6c3163;">(</span>start end <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> <span style="color: #2d9574;">(</span>highlight nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"</span>
<span style="color: #da8b55;">  Get the current buffer's /next/ available substring that is delimited</span>
<span style="color: #da8b55;">  between the regexp tokens &#8216;</span><span style="color: #4e3163;">start</span><span style="color: #da8b55;">&#8217; up to &#8216;</span><span style="color: #4e3163;">end</span><span style="color: #da8b55;">&#8217;, exclusively.</span>

<span style="color: #da8b55;">  If no tokens are found, an error is thrown.</span>

<span style="color: #da8b55;">  The &#8216;</span><span style="color: #4e3163;">highlight</span><span style="color: #da8b55;">&#8217; option simply highlights the selected region ---visual feedback</span>
<span style="color: #da8b55;">  for the user.</span>
<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>p1 p2<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>re-search-forward start<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> p1 <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>re-search-forward end<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>backward-word<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> p2 <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> highlight <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">do we want to highlight the region?</span>
      <span style="color: #67b11d;">(</span>goto-char p1<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>push-mark p2<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> mark-active t<span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(copy-region-as-kill p1 p2)</span>
    <span style="color: #2d9574;">(</span>buffer-substring-no-properties p1 p2<span style="color: #2d9574;">)</span>
<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited-whole-buffer Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">buffer-substring-delimited-whole-buffer</span> <span style="color: #6c3163;">(</span>start end<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Return a list of all substrings in the current buffer that</span>
<span style="color: #da8b55;">   are delimited by regexp tokens &#8216;</span><span style="color: #4e3163;">start</span><span style="color: #da8b55;">&#8217; and &#8216;</span><span style="color: #4e3163;">end</span><span style="color: #da8b55;">&#8217;, exclusively.</span>
<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">save-excursion</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>l nil<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>continue t<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>beginning-of-buffer<span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">while</span> continue
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">condition-case</span> nil
	 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">attemptClause</span>
	 <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> l <span style="color: #6c3163;">(</span>cons <span style="color: #2d9574;">(</span>buffer-substring-delimited start end<span style="color: #2d9574;">)</span> l<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
	 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">recoveryBody</span>
	 <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> continue nil<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We've collected items as we saw them, so &#8216;l&#8217; is in reverse.</span>
    <span style="color: #67b11d;">(</span>reverse l<span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Here are some possible invocations, the last one being our use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by quotes</span>
<span style="color: #3a81c3;">(</span>buffer-substring-delimited <span style="color: #2d9574;">"^\""</span> <span style="color: #2d9574;">"^\""</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by quotes</span>
<span style="color: #3a81c3;">(</span>buffer-substring-delimited <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Execute the following in an Agda buffer to see this function in action.</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> it <span style="color: #6c3163;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
So much string meddling, hopefully no more üôà :hear<sub>no</sub><sub>evil</sub>: :speak<sub>no</sub><sub>evil</sub>:
</p>
</div>
</div>

<div id="outline-container-orgf95b0d4" class="outline-2">
<h2 id="orgf95b0d4"><span class="section-number-2">5</span> <span class="done DONE">DONE</span> The <code>package-former</code> Datatype</h2>
<div class="outline-text-2" id="text-5">
<p>
For this prototype's <a href="#orga797d87">constraints</a>, a PackageFormer will generally declared as
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> &#8467; <span style="color: #cd6600;">where</span>
   <span style="color: #cd6600;">field</span>
     &#8942;
</pre>
</div>

<p>
The body, <code>‚ãÆ</code>, of such a declaration mentions <code>Semigroup v</code>, which we would like to rewrite
with other names when the package is instantiated. Likewise, we also want to erase or rewrite
the sole parameter, and possibly increment the level. Let's form a type to work with these components
rather than meddle with strings all the time.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">package-formers</span> nil
  <span style="color: #da8b55;">"The list of PackageFormer schema declarations in the current Agda buffer."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defstruct</span> package-former
  <span style="color: #da8b55;">"Record of components that form a PackageFormer.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">docstring</span><span style="color: #da8b55;">&#8217;: Relevant documentation about this structure; e.g.,</span>
<span style="color: #da8b55;">      what is the instance declaration that generated this type, if any.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">type</span><span style="color: #da8b55;">&#8217;: PackageFormer, record, data, module, etc.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">name</span><span style="color: #da8b55;">&#8217;: The name of the grouping mechnaism schema.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">params</span><span style="color: #da8b55;">&#8217;: The list of parameters we may have.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">level</span><span style="color: #da8b55;">&#8217;: The universe level that the instantiations will inhabit.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">carrier</span><span style="color: #da8b55;">&#8217;: The carrier of an ADT is the ADT, the carrier of a record is the record,</span>
<span style="color: #da8b55;">                the carrier of a typeclass is a specfied set, say &#8220;Carrier : Set &#8467;&#8221;.</span>

<span style="color: #da8b55;">   - Finally, the children fields are the typed-names that constitute the body of the</span>
<span style="color: #da8b55;">     grouping mechanism. As long as consistent indentation is selected, it does not matter how much.</span>
<span style="color: #da8b55;">     As such, we keep track of these indentation numerics ourselves in case we need to tweak them.</span>
<span style="color: #da8b55;">  "</span>
  docstring
  type
  name
  params
  level
  carrier
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">children</span>
  field-header-indentation
  fields-indentation
  fields
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
It will get rather redundant to write <code>(package-former-X p)</code> to project the constituents of a PackageFormer <code>p</code>. As such, let's introduce
a useful macro to ‚Äúopen p‚Äù locally.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">An anaphoric macro ^_^</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">open-pf</span> <span style="color: #6c3163;">(</span>p <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #6c3163;">)</span>
  `<span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span>
    <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>docstring                <span style="color: #b1951d;">(</span>package-former-docstring ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>type                     <span style="color: #b1951d;">(</span>package-former-type ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>name                     <span style="color: #b1951d;">(</span>package-former-name ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>params                   <span style="color: #b1951d;">(</span>package-former-params ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>level                    <span style="color: #b1951d;">(</span>package-former-level ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>carrier                  <span style="color: #b1951d;">(</span>package-former-carrier ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>field-header-indentation <span style="color: #b1951d;">(</span>package-former-field-header-indentation ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>fields-indentation       <span style="color: #b1951d;">(</span>package-former-fields-indentation ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>fields                   <span style="color: #b1951d;">(</span>package-former-fields ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    ,@body
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Finally, it seems we need support for typed names &#x2014;pairs <code>‚Äúname : type‚Äù</code>.
We could use <code>car</code> and <code>cdr</code> on pairs, but let's use named projections instead
so we don't have this extra mental strain and implicit type-checking to ensure.
</p>
</div>

<div id="outline-container-org6340bc8" class="outline-3">
<h3 id="org6340bc8"><span class="section-number-3">5.1</span> Typed Names</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defstruct</span> tn
  <span style="color: #da8b55;">"Representation of typed-names, pairs &#8220;name : type&#8221;,</span>
<span style="color: #da8b55;">   for use in a context as in a parameter list</span>
<span style="color: #da8b55;">   or in a list of fields of a record-like type."</span>
  name
  type
  <span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">show-tn</span> <span style="color: #6c3163;">(</span>tn<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Pretty print a typed-name record value"</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> tn <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">"(%s : %s)"</span> <span style="color: #67b11d;">(</span>tn-name tn<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>tn-type tn<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here's a basic test:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>show-tn <span style="color: #6c3163;">(</span>make-tn <span style="color: #3a81c3;">:name</span> <span style="color: #2d9574;">"this"</span> <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"that"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">(this : that)</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org83b39e9" class="outline-3">
<h3 id="org83b39e9"><span class="section-number-3">5.2</span> Package Former Parsing and Pretty Printing</h3>
<div class="outline-text-3" id="text-5-2">
<p>
With this in hand, let's produce a robust parser.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">parse-package-former</span> <span style="color: #6c3163;">(</span>lines<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"The input &#8216;</span><span style="color: #4e3163;">lines</span><span style="color: #da8b55;">&#8217; must be a list of lines forming a full PackageFormer declaration;</span>
<span style="color: #da8b55;">   e.g., obtained by calling &#8216;</span><span style="color: #4e3163;">get-children</span><span style="color: #da8b55;">&#8217;.</span>

<span style="color: #da8b55;">   It is parsed and a &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217; value is returned.</span>
<span style="color: #da8b55;">   Whitespace is stripped off of items.</span>

<span style="color: #da8b55;">   Docstrings are ignored.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Precondition Example, with intentionally strange whitespacing:</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">header &#8776; &#8220;PackageFormer Semigroup   (v : Variation) : Set  ( &#8467;expr)   where&#8221;</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>header <span style="color: #b1951d;">(</span>car lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>vs <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"($here : Variation"</span> header<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>make-package-former
     <span style="color: #3a81c3;">:type</span>                     <span style="color: #2d9574;">"PackageFormer"</span>
     <span style="color: #3a81c3;">:carrier</span>                  <span style="color: #67b11d;">(</span>concat <span style="color: #2d9574;">"PackageFormer "</span> vs<span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:name</span>                     <span style="color: #67b11d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"PackageFormer $here ("</span> header<span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:params</span>                   `<span style="color: #67b11d;">(</span>,<span style="color: #b1951d;">(</span>make-tn <span style="color: #3a81c3;">:name</span> vs <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"Variation"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">level</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; may be &#8220;&#8221;, that's okay.</span>
     <span style="color: #3a81c3;">:level</span>                    <span style="color: #67b11d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"Set $here where"</span> header<span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:field-header-indentation</span> <span style="color: #67b11d;">(</span>get-indentation <span style="color: #b1951d;">(</span>cadr lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:fields-indentation</span>       <span style="color: #67b11d;">(</span>get-indentation <span style="color: #b1951d;">(</span>caddr lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #3a81c3;">:fields</span>                   <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #b1951d;">(</span>s-trim it<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>cddr lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's try this out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>parse-package-former <span style="color: #6c3163;">(</span>car <span style="color: #2d9574;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">#s(package-former nil PackageFormer Semigroup (#s(tn v Variation))  PackageFormer v 2 4 (<span class="underline">‚®æ</span> : Semigroup v ‚Üí Semigroup v ‚Üí Semigroup v Id  : Semigroup v assoc : ‚àÄ {x y z} ‚Üí (x ‚®æ y) ‚®æ z ‚â° x ‚®æ (y ‚®æ z)))</td>
</tr>
</tbody>
</table>

<p>
Conversely, let's have a pretty printer.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">show-package-former</span> <span style="color: #6c3163;">(</span>p <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> carrier omit-field-decl omit-docstring<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"Pretty print a package-former record value"</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">open-pf</span> p <span style="color: #2d9574;">(</span>concat

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0. The docuemntation string</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">unless</span> omit-docstring <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"\n{- %s -}\n"</span> docstring<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">1. The schema declaration</span>
     <span style="color: #67b11d;">(</span>s-collapse-whitespace <span style="color: #b1951d;">(</span>s-join <span style="color: #2d9574;">" "</span>
	<span style="color: #3a81c3;">(</span>list type name <span style="color: #6c3163;">(</span>s-join <span style="color: #2d9574;">" "</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #887070;">(</span>show-tn it<span style="color: #887070;">)</span> params<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
	      <span style="color: #2d9574;">": Set"</span> level <span style="color: #2d9574;">"where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2. The field keyword</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">unless</span> omit-field-decl
       <span style="color: #b1951d;">(</span>concat <span style="color: #2d9574;">"\n"</span> <span style="color: #3a81c3;">(</span>s-repeat field-header-indentation <span style="color: #2d9574;">" "</span><span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">"field\n"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3. The fields</span>
      <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">"\n"</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>concat <span style="color: #6c3163;">(</span>s-repeat fields-indentation <span style="color: #2d9574;">" "</span><span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span> fields<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>pf <span style="color: #2d9574;">(</span>car <span style="color: #67b11d;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span>
   <span style="color: #6c3163;">(</span>show-package-former <span style="color: #2d9574;">(</span>parse-package-former pf<span style="color: #2d9574;">)</span> <span style="color: #3a81c3;">:omit-docstring</span> t<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Semigroup</span> <span style="color: #0000cd;">v</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
The call to <code>s-collapse-whitespace</code> permits us to phrase an approximation of the opinion
that parsing and showing should be inverses.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>pf <span style="color: #2d9574;">(</span>car <span style="color: #67b11d;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span>
  <span style="color: #6c3163;">(</span>equal <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">"\n"</span> pf<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>show-package-former <span style="color: #67b11d;">(</span>parse-package-former pf<span style="color: #67b11d;">)</span> <span style="color: #3a81c3;">:omit-docstring</span> t<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<div class="org-center">
<p>
( <i>In Lisp, <code>t</code> denotes ‚Äútrue‚Äù!</i> )
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orge6af346" class="outline-2">
<h2 id="orge6af346"><span class="section-number-2">6</span> Parsing an Agda Buffer</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org50bca1f" class="outline-3">
<h3 id="org50bca1f"><span class="section-number-3">6.1</span> instantiations-remaining list</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">instantiations-remaining</span> nil
  <span style="color: #da8b55;">"The PackageFormer instantiations that need to be performed."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defstruct</span> instance-declaration
  <span style="color: #da8b55;">"Record of componenets for an PackageFormer instance declaration:</span>
<span style="color: #da8b55;">   &#10218;name&#10219; = &#10218;package-former&#10219; &#10218;variation&#10219; &#10218;renames&#10219;,</span>
<span style="color: #da8b55;">   &#10218;renames&#10219; = &#949; | renaming (&#945; to &#945;&#8242; ; &#8230; ; &#969; to &#969;&#8242;).</span>
<span style="color: #da8b55;">  "</span>
  name package-former variation renames
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">load-instance-declaration</span> <span style="color: #6c3163;">(</span>line<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">"If the current &#8216;</span><span style="color: #4e3163;">line</span><span style="color: #da8b55;">&#8217; string is an instance declaration,</span>
<span style="color: #da8b55;">   then parse and add it to the list of &#8216;</span><span style="color: #4e3163;">instantiations-remaining</span><span style="color: #da8b55;">&#8217;;</span>
<span style="color: #da8b55;">   else do nothing.</span>

<span style="color: #da8b55;">   Returns the instance-declaration that was loaded, otherwise nil.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Example instance declaration:</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;MagmaR = Magma record renaming (Carrier to C; _&#10814;_ to _&#8728;_)&#8221;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8658; &#8805;4 pieces, sepearted by spaces, where second item must be an equality.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Note: (cddddr nil) &#8776; nil</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span>inst <span style="color: #67b11d;">(</span>pieces <span style="color: #b1951d;">(</span>s-split <span style="color: #2d9574;">" "</span> line<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>renames <span style="color: #b1951d;">(</span>cddddr pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
   <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> <span style="color: #67b11d;">(</span><span style="color: #cd6600;">and</span> <span style="color: #b1951d;">(</span>&lt;= 4 <span style="color: #3a81c3;">(</span>length pieces<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>equal <span style="color: #3a81c3;">(</span>nth 1 pieces<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">"="</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">when</span> renames

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick them back together</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> renames <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">" "</span> renames<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Discard identifying tokens</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> renames <span style="color: #3a81c3;">(</span>substring-delimited-$ <span style="color: #2d9574;">"renaming ($here)"</span> renames<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Split along semicolons, then turn into pairs.</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> renames <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #6c3163;">(</span>s-split <span style="color: #2d9574;">"to"</span> it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>s-split <span style="color: #2d9574;">";"</span> renames<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> inst <span style="color: #b1951d;">(</span>make-instance-declaration
		 <span style="color: #3a81c3;">:name</span>           <span style="color: #3a81c3;">(</span>nth 0 pieces<span style="color: #3a81c3;">)</span>
		 <span style="color: #3a81c3;">:package-former</span> <span style="color: #3a81c3;">(</span>nth 2 pieces<span style="color: #3a81c3;">)</span>
		 <span style="color: #3a81c3;">:variation</span>      <span style="color: #3a81c3;">(</span>nth 3 pieces<span style="color: #3a81c3;">)</span>
		 <span style="color: #3a81c3;">:renames</span>        renames<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span>add-to-list 'instantiations-remaining inst<span style="color: #67b11d;">)</span>
   <span style="color: #2d9574;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return value.</span>
   inst
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Test:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>load-instance-declaration
  <span style="color: #2d9574;">"MagmaR = Magma record renaming (Carrier to C; _&#10814;_ to _&#8728;_)"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<pre class="example">
#s(instance-declaration "MagmaR" "Magma" "record" (("Carrier " " C") (" _‚®æ_ " " _‚àò_")))
</pre>
</div>
</div>

<div id="outline-container-org9fb4831" class="outline-3">
<h3 id="org9fb4831"><span class="section-number-3">6.2</span> parse-<a href="#orgaeed2f3">700-comments</a></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">700-comments</span> nil
  <span style="color: #da8b55;">"The contents of the 700-comments.</span>

<span style="color: #da8b55;">   If this variable does not change, we short-circut all processing.</span>
<span style="color: #da8b55;">  "</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">parse-700-comments</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55;">"</span>
<span style="color: #da8b55;">   Parse comments of the form &#8220;{-700 &#8943; -}&#8221; and add all PackageFormer declarations</span>
<span style="color: #da8b55;">   to the &#8216;</span><span style="color: #4e3163;">package-formers</span><span style="color: #da8b55;">&#8217; list and all instantations to the &#8216;</span><span style="color: #4e3163;">instantiations-remaining</span><span style="color: #da8b55;">&#8217; list.</span>
<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">for testing</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(setq instantiations-remaining nil)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(setq package-formers nil)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For now, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">item</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is either a PackageFormer or instantiation declaration.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>item lines<span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Step 0: Catenate all 700-comments into a single string.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> 700-comments <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">"\n"</span> <span style="color: #b1951d;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">View comments as a sequence of lines, ignore empty lines ---which are not in our grammar.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--remove</span> <span style="color: #b1951d;">(</span>s-blank? <span style="color: #3a81c3;">(</span>s-collapse-whitespace it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>s-lines 700-comments<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Traverse the 700-comments:</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If we view a &#8220;lhs = rhs&#8221; equation, add to global &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">instantiations-remaining</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; list.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If we view a PackageFormer declaration, add to global &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">package-formers</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; list.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">while</span> lines
   <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> item <span style="color: #b1951d;">(</span>car lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
   <span style="color: #67b11d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #b1951d;">(</span>load-instance-declaration item<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #3a81c3;">(</span>cdr lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Else we have a PackageFormer declaration:</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get it along with the remaining 700-comments.</span>
     <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> item <span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">load package former</span>
     <span style="color: #b1951d;">(</span>add-to-list 'package-formers <span style="color: #3a81c3;">(</span>parse-package-former <span style="color: #6c3163;">(</span>car item<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
     <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #3a81c3;">(</span>cdr item<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2d9574;">(</span>message <span style="color: #2d9574;">"Finished parsing 700-comments."</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(global-set-key (kbd "&lt;f7&gt;") 'parse-700-comments)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd89ab1e" class="outline-2">
<h2 id="orgd89ab1e"><span class="section-number-2">7</span> <code>instantiate</code> &#x2014;the core utility</h2>
<div class="outline-text-2" id="text-7">
<p>
Let's put the pieces together.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">instantiate</span> <span style="color: #6c3163;">(</span>decls <span style="color: #ba2f59; font-weight: bold;">&amp;key</span>
  new-name <span style="color: #2d9574;">(</span>type <span style="color: #2d9574;">"record"</span><span style="color: #2d9574;">)</span> carrier
  name-suffix
  param-replacement
  prefix-fields suffix-fields omit-field-header
  <span style="color: #2d9574;">(</span>keep-fields <span style="color: #67b11d;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #b1951d;">(</span>x<span style="color: #b1951d;">)</span> t<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>alter-raw-fields #'identity<span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>alter-fields #'identity<span style="color: #2d9574;">)</span>
  docstring
  <span style="color: #6c3163;">)</span>

  <span style="color: #da8b55;">"Given a PackageFormer declaration, instantiate it into a concrete Agda type.</span>

<span style="color: #da8b55;">   Remarks or example values:</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">decls</span><span style="color: #da8b55;">&#8217; is immediately provided to &#8216;</span><span style="color: #4e3163;">get-children</span><span style="color: #da8b55;">&#8217;, so it may be a string,</span>
<span style="color: #da8b55;">      a list, or a value of type &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217;.</span>
<span style="color: #da8b55;">      NOTE: If you do pass in a &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217;, we will not alter yours;</span>
<span style="color: #da8b55;">      we will copy it and work with the local copy.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">type</span><span style="color: #da8b55;">&#8217;: The replacement for &#8220;PackageFormer&#8221;; default is &#8220;record&#8221;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">carrier</span><span style="color: #da8b55;">&#8217;: What is the carrier of this new instance? E.g., &#8220;Carrier&#8221;.</span>
<span style="color: #da8b55;">      By default it's the &#8216;</span><span style="color: #4e3163;">new-name</span><span style="color: #da8b55;">&#8217;; but this is unresonable when, say, a typeclass</span>
<span style="color: #da8b55;">      variation is requested.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">name-suffix</span><span style="color: #da8b55;">&#8217;: When no &#8216;</span><span style="color: #4e3163;">new-name</span><span style="color: #da8b55;">&#8217; is provided, the default is</span>
<span style="color: #da8b55;">      &#8220;&#10218;PackageFormer'sName&#10219;-&#10218;variation&#10219;-g*&#8221;, where &#8216;*&#8217; is an arbitrarily generated number.</span>

<span style="color: #da8b55;">     This may be useful for rapid development when one does not want to provide</span>
<span style="color: #da8b55;">     a name to an instance, but simply wants the instance to exist.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">param-replacement</span><span style="color: #da8b55;">&#8217;: '(&#8220;Carrier&#8221; . &#8220;Set&#8221;); empty string by default.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">prefix-fields</span><span style="color: #da8b55;">&#8217;: List of fields, &#8220;name : type&#8221;, to be added at the beginning</span>
<span style="color: #da8b55;">      of the field declaration. Default is empty string.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">suffix-fields</span><span style="color: #da8b55;">&#8217;: List of fields, &#8220;name : type&#8221;, to be added at the beginning</span>
<span style="color: #da8b55;">      of the field declaration. Default is empty string.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">omit-field-header</span><span style="color: #da8b55;">&#8217;: Should the &#8220;field&#8221; word be removed? No by default.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">keep-fields</span><span style="color: #da8b55;">&#8217;: Predicate that determines which fields should be kept.</span>
<span style="color: #da8b55;">      By default, no fields are dropped.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">alter-raw-fields</span><span style="color: #da8b55;">&#8217;: A function that alters the list of fields of a PackageFormer *before*</span>
<span style="color: #da8b55;">     any processing has transpiried. This is the identity function by default.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">alter-fields</span><span style="color: #da8b55;">&#8217;: A function to alter existing fields *after* processing;</span>
<span style="color: #da8b55;">     it does not alter inserted fields via &#8216;</span><span style="color: #4e3163;">prefix-fields</span><span style="color: #da8b55;">&#8217; nor &#8216;</span><span style="color: #4e3163;">suffix-fields</span><span style="color: #da8b55;">&#8217;.</span>
<span style="color: #da8b55;">     This is the identity function by default.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">docstring</span><span style="color: #da8b55;">&#8217;: What is the parent PackageFormer, or instance declaration, of</span>
<span style="color: #da8b55;">     the currently intantiated data-type.</span>
<span style="color: #da8b55;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pf <span style="color: #b1951d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #3a81c3;">(</span>package-former-p decls<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>copy-package-former decls<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>parse-package-former <span style="color: #6c3163;">(</span>car <span style="color: #2d9574;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> decls<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>pf-name <span style="color: #b1951d;">(</span>package-former-name pf<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>pfv <span style="color: #b1951d;">(</span>concat pf-name <span style="color: #2d9574;">" "</span> <span style="color: #3a81c3;">(</span>typedname-name <span style="color: #6c3163;">(</span>package-former-param pf<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>fields     <span style="color: #b1951d;">(</span>funcall alter-raw-fields <span style="color: #3a81c3;">(</span>package-former-fields pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-1. Source generation declaration.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-docstring pf<span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #cd6600;">or</span> docstring
	<span style="color: #b1951d;">(</span>concat <span style="color: #2d9574;">"This was generated from the PackageFormer "</span> pf-name<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0. Replace "PackageFormer" with &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">type</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-type pf<span style="color: #67b11d;">)</span> type<span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">1. Replace "(? : Variation)" with the provided &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">variation-replacement</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-param pf<span style="color: #67b11d;">)</span> param-replacement<span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2. Replace all occurences of &#8220;package-former-name followed by variation&#8221;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">with &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">carrier</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;, if any.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Default value of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">new-name</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; &amp; &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">carrier</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; are &#10218;PackageFormer'sName&#10219;-&#10218;name-suffix&#10219;.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">unless</span> new-name <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> new-name <span style="color: #b1951d;">(</span>concat <span style="color: #3a81c3;">(</span>package-former-name pf<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">"-"</span> name-suffix<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">unless</span> carrier  <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> carrier new-name<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-fields pf<span style="color: #67b11d;">)</span>
	  <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #b1951d;">(</span>s-replace pfv carrier it<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>package-former-fields pf<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3. Replace PackageFormer's name with provided instantiation name.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-name pf<span style="color: #67b11d;">)</span> new-name<span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">4. Insert new fields and process the altered existing fields.</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-fields pf<span style="color: #67b11d;">)</span>
	<span style="color: #67b11d;">(</span>-concat
	     prefix-fields
	       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Perform any processing on the fields.</span>
	       <span style="color: #b1951d;">(</span>funcall alter-fields <span style="color: #3a81c3;">(</span>-filter keep-fields <span style="color: #6c3163;">(</span>package-former-fields pf<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
	     suffix-fields
	   <span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">5. Stringify!</span>
  <span style="color: #2d9574;">(</span>show-pf pf <span style="color: #3a81c3;">:omit-field-decl</span> omit-field-header<span style="color: #2d9574;">)</span>

 <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">specialise</span> <span style="color: #6c3163;">(</span>instance<span style="color: #6c3163;">)</span>
 <span style="color: #da8b55;">"Input is an instantiation declaration, output is a pacakge former value."</span>

 <span style="color: #6c3163;">(</span>make-package-former<span style="color: #6c3163;">)</span>

<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>load-instance-declaration
  <span style="color: #2d9574;">"MagmaR = Magma record renaming (Carrier to C; _&#10814;_ to _&#8728;_)"</span><span style="color: #3a81c3;">)</span>
</pre>
</div>


<p>
Let's instantiate our test example from earlier to produce a typeclass.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>instantiate _test   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:new-name "SemigroupT"</span>
		    <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"typeclass"</span>
		    <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"record"</span>
		    <span style="color: #3a81c3;">:param-replacement</span> <span style="color: #6c3163;">(</span>make-typedname <span style="color: #3a81c3;">:name</span> <span style="color: #2d9574;">"Carrier"</span> <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"Set"</span><span style="color: #6c3163;">)</span>
		    <span style="color: #3a81c3;">:carrier</span> <span style="color: #2d9574;">"Carrier"</span>
		      <span style="color: #3a81c3;">:docstring</span> <span style="color: #2d9574;">"This is a test"</span>
		    <span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This is a test </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> Semigroup-<span style="color: #cd6600;">typeclass</span><span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>



<p>
What about a bundled up record declaration?
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>instantiate test   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:new-name "SemigroupT"</span>
		    <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"semantics"</span>
		    <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"record"</span>
		    <span style="color: #3a81c3;">:carrier</span> <span style="color: #2d9574;">"Carrier"</span>
		    <span style="color: #3a81c3;">:prefix-fields</span> '<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"Carrier : Set"</span><span style="color: #6c3163;">)</span>
		    <span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This was generated from the PackageFormer Semigroup </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-semantics</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
Records provide a semantics, what if we want the syntax?
Since <code>data</code> declarations consist of constructors, whose target type necessarily
begins with the name of the <code>data</code>-type being defined, let's only keep those fields and drop the rest.
</p>

<p>
First, a helper function.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">field-target</span> <span style="color: #6c3163;">(</span>field<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55;">" Given a declaration &#8220;name : type0 &#8594; &#8943; &#8594; typeN&#8221;, yield &#8220;typeN&#8221;. "</span>
  <span style="color: #6c3163;">(</span>car <span style="color: #2d9574;">(</span>-take-last 1 <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">"&#8594;"</span> field<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's test it out:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>pf-name <span style="color: #2d9574;">"Semigroup-syntax"</span><span style="color: #6c3163;">]</span>

  <span style="color: #6c3163;">(</span>list <span style="color: #2d9574;">(</span>s-contains? pf-name <span style="color: #67b11d;">(</span>field-target <span style="color: #2d9574;">"Id    :  Semigroup-syntax"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
	<span style="color: #2d9574;">(</span>s-contains? pf-name <span style="color: #67b11d;">(</span>field-target <span style="color: #2d9574;">"_&#10814;_   :  Semigroup-syntax &#8594; Semigroup-syntax &#8594; Semigroup-syntax"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
	<span style="color: #2d9574;">(</span>s-contains? pf-name <span style="color: #67b11d;">(</span>field-target <span style="color: #2d9574;">"assoc :  &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
<td class="org-left">t</td>
<td class="org-left">nil</td>
</tr>
</tbody>
</table>

<p>
The results are as expected, so let's move to the real use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>pf-name <span style="color: #2d9574;">"Semigroup-syntax"</span><span style="color: #6c3163;">]</span>

  <span style="color: #6c3163;">(</span>instantiate test  <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"syntax"</span>
		     <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"data"</span>
		     <span style="color: #3a81c3;">:omit-field-header</span> t
		     <span style="color: #3a81c3;">:new-name</span> pf-name
		     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:carrier pf-name</span>
		     <span style="color: #3a81c3;">:keep-fields</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #67b11d;">(</span>f<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>s-contains? pf-name <span style="color: #b1951d;">(</span>field-target f<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
		    <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This was generated from the PackageFormer Semigroup </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">data</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> : <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span> &#8594; <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span> &#8594; <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  : <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>
</pre>
</div>

<p>
Yeehaw! We've got three variations and possibly much more from a single fancy well-toggled
function ü§† We can emulate generative modules this way too! üòª
</p>

<p>
Let's package these particular toggle configurations into their own functions.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">instantiate-as-typeclass</span> <span style="color: #6c3163;">(</span>decls <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> new-name <span style="color: #2d9574;">(</span>carrier <span style="color: #2d9574;">"Carrier"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #da8b55;">"Given a PackageFormer declaration, instantiate it into a concrete Agda &#8220;typeclass&#8221;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">decls</span><span style="color: #da8b55;">&#8217; is immediately provided to &#8216;</span><span style="color: #4e3163;">get-children</span><span style="color: #da8b55;">&#8217;, so it may be a string,</span>
<span style="color: #da8b55;">      a list, or a value of type &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">new-name</span><span style="color: #da8b55;">&#8217; is the name of the resulting instance.</span>
<span style="color: #da8b55;">     Default is &#8220;&#10218;PackageFormer'sName&#10219;-record-g*&#8221; for a random sequence of digits &#8216;*&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">carrier</span><span style="color: #da8b55;">&#8217;: What is the carrier of this new instance? Default is &#8220;Carrier&#8221;.</span>

<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span>instantiate decls <span style="color: #3a81c3;">:new-name</span> new-name
		     <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"typeclass"</span>
		     <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"record"</span>
		       <span style="color: #3a81c3;">:param-replacement</span> <span style="color: #2d9574;">(</span>make-typedname <span style="color: #3a81c3;">:name</span> carrier <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"Set"</span><span style="color: #2d9574;">)</span>
		     <span style="color: #3a81c3;">:carrier</span> carrier
		    <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">instantiate-as-record</span> <span style="color: #6c3163;">(</span>decls <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> new-name <span style="color: #2d9574;">(</span>carrier <span style="color: #2d9574;">"Carrier"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #da8b55;">"Given a PackageFormer declaration, instantiate it into a concrete Agda record.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">decls</span><span style="color: #da8b55;">&#8217; is immediately provided to &#8216;</span><span style="color: #4e3163;">get-children</span><span style="color: #da8b55;">&#8217;, so it may be a string,</span>
<span style="color: #da8b55;">      a list, or a value of type &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">new-name</span><span style="color: #da8b55;">&#8217; is the name of the resulting instance.</span>
<span style="color: #da8b55;">     Default is &#8220;&#10218;PackageFormer'sName&#10219;-record-g*&#8221; for a random sequence of digits &#8216;*&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">carrier</span><span style="color: #da8b55;">&#8217;: What is the carrier of this new instance? Default is &#8220;Carrier&#8221;.</span>

<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span>instantiate decls <span style="color: #3a81c3;">:new-name</span> new-name
		    <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"semantics"</span>
		    <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"record"</span>
		    <span style="color: #3a81c3;">:carrier</span> carrier
		    <span style="color: #3a81c3;">:prefix-fields</span> `<span style="color: #2d9574;">(</span>,<span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"%s : Set"</span> carrier<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
		    <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">instantiate-as-data</span> <span style="color: #6c3163;">(</span>decls <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> new-name <span style="color: #2d9574;">(</span>carrier <span style="color: #2d9574;">"Carrier"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #da8b55;">"Given a PackageFormer declaration, instantiate it into a concrete Agda record.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">decls</span><span style="color: #da8b55;">&#8217; is immediately provided to &#8216;</span><span style="color: #4e3163;">get-children</span><span style="color: #da8b55;">&#8217;, so it may be a string,</span>
<span style="color: #da8b55;">      a list, or a value of type &#8216;</span><span style="color: #4e3163;">package-former</span><span style="color: #da8b55;">&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">new-name</span><span style="color: #da8b55;">&#8217; is the name of the resulting instance.</span>
<span style="color: #da8b55;">     Default is &#8220;&#10218;PackageFormer'sName&#10219;-record-g*&#8221; for a random sequence of digits &#8216;*&#8217;.</span>

<span style="color: #da8b55;">   - &#8216;</span><span style="color: #4e3163;">carrier</span><span style="color: #da8b55;">&#8217;: What is the carrier of this new instance? Default is &#8220;Carrier&#8221;.</span>

<span style="color: #da8b55;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pf <span style="color: #b1951d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #3a81c3;">(</span>package-former-p decls<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>copy-package-former decls<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>parse-package-former <span style="color: #6c3163;">(</span>car <span style="color: #2d9574;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> decls<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
	 <span style="color: #67b11d;">(</span>pf-name <span style="color: #b1951d;">(</span>package-former-name pf<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>instantiate decls  <span style="color: #3a81c3;">:new-name</span> new-name
		       <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"syntax"</span>
		       <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"data"</span>
		       <span style="color: #3a81c3;">:omit-field-header</span> t
		       <span style="color: #3a81c3;">:keep-fields</span> <span style="color: #67b11d;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #b1951d;">(</span>f<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>s-contains? pf-name <span style="color: #3a81c3;">(</span>field-target f<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
		      <span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
That's a lot of mumbo jumbo, let's have a sanity check.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">"\n"</span> `<span style="color: #6c3163;">(</span>
,<span style="color: #2d9574;">(</span>instantiate-as-typeclass test<span style="color: #2d9574;">)</span>
,<span style="color: #2d9574;">(</span>instantiate-as-record test<span style="color: #2d9574;">)</span>
,<span style="color: #2d9574;">(</span>instantiate-as-data test<span style="color: #2d9574;">)</span>
<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(instantiate-as-typeclass (cadr package-formers) :new-name "hello")</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This was generated from the PackageFormer Semigroup </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> Semigroup-<span style="color: #cd6600;">typeclass</span><span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This was generated from the PackageFormer Semigroup </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-semantics</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This was generated from the PackageFormer Semigroup </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">data</span> <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> : <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span> &#8594; <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span> &#8594; <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>  : <span style="color: #ba2f59; font-weight: bold;">Semigroup-syntax</span>
</pre>
</div>

<p>
Notice that the results contained generated names since no names were provided.
</p>

<p>
Woah, look at that: This' reminiscent of that <a href="#org39a139b">200% increase</a> from earlier ;-)
</p>
</div>
</div>

<div id="outline-container-org072bcef" class="outline-2">
<h2 id="org072bcef"><span class="section-number-2">8</span> Instantiate all items in ‚Äòinstantiations-remaining‚Äô</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">reify-instances</span> <span style="color: #6c3163;">()</span>
 <span style="color: #da8b55;">"Instantiate all items in &#8216;</span><span style="color: #4e3163;">instantiations-remaining</span><span style="color: #da8b55;">&#8217;."</span>

 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span>result name pf-type pf pfs variation reify<span style="color: #2d9574;">)</span>

   <span style="color: #2d9574;">(</span><span style="color: #cd6600;">dolist</span> <span style="color: #67b11d;">(</span>inst instantiations-remaining<span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get pieces of the instance declaration.</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> name <span style="color: #b1951d;">(</span>instance-declaration-name inst<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> variation <span style="color: #b1951d;">(</span>instance-declaration-variation inst<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> pf-type <span style="color: #b1951d;">(</span>instance-declaration-package-former inst<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get the package-former that is being instantiated.</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> pfs <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--filter</span> <span style="color: #3a81c3;">(</span>equal pf-type <span style="color: #6c3163;">(</span>package-former-name it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> package-formers<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Perform the instantiation.</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> reify
	   <span style="color: #b1951d;">(</span><span style="color: #cd6600;">cond</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>not pfs<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"%s = {! No PackageFormer &#8216;</span><span style="color: #4e3163;">%s</span><span style="color: #2d9574;">&#8217; declared. !}"</span> name pf-type<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
		 <span style="color: #3a81c3;">(</span>t <span style="color: #6c3163;">(</span><span style="color: #cd6600;">pcase</span> <span style="color: #2d9574;">(</span>instance-declaration-variation inst<span style="color: #2d9574;">)</span>
		      <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"typeclass"</span> <span style="color: #887070;">(</span>instantiate-as-typeclass <span style="color: #3a81c3;">(</span>car pfs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:new-name</span> name<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
		      <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"record"</span>    <span style="color: #887070;">(</span>instantiate-as-record <span style="color: #3a81c3;">(</span>car pfs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:new-name</span> name<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
		      <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"data"</span>      <span style="color: #887070;">(</span>instantiate-as-data <span style="color: #3a81c3;">(</span>car pfs<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:new-name</span> name<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
		      <span style="color: #2d9574;">(</span>v  <span style="color: #887070;">(</span>format <span style="color: #2d9574;">"%s = {! Variation %s not yet supported!}"</span> name v<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Add to list of results.</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> result <span style="color: #b1951d;">(</span>-cons* reify result<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
<span style="color: #2d9574;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Output results as a string.</span>
   <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">"\n"</span> result<span style="color: #2d9574;">)</span>
<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>global-set-key <span style="color: #6c3163;">(</span>kbd <span style="color: #2d9574;">"&lt;f7&gt;"</span><span style="color: #6c3163;">)</span> 'reify-instances<span style="color: #3a81c3;">)</span>

	<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Perform the instantiation.</span>
	<span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(setq reify (pcase (instance-declaration-variation inst)</span>


		      <span style="color: #2aa1ae; background-color: #ecf3ec;">;</span><span style="color: #2aa1ae; background-color: #ecf3ec;">("record" (instantiate-as-record (show pf) :new-name name))</span>
		      <span style="color: #2aa1ae; background-color: #ecf3ec;">;</span><span style="color: #2aa1ae; background-color: #ecf3ec;">("data" (instantiate-as-data (show pf) :new-name name))</span>
	  <span style="color: #2aa1ae; background-color: #ecf3ec;">;            </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(otherwise  "neat")))) ;;(message-box "Error: Variation %s not supported yet." variation))</span>
	<span style="color: #e0211d; text-decoration: overline;">)</span>



</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">reify-package-formers</span> <span style="color: #6c3163;">(</span>orig-fun <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> args<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sometimes we may want the full name due to files being in a nested</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">directory hierarchy:</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(file-name-sans-extension buffer-file-name)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> generated-file-name <span style="color: #2d9574;">(</span>concat<span style="color: #67b11d;">(</span>file-name-sans-extension <span style="color: #b1951d;">(</span>buffer-name<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
		  <span style="color: #2d9574;">"_Generated"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This&#8217; inefficent.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> package-formers nil<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> instantiations-remaining nil<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span>parse-700-comments<span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">with-temp-buffer</span>
    <span style="color: #2d9574;">(</span>beginning-of-buffer<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>insert <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">"\n"</span> `<span style="color: #b1951d;">(</span>
	     <span style="color: #2d9574;">"{- This file is generated ;; do not alter. -}"</span>
	       <span style="color: #2d9574;">"{-# OPTIONS --allow-unsolved-metas #-}"</span>
	     <span style="color: #2d9574;">"open import Relation.Binary.PropositionalEquality using (_&#8801;_)"</span>
	       <span style="color: #2d9574;">"open import Level as &#8467;"</span>
	     ,<span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"module %s where "</span> generated-file-name<span style="color: #3a81c3;">)</span>
	     ,<span style="color: #3a81c3;">(</span>reify-instances<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(mark-whole-buffer)</span>
    <span style="color: #2d9574;">(</span>write-region <span style="color: #67b11d;">(</span>beginning-of-buffer<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>end-of-buffer<span style="color: #67b11d;">)</span>
		  <span style="color: #67b11d;">(</span>concat generated-file-name <span style="color: #2d9574;">".agda"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MA: Using &#8216;(write-file "Generated.agda")&#8217; means we make a file</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then the temporary buffer /vistis/ the agda file, which loads the</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">agda process therein, which is undesirable since it could leave</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">agda working on the buffer even after it has been killed!</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This would necessiate calling (agda2-restart) afterwards.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Instead we write the whole region, without visiting the resuting file.</span>

  <span style="color: #6c3163;">(</span>insert-generated-import generated-file-name<span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">call agda2-load</span>
  <span style="color: #6c3163;">(</span>apply orig-fun args<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span>message <span style="color: #2d9574;">"700 &#8759; All the best coding! (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>advice-add 'agda2-load <span style="color: #3a81c3;">:around</span> #'reify-package-formers<span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4694022" class="outline-2">
<h2 id="org4694022"><span class="section-number-2">9</span> Testing&#xa0;&#xa0;&#xa0;<span class="tag"><span class="neato">neato</span></span></h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">progn</span>
  <span style="color: #6c3163;">(</span>switch-to-buffer <span style="color: #2d9574;">"Testing.agda"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> _res <span style="color: #2d9574;">"hi"</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> package-formers nil<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>parse-700-comments<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span>switch-to-buffer <span style="color: #2d9574;">"PackageFormer.org"</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">_res</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">700-comments</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">instantiations-remaining</span>

   package-formers
   <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(reify-instances)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(instantiate-as-data (car package-formers))</span>

<span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>pf-name <span style="color: #2d9574;">"M-syntax"</span><span style="color: #2d9574;">]</span>

  <span style="color: #2d9574;">(</span>instantiate <span style="color: #67b11d;">(</span>cadr package-formers<span style="color: #67b11d;">)</span>  <span style="color: #3a81c3;">:name-suffix</span> <span style="color: #2d9574;">"syntax"</span>
		     <span style="color: #3a81c3;">:type</span> <span style="color: #2d9574;">"data"</span>
		     <span style="color: #3a81c3;">:omit-field-header</span> t
		     <span style="color: #3a81c3;">:new-name</span> pf-name

		     <span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:keep-fields (lambda (f) (s-contains? "Vertex" (field-target f)))</span>
		    <span style="color: #2d9574;">)</span>


<span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span>instantiate-as-data <span style="color: #2d9574;">(</span>cadr package-formers<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<pre class="example">

{- This was generated from the PackageFormer Magma -}
data Magma-syntax  : Set (‚Ñì.suc ‚Ñì.zero)where
    _‚®æ_ : Magma-syntax ‚Üí Magma-syntax ‚Üí Magma-syntax
    -- Id  : Magma-syntax
</pre>




<p>
(instantiate decls  :new-name new-name
		   :name-suffix "syntax"
		   :type "data"
		   :omit-field-header t
		   :keep-fields (lambda (f) (s-contains? pf-name (field-target f)))
		  ))
</p>

<pre class="example">

{- This was generated from the PackageFormer Graph -}
record Graph-typeclass (Carrier : Set) : Set (‚Ñì.suc ‚Ñì.zero)where
  field
    Vertex : Set
    _‚ü∂_ : Vertex ‚Üí Vertex ‚Üí Set
</pre>
</div>
</div>
</div>
</body>
</html>
